import asyncio
import logging
from database import db

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class AutoPoster:
    """–ö–ª–∞—Å—Å –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ –∫–∞–Ω–∞–ª"""

    def __init__(self, bot, channel_id: str):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AutoPoster

        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞
            channel_id: ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
        """
        self.bot = bot
        self.channel_id = channel_id

    async def check_and_publish(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –ø—É–±–ª–∏–∫—É–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –ø–æ—Å—Ç—ã"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç—ã, –≥–æ—Ç–æ–≤—ã–µ –∫ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
            posts = await db.get_posts_to_publish()

            if not posts:
                logger.info("–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")
                return

            logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(posts)} –ø–æ—Å—Ç–æ–≤ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏")

            for post in posts:
                try:
                    # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –ø–æ—Å—Ç
                    formatted_post = self._format_post(post)

                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
                    await self.bot.send_message(
                        chat_id=self.channel_id,
                        text=formatted_post,
                        parse_mode='Markdown'
                    )

                    # –û—Ç–º–µ—á–∞–µ–º –∫–∞–∫ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π
                    await db.mark_as_published(post['id'])

                    logger.info(f"‚úÖ –ü–æ—Å—Ç #{post['id']} –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –≤ –∫–∞–Ω–∞–ª")

                    # –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏
                    await asyncio.sleep(2)

                except Exception as e:
                    logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞ #{post['id']}: {e}")
                    continue

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ check_and_publish: {e}")

    def _format_post(self, post) -> str:
        """
        –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –¥–ª—è Telegram

        Args:
            post: –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Å—Ç–∞

        Returns:
            str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞
        """
        title = post.get('title', '').strip()
        body = post.get('body', '').strip()
        cta = post.get('cta', '').strip()

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
        parts = []

        if title:
            parts.append(f"*{title}*")
            parts.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

        if body:
            parts.append(body)
            parts.append("")  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

        if cta:
            parts.append(f"*{cta}*")

        return "\n".join(parts).strip()


async def run_auto_poster(bot, channel_id: str):
    """
    –ó–∞–ø—É—Å–∫–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é –≤ —Ñ–æ–Ω–µ

    Args:
        bot: –≠–∫–∑–µ–º–ø–ª—è—Ä —Ç–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç–∞
        channel_id: ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
    """
    poster = AutoPoster(bot, channel_id)
    logger.info("üöÄ AutoPoster –∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 10 –º–∏–Ω—É—Ç.")

    while True:
        try:
            await poster.check_and_publish()

        except Exception as e:
            logger.error(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ run_auto_poster: {e}")

        # –ñ–¥—ë–º 10 –º–∏–Ω—É—Ç (600 —Å–µ–∫—É–Ω–¥)
        await asyncio.sleep(600)
