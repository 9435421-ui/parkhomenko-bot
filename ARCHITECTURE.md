# Архитектура Бота «ТЕРИОН»

## Структура файлов и их роли

- **`main.py`**: Точка входа. Инициализирует `aiogram.Bot`, `Dispatcher`, подключает базу данных и регистрирует все роутеры обработчиков.
- **`config.py`**: Загрузка и хранение конфигурации из `.env`.
- **`database/db.py`**: Асинхронный клиент для работы с SQLite (библиотека `aiosqlite`). Реализует методы `upsert_unified_lead`, `get_or_create_user` и др.
- **`handlers/`**: Директория с логикой обработки сообщений.
  - **`start.py`**: Обработка команды `/start`, онбординг, согласие на ОПД, сбор первичного контакта.
  - **`quiz.py`**: Реализация 10-шагового квиза квалификации лида.
  - **`dialog.py`**: Режим диалога с ИИ-консультантом (RAG на базе YandexGPT).
  - **`invest.py`**: Инвест-калькулятор для оценки объектов.
- **`keyboards/`**: Определение всех клавиатур (Inline и Reply).
- **`utils/`**: Вспомогательные модули.
  - **`yandex_gpt.py`**: Интеграция с Yandex GPT API.
  - **`voice_handler.py`**: Обработка и транскрибация голосовых сообщений.
  - **`knowledge_base.py`**: Логика поиска по базе знаний (RAG).
- **`docs/`**: База знаний в формате документов для обучения ИИ.

## Схема взаимодействия с БД

Бот использует единую базу данных `parkhomenko_bot.db`.
Основные таблицы:
- **`users`**: Хранит профили пользователей и их состояния.
- **`unified_leads`**: Центральная таблица для всех заявок (лидов), включая результаты квизов от обоих ботов (основного и контентного).

## Жизненный цикл лида
1. Пользователь запускает `/start`.
2. Подтверждает согласие на обработку данных.
3. Делится контактом (телефон сохраняется немедленно).
4. Проходит квиз (7 шагов).
5. Результаты квиза обновляют запись лида в БД и отправляются в Telegram-группу администраторов.
