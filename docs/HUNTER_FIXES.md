# Исправления LeadHunter

## Дата: 2026-02-17

## Проблемы, которые были исправлены

### 1. Database Connection Issues
**Проблема:** `AttributeError: 'NoneType' object has no attribute 'cursor'` при работе с БД.

**Решение:**
- Добавлен метод `_ensure_db_connected()` в класс `LeadHunter`, который проверяет подключение к БД перед каждым обращением.
- Все обращения к БД теперь используют этот метод для гарантированного подключения.
- Добавлена обработка ошибок `AttributeError` с автоматическим переподключением.

**Файлы:**
- `services/lead_hunter/hunter.py` - добавлен метод `_ensure_db_connected()` и проверки перед всеми обращениями к БД.

### 2. VK Discovery Missing
**Проблема:** В `discovery.py` отсутствовал метод `scout_vk_resources` для поиска новых групп ВКонтакте.

**Решение:**
- Реализован метод `scout_vk_resources()` в классе `Discovery`.
- Метод использует VK API (`groups.search`) для поиска открытых групп по ключевым словам.
- Интегрирован в основной цикл `hunt()` для автоматического поиска VK групп при отсутствии лидов.

**Файлы:**
- `services/lead_hunter/discovery.py` - добавлен метод `scout_vk_resources()`.
- `services/lead_hunter/hunter.py` - добавлен вызов `scout_vk_resources()` в цикл Discovery.

### 3. Error Handling Improvements
**Проблема:** Недостаточная обработка ошибок при работе с БД.

**Решение:**
- Добавлены try-except блоки вокруг всех операций с БД.
- Добавлена проверка `AttributeError` с автоматическим переподключением.
- Улучшено логирование ошибок.

**Файлы:**
- `services/lead_hunter/hunter.py` - добавлены обработчики ошибок.

### 4. Standalone Entry Point
**Проблема:** Не было способа запустить LeadHunter отдельно от основного бота для тестирования.

**Решение:**
- Создан файл `run_hunter.py` в корне проекта.
- Скрипт правильно инициализирует БД и запускает одну итерацию охоты.
- Корректно закрывает соединения после завершения.

**Файлы:**
- `run_hunter.py` - новый файл для запуска LeadHunter.

## Использование

### Запуск LeadHunter отдельно:
```bash
python3 run_hunter.py
```

### Требования к .env:
- `VK_TOKEN` или `VK_USER_TOKEN` - для поиска VK групп (опционально)
- `TELEGRAM_API_ID`, `TELEGRAM_API_HASH`, `TELEGRAM_PHONE` - для парсинга Telegram
- `SCOUT_KEYWORDS` - ключевые слова для поиска (опционально, используется расширенный список по умолчанию)

## Изменения в коде

### `services/lead_hunter/hunter.py`
1. Добавлен метод `_ensure_db_connected()` для проверки подключения к БД.
2. Все обращения к БД теперь используют этот метод.
3. Добавлен вызов `scout_vk_resources()` в цикл Discovery.
4. Улучшена обработка ошибок при работе с БД.

### `services/lead_hunter/discovery.py`
1. Добавлен метод `scout_vk_resources()` для поиска VK групп.
2. Добавлены импорты `asyncio` и `aiohttp` для работы с VK API.

### `run_hunter.py` (новый файл)
1. Скрипт для запуска LeadHunter отдельно.
2. Правильная инициализация и закрытие БД.
3. Обработка ошибок и логирование.

## Тестирование

После применения изменений рекомендуется:
1. Проверить подключение к БД: `python3 run_hunter.py`
2. Проверить логи на наличие ошибок подключения.
3. Убедиться, что VK группы находятся (если настроен `VK_TOKEN`).
