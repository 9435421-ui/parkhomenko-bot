"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Å RAG (–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ê–Ω—Ç–æ–Ω)
"""
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from aiogram.fsm.context import FSMContext
from database import db
from utils import yandex_gpt, kb
from keyboards import get_continue_or_menu_keyboard

router = Router()


@router.callback_query(F.data == "mode:dialog")
async def start_dialog(callback: CallbackQuery, state: FSMContext):
    """–ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞"""
    user_id = callback.from_user.id
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–∏–∞–ª–æ–≥–∞
    await db.update_user_state(user_id, mode="dialog")
    await state.set_state(None) # –û—á–∏—â–∞–µ–º FSM, —Ç–∞–∫ –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ–º —á–µ—Ä–µ–∑ user_state –≤ –ë–î
    
    user_data = await db.get_or_create_user(user_id)
    name = user_data.get('first_name', '–¥–æ—Ä–æ–≥–æ–π –∫–ª–∏–µ–Ω—Ç')
    
    await callback.message.edit_text(
        f"üí¨ <b>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ò–ò-—ç–∫—Å–ø–µ—Ä—Ç–æ–º</b>\n\n"
        f"{name}, —è ‚Äî –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫. "
        f"–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –æ–±—à–∏—Ä–Ω—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π "
        f"–ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –†–§ –∏ –º–Ω–æ–≥–æ–ª–µ—Ç–Ω–µ–º—É –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É –æ–ø—ã—Ç—É –Ω–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏.\n\n"
        f"<b>–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å.</b>",
        parse_mode="HTML"
    )
    await callback.answer()


@router.message(F.text)
async def dialog_message_handler(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"""
    user_id = message.from_user.id
    db_state = await db.get_user_state(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞
    if not db_state or db_state.get('mode') != 'dialog':
        return
    
    user_query = message.text.strip()
    name = db_state.get('name', '')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    await db.add_dialog_message(user_id, role="user", message=user_query)
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ RAG
    rag_context = await kb.get_context(user_query, max_chunks=3, context_size=800)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    dialog_history = await db.get_dialog_history(user_id, limit=10)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    history_for_prompt = []
    for msg in dialog_history:
        history_for_prompt.append({
            'role': msg['role'],
            'text': msg['message']
        })
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–∞ (—Å–≤—è–∑—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º)
    trigger_words = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '–º–µ–Ω–µ–¥–∂–µ—Ä', '—á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–π', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '–∑–∞–∫–∞–∑–∞—Ç—å', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è', '–∑–∞–ø–∏—Å–∞—Ç—å—Å—è'
    ]
    
    if any(word in user_query.lower() for word in trigger_words):
        from handlers.quiz import QuizOrder

        # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –≤ —Ä–µ–∂–∏–º –∫–≤–∏–∑–∞
        await db.update_user_state(user_id, mode="quiz")
        
        await message.answer(
            f"{name}, –æ—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º –∑–∞—è–≤–∫—É –¥–ª—è —Å–≤—è–∑–∏ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            f"–Ø –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –Ω–∞—à —ç–∫—Å–ø–µ—Ä—Ç —Å–º–æ–≥ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å "
            f"–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.",
            parse_mode="HTML"
        )
        
        await state.set_state(QuizOrder.role)

        await message.answer("üìã –ö—Ç–æ –≤—ã? (–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫/–î–∏–∑–∞–π–Ω–µ—Ä/–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫/–ò–Ω–≤–µ—Å—Ç–æ—Ä/–î—Ä—É–≥–æ–µ)")
        return
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ YandexGPT —Å RAG
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
        system_prompt = """
–¢—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –¢–ï–†–ò–û–ù, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:

1. –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –ó–ù–ê–ù–ò–ô:
   - –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞.
   - –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ - –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –Ω–∞—à–∏–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º.
   - –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã, –Ω–æ—Ä–º—ã –∏ –∑–∞–∫–æ–Ω—ã.

2. –°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:
   - –õ–∏–º–∏—Ç: 400 —Å–∏–º–≤–æ–ª–æ–≤.
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, –ª–∞–∫–æ–Ω–∏—á–Ω–æ, –≥—Ä–∞–º–æ—Ç–Ω–æ.
   - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —Å—Å—ã–ª–∞–π—Å—è –Ω–∞ —Å—Ç–∞—Ç—å–∏ –ñ–ö –†–§, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

3. –ó–ê–ü–†–ï–¢–´:
   √ó –ù–µ –Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å–ª—É–≥ –∏–ª–∏ —Ä–∞–±–æ—Ç.
   √ó –ù–µ –¥–∞–≤–∞–π –≥–∞—Ä–∞–Ω—Ç–∏–π 100% —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è.
   √ó –ù–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π—Å—è –ª–∏—á–Ω—ã–º –∏–º–µ–Ω–µ–º (—Ç—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏).

4. –ö–û–ì–î–ê –ù–ï–¢ –û–¢–í–ï–¢–ê:
   - "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –º–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –Ω—é–∞–Ω—Å—É. –†–µ–∫–æ–º–µ–Ω–¥—É—é –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –Ω–∞—à–∏–º –≤–µ–¥—É—â–∏–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞."

–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:
"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        user_prompt = f"{system_prompt}\n\n{rag_context}\n\n–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê:\n{user_query}"
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        response = await yandex_gpt.generate_response(
            user_prompt=user_prompt,
            temperature=0.2,
            max_tokens=300,
            model="yandexgpt"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        await db.add_dialog_message(user_id, role="assistant", message=response)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(response, parse_mode="HTML")
        
        # –ü–æ—Å–ª–µ 3-–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
        assistant_count = len([h for h in history_for_prompt if h['role'] == 'assistant'])
        
        if assistant_count >= 2:
            await message.answer(
                f"{name}, —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏?",
                reply_markup=get_continue_or_menu_keyboard()
            )
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
        await message.answer(
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞. "
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.",
            reply_markup=get_continue_or_menu_keyboard()
        )
