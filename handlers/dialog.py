"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Å RAG (–ò–ò-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç)
"""
from aiogram import Router, F
from aiogram.types import Message, CallbackQuery
from database import db
from utils import yandex_gpt, kb
from keyboards import get_continue_or_menu_keyboard

router = Router()


@router.callback_query(F.data == "mode:dialog")
async def start_dialog(callback: CallbackQuery):
    """–ó–∞–ø—É—Å–∫ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞"""
    user_id = callback.from_user.id
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –¥–∏–∞–ª–æ–≥–∞
    await db.update_user_state(user_id, mode="dialog")
    
    state = await db.get_user_state(user_id)
    name = state.get('name', '–¥–æ—Ä–æ–≥–æ–π –∫–ª–∏–µ–Ω—Ç')
    
    await callback.message.edit_text(
        f"üí¨ <b>–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è —Å –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–æ–º</b>\n\n"
        f"{name}, —è - –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞—à–µ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º. "
        f"–ì–æ—Ç–æ–≤ –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã, –æ–ø–∏—Ä–∞—è—Å—å –Ω–∞ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –∏–∑ 83 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ "
        f"–ø–æ –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É –†–§ –∏ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–º—É –æ–ø—ã—Ç—É.\n\n"
        f"<b>–û–ø–∏—à–∏—Ç–µ –≤–∞—à—É —Å–∏—Ç—É–∞—Ü–∏—é –∏–ª–∏ –∑–∞–¥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≤–æ–ø—Ä–æ—Å.</b>",
        parse_mode="HTML"
    )
    await callback.answer()


@router.message(F.text)
async def dialog_message_handler(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–æ–≤–æ–º —Ä–µ–∂–∏–º–µ"""
    user_id = message.from_user.id
    state = await db.get_user_state(user_id)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ä–µ–∂–∏–º–µ –¥–∏–∞–ª–æ–≥–∞
    if not state or state.get('mode') != 'dialog':
        return
    
    user_query = message.text.strip()
    name = state.get('name', '')
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
    await db.add_dialog_message(user_id, role="user", message=user_query)
    
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —á–µ—Ä–µ–∑ RAG
    rag_context = await kb.get_context(user_query, max_chunks=3, context_size=800)
    
    # –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
    dialog_history = await db.get_dialog_history(user_id, limit=10)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
    history_for_prompt = []
    for msg in dialog_history:
        history_for_prompt.append({
            'role': msg['role'],
            'text': msg['message']
        })
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ç—Ä–∏–≥–≥–µ—Ä-—Å–ª–æ–≤–∞ (—Å–≤—è–∑—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º)
    trigger_words = [
        '—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç', '–º–µ–Ω–µ–¥–∂–µ—Ä', '—á–µ–ª–æ–≤–µ–∫', '–∂–∏–≤–æ–π', '—Å–æ–µ–¥–∏–Ω–∏—Ç—å',
        '—Å–≤—è–∑–∞—Ç—å—Å—è', '–∑–∞–∫–∞–∑–∞—Ç—å', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è', '–∑–∞–ø–∏—Å–∞—Ç—å—Å—è'
    ]
    
    if any(word in user_query.lower() for word in trigger_words):
        await db.update_user_state(user_id, mode="quiz", quiz_step=1)
        
        await message.answer(
            f"{name}, –æ—Ç–ª–∏—á–Ω–æ! –î–∞–≤–∞–π—Ç–µ –æ—Ñ–æ—Ä–º–∏–º –∑–∞—è–≤–∫—É –¥–ª—è —Å–≤—è–∑–∏ —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.\n\n"
            f"–Ø –∑–∞–¥–∞–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å–æ–≤, —á—Ç–æ–±—ã –Ω–∞—à —ç–∫—Å–ø–µ—Ä—Ç —Å–º–æ–≥ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å "
            f"–ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.",
            parse_mode="HTML"
        )
        
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –≤—ã–∑—ã–≤–∞–µ–º –∫–≤–∏–∑
        from handlers.quiz import get_city_keyboard
        
        await message.answer(
            "üìù <b>–ó–∞—è–≤–∫–∞ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é</b>\n\n"
            "<b>–í–æ–ø—Ä–æ—Å 1 –∏–∑ 8:</b> –í –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –æ–±—ä–µ–∫—Ç?",
            reply_markup=get_city_keyboard(),
            parse_mode="HTML"
        )
        return
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ YandexGPT —Å RAG
    try:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç–∞
        system_prompt = """
–¢—ã ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–∞—à–µ–≥–æ —ç–∫—Å–ø–µ—Ä—Ç–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º.

–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–ê–í–ò–õ–ê:

1. –†–ê–ë–û–¢–ê –° –ë–ê–ó–û–ô –ó–ù–ê–ù–ò–ô (83 –¥–æ–∫—É–º–µ–Ω—Ç–∞):
   - –ò–°–ü–û–õ–¨–ó–£–ô –¢–û–õ–¨–ö–û –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∏–∂–µ
   - –ï—Å–ª–∏ –≤ –±–∞–∑–µ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ - —Å–∫–∞–∂–∏ —á–µ—Å—Ç–Ω–æ –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º
   - –ù–ï –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã –∏ –Ω–æ—Ä–º—ã

2. –°–¢–ò–õ–¨ –û–¢–í–ï–¢–û–í:
   - –õ–∏–º–∏—Ç: 350 —Å–∏–º–≤–æ–ª–æ–≤ (2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
   - –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ, —Å–æ —Å—Å—ã–ª–∫–∞–º–∏ –Ω–∞ –ñ–ö –†–§
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É

3. –°–°–´–õ–ö–ò –ù–ê –ó–ê–ö–û–ù–´:
   - –£–ø–æ–º–∏–Ω–∞–π —Å—Ç–∞—Ç—å–∏ –ñ–ö –†–§, –°–ü, –°–∞–Ω–ü–∏–ù –∫–æ–≥–¥–∞ –æ–Ω–∏ –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
   - –§–æ—Ä–º–∞—Ç: "–°–æ–≥–ª–∞—Å–Ω–æ —Å—Ç. 26 –ñ–ö –†–§..."

4. –ö–û–ì–î–ê –ù–ï–¢ –û–¢–í–ï–¢–ê:
   - "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ –≤–∞—à–µ–º—É –≤–æ–ø—Ä–æ—Å—É. 
     –†–µ–∫–æ–º–µ–Ω–¥—É—é –∑–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é –∫ –Ω–∞—à–µ–º—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–±–æ—Ä–∞."

5. –ù–ï –î–ï–õ–ê–ô:
   √ó –ù–µ –Ω–∞–∑—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—É–º–º—ã
   √ó –ù–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–π 100% —Ä–µ–∑—É–ª—å—Ç–∞—Ç
   √ó –ù–µ –¥–∞–≤–∞–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Å—Ç—Ä–æ–π–∫–µ

–ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô:
"""
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        user_prompt = f"{system_prompt}\n\n{rag_context}\n\n–í–û–ü–†–û–° –ö–õ–ò–ï–ù–¢–ê:\n{user_query}"
        
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        response = await yandex_gpt.generate_response(
            user_prompt=user_prompt,
            temperature=0.2,
            max_tokens=300,
            model="yandexgpt"
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
        await db.add_dialog_message(user_id, role="assistant", message=response)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await message.answer(response, parse_mode="HTML")
        
        # –ü–æ—Å–ª–µ 3-–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–ª–∏ –æ—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
        assistant_count = len([h for h in history_for_prompt if h['role'] == 'assistant'])
        
        if assistant_count >= 2:
            await message.answer(
                f"{name}, —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏?",
                reply_markup=get_continue_or_menu_keyboard()
            )
    
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
        await message.answer(
            "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞. "
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å–æ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º.",
            reply_markup=get_continue_or_menu_keyboard()
        )
