# Отчет по аудиту квиза ТОРИОН (Quiz Flow Report)

## 1. Структура и логика (handlers/quiz.py)

Квиз состоит из 9 последовательных шагов. На текущий момент реализована линейная логика без ветвления.

| Шаг | Запрос данных | Описание / Варианты |
| :--- | :--- | :--- |
| 1 | **Роль** | Кто вы? (Собственник/Дизайнер/Застройщик/Инвестор/Другое) |
| 2 | **Город** | Из какого вы города? |
| 3 | **Тип объекта** | Жилое/Нежилое |
| 4 | **Стадия** | Планируется/Уже выполнена |
| 5 | **Сложность** | Стены/Мокрые зоны/Нет |
| 6 | **Цель** | Инвест/Для жизни |
| 7 | **БТИ документы** | Да/Частично/Нет |
| 8 | **Срочность** | Срочно/Можно подождать |
| 9 | **Контакт** | Номер телефона |

### Разделение клиентов (Планирует / Уже сделал)
*   **Текущее состояние:** Квиз фиксирует ответ на 4-м шаге, но **не меняет** дальнейшую цепочку вопросов.
*   **Оценка:** Логика считается "слабой" для сегментации, так как клиенту, который "уже сделал", могут потребоваться другие уточняющие вопросы (например, о наличии предписаний от ГЖИ), а клиенту, который "планирует" — вопросы о дизайн-проекте.

### Финальный шаг
*   После ввода телефона бот отправляет:
    1.  Сводку админу в группу (`ADMIN_GROUP_ID`).
    2.  Полезный контент: «Чек-лист документов для перепланировки».
    3.  Подтверждение: «Наш эксперт свяжется с вами».
*   **Оценка:** Переход к консультации реализован через обещание обратного звонка. Это стандартная механика захвата лида.

## 2. Юридическая корректность (handlers/start.py)

*   **Согласие на обработку ПД:** Реализовано на этапе `/start`.
*   **Механика:** Пользователь видит дисклеймер и кнопку «✅ Я согласен и хочу продолжить».
*   **Блокировка:** Квиз запускается только после нажатия этой кнопки (через обработчик `handle_consent`). Без этого действия состояние квиза не устанавливается.
*   **Статус:** **OK**.

## 3. Контакты и лиды (database/db.py)

*   **Захват контакта:** На последнем шаге запрашивается телефон текстовым сообщением.
*   **Сохранение:** Лиды пишутся в таблицу `unified_leads` в базе `parkhomenko_bot.db`.
*   **Поля:** `user_id`, `source_bot`, `lead_type`, `name`, `username`, `phone`, `details` (JSON со всеми ответами).
*   **Источник:** Сохраняется `source_bot="qualification"` и `lead_type="quiz"`. Глубинная ссылка (`start=...`) сохраняется внутри поля `details` под ключом `_payload`.

**Пример структуры лида в БД:**
```sql
{
  "id": 1,
  "user_id": 12345678,
  "source_bot": "qualification",
  "lead_type": "quiz",
  "name": "Иван Иванов",
  "phone": "+79991234567",
  "details": "{\"role\": \"Собственник\", \"city\": \"Москва\", \"status\": \"Планируется\", \"_payload\": \"torion_main\", ...}"
}
```

---
**Вывод:** Квиз технически исправен и юридически корректен, но требует доработки логики ветвления для повышения конверсии в продажу услуги "под ключ" для разных типов клиентов.
