#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telethon —Å–µ—Å—Å–∏–∏ –¥–ª—è –º–æ–¥—É–ª—è Discovery.
–°–æ–∑–¥–∞–µ—Ç —Ñ–∞–π–ª —Å–µ—Å—Å–∏–∏ 'anton_discovery.session', –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤/–≥—Ä—É–ø–ø.

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
    python auth_session.py

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
    - API_ID –∏ API_HASH –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–¥–∞–Ω—ã –≤ .env
    - –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Telegram
"""
import os
import sys
import asyncio
from dotenv import load_dotenv
from telethon import TelegramClient
from telethon.errors import SessionPasswordNeededError

# API credentials –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Telethon —Å–µ—Å—Å–∏–∏
API_ID = 39163454
API_HASH = "182611453d5822018d0772847a3f58a6"

# –ò–º—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏ (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ Discovery)
SESSION_NAME = 'anton_discovery'


async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"""
    print("=" * 60)
    print("üîê –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø TELEGRAM –°–ï–°–°–ò–ò –î–õ–Ø DISCOVERY")
    print("=" * 60)
    print(f"\nüìÅ –§–∞–π–ª —Å–µ—Å—Å–∏–∏: {SESSION_NAME}.session")
    print(f"üîë API ID: {API_ID}")
    print(f"üîë API Hash: {API_HASH[:10]}...")
    print("\n" + "-" * 60)
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Telethon
    client = TelegramClient(SESSION_NAME, API_ID, API_HASH)
    
    try:
        print("\nüì± –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram...")
        await client.connect()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ —É–∂–µ
        if await client.is_user_authorized():
            print("‚úÖ –°–µ—Å—Å–∏—è —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∞!")
            me = await client.get_me()
            print(f"üë§ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: {me.first_name} {me.last_name or ''} (@{me.username or '–±–µ–∑ username'})")
            print(f"üÜî User ID: {me.id}")
            print("\n‚úÖ –ì–æ—Ç–æ–≤–æ! –ú–æ–¥—É–ª—å Discovery –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é.")
            await client.disconnect()
            return
        
        # –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        print("\nüìû –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:")
        print("   –ü—Ä–∏–º–µ—Ä: +79991234567")
        phone = input("–ù–æ–º–µ—Ä: ").strip()
        
        if not phone:
            print("‚ùå –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
            await client.disconnect()
            return
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        print(f"\nüì® –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ {phone}...")
        await client.send_code_request(phone)
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        print("\nüîê –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑ Telegram:")
        code = input("–ö–æ–¥: ").strip()
        
        if not code:
            print("‚ùå –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
            await client.disconnect()
            return
        
        try:
            # –ü—ã—Ç–∞–µ–º—Å—è –≤–æ–π—Ç–∏ —Å –∫–æ–¥–æ–º
            await client.sign_in(phone, code)
            
        except SessionPasswordNeededError:
            # –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
            print("\nüîí –í–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)")
            print("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:")
            password = input("–ü–∞—Ä–æ–ª—å: ").strip()
            
            if not password:
                print("‚ùå –ü–∞—Ä–æ–ª—å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º")
                await client.disconnect()
                return
            
            await client.sign_in(password=password)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        if await client.is_user_authorized():
            me = await client.get_me()
            print("\n" + "=" * 60)
            print("‚úÖ –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–°–ü–ï–®–ù–ê!")
            print("=" * 60)
            print(f"üë§ –ò–º—è: {me.first_name} {me.last_name or ''}")
            print(f"üì± Username: @{me.username or '–Ω–µ –∑–∞–¥–∞–Ω'}")
            print(f"üÜî User ID: {me.id}")
            print(f"üìÅ –°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤: {SESSION_NAME}.session")
            print("\n‚úÖ –¢–µ–ø–µ—Ä—å –º–æ–¥—É–ª—å Discovery –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç—É —Å–µ—Å—Å–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ —á–∞—Ç–æ–≤!")
            print("=" * 60)
        else:
            print("\n‚ùå –û—à–∏–±–∫–∞: –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        
    except Exception as e:
        print(f"\n‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        print("\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("  - –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
        print("  - –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è")
        print("  - –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å 2FA")
        print("  - –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º –∫ Telegram")
    
    finally:
        await client.disconnect()
        print("\nüîå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ")


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\n‚ö†Ô∏è –ü—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        sys.exit(0)
