# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ö–≤–∏–∑–∞ –¢–û–†–ò–û–ù: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –æ—Ç—á–µ—Ç

## 1. –°–æ—Å—Ç–∞–≤ –º–æ–¥—É–ª–µ–π –∏ —Ñ–∞–π–ª–æ–≤
–ö–≤–∏–∑ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –∫–∞–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∫–æ–Ω–µ—á–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç (FSM) –Ω–∞ –±–∞–∑–µ `aiogram 3.x`.

*   **–õ–æ–≥–∏–∫–∞ –∫–≤–∏–∑–∞:** `handlers/quiz.py` ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤.
*   **–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö:** `database/db.py` ‚Äî –º–µ—Ç–æ–¥ `add_unified_lead` –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ SQLite.
*   **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** `config.py` ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ ID –≥—Ä—É–ø–ø.
*   **–í–∞–ª–∏–¥–∞—Ü–∏—è:** –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –≤ `handlers/quiz.py`.

## 2. –õ–æ–≥–∏–∫–∞ –≤–µ—Ç–≤–ª–µ–Ω–∏—è –∏ —à–∞–≥–∏
–ö–≤–∏–∑ –∏–º–µ–µ—Ç –ª–∏–Ω–µ–π–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤–æ–ø—Ä–æ—Å–æ–≤, –Ω–æ **–¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω**, –∫–æ—Ç–æ—Ä—ã–π –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞ –∏ —Å—Ç–∞–¥–∏—é –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏.

### –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —à–∞–≥–æ–≤ (Flow):
1.  **–ù–∞—á–∞–ª–æ:** –í—ã–∑–æ–≤ —á–µ—Ä–µ–∑ `/start` (—Å payload) –∏–ª–∏ –∫–Ω–æ–ø–∫—É –º–µ–Ω—é (`mode:quiz`).
2.  **–†–æ–ª—å:** ¬´–ö—Ç–æ –≤—ã? (–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫/–î–∏–∑–∞–π–Ω–µ—Ä/–ó–∞—Å—Ç—Ä–æ–π—â–∏–∫/–ò–Ω–≤–µ—Å—Ç–æ—Ä/–î—Ä—É–≥–æ–µ)¬ª.
3.  **–ì–æ—Ä–æ–¥:** –¢–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞.
4.  **–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:** –ö–Ω–æ–ø–∫–∏ ¬´üè† –ñ–∏–ª–æ–µ¬ª / ¬´üè¢ –ù–µ–∂–∏–ª–æ–µ¬ª (**–ö–≤–∞—Ä—Ç–∏—Ä—ã vs –ö–æ–º–º–µ—Ä—Ü–∏—è**).
5.  **–°—Ç–∞–¥–∏—è:** –ö–Ω–æ–ø–∫–∏ ¬´üìã –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è¬ª / ¬´‚úÖ –£–∂–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞¬ª.
6.  **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ö–Ω–æ–ø–∫–∏ ¬´üß± –°—Ç–µ–Ω—ã¬ª / ¬´üöø –ú–æ–∫—Ä—ã–µ –∑–æ–Ω—ã¬ª / ¬´‚ùå –ù–µ—Ç¬ª.
7.  **–¶–µ–ª—å:** –ö–Ω–æ–ø–∫–∏ ¬´üí∞ –ò–Ω–≤–µ—Å—Ç¬ª / ¬´üè† –î–ª—è –∂–∏–∑–Ω–∏¬ª.
8.  **–î–æ–∫—É–º–µ–Ω—Ç—ã –ë–¢–ò:** –ö–Ω–æ–ø–∫–∏ ¬´‚úÖ –î–∞¬ª / ¬´üìÑ –ß–∞—Å—Ç–∏—á–Ω–æ¬ª / ¬´‚ùå –ù–µ—Ç¬ª.
9.  **–°—Ä–æ—á–Ω–æ—Å—Ç—å:** –ö–Ω–æ–ø–∫–∏ ¬´üî• –°—Ä–æ—á–Ω–æ¬ª / ¬´‚è≥ –ú–æ–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å¬ª.
10. **–ö–æ–Ω—Ç–∞–∫—Ç:** –ö–Ω–æ–ø–∫–∞ ¬´üì± –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º¬ª (request_contact) –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.

### –í–µ—Ç–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞:
*   **–°—Ü–µ–Ω–∞—Ä–∏–π ¬´–£–∂–µ —Å–¥–µ–ª–∞–Ω–æ¬ª (–ñ–∏–ª–æ–µ/–ù–µ–∂–∏–ª–æ–µ):** –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ª–µ–≥–∞–ª–∏–∑–∞—Ü–∏—é, —Ç–µ—Ö–∑–∞–∫–ª—é—á–µ–Ω–∏–µ –æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ —Ä–∏—Å–∫–∏ —à—Ç—Ä–∞—Ñ–æ–≤ –ì–ñ–ò.
*   **–°—Ü–µ–Ω–∞—Ä–∏–π ¬´–ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è¬ª (–ñ–∏–ª–æ–µ/–ù–µ–∂–∏–ª–æ–µ):** –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ (–ï–ì–†–ù -> –ë–¢–ò -> –ü—Ä–æ–µ–∫—Ç -> –°–æ–≥–ª–∞—Å–∏–µ) –∏ —ç–∫–æ–Ω–æ–º–∏—é –≤—Ä–µ–º–µ–Ω–∏.

## 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (unified_leads)
–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü—É `unified_leads` –≤ `parkhomenko_bot.db`.

| –ü–æ–ª–µ | –ò—Å—Ç–æ—á–Ω–∏–∫ –≤ –∫–æ–¥–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
| :--- | :--- | :--- |
| `user_id` | `message.from_user.id` | Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| `source_bot` | `"qualification"` | –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –±–æ—Ç–∞-—Å–±–æ—Ä—â–∏–∫–∞ |
| `lead_type` | `"quiz"` | –¢–∏–ø –ª–∏–¥–∞ |
| `name` | `message.from_user.full_name` | –ò–º—è –≤ Telegram |
| `username` | `message.from_user.username` | –ù–∏–∫–Ω–µ–π–º –≤ Telegram |
| `phone` | `data.get('phone')` | –ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π) |
| `details` | `json.dumps(data)` | **–ü–æ–ª–Ω—ã–π –ª–æ–≥ –æ—Ç–≤–µ—Ç–æ–≤:** —Ä–æ–ª—å, –≥–æ—Ä–æ–¥, —Ç–∏–ø, —Å—Ç–∞—Ç—É—Å, —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ü–µ–ª—å, –ë–¢–ò, —Å—Ä–æ—á–Ω–æ—Å—Ç—å, payload. |

**–í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:**
*   –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ: `^(\+7|8|7)\d{10}$` (–ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Å–∫–æ–±–æ–∫).
*   –°–∏—Å—Ç–µ–º–Ω–∞—è –∫–Ω–æ–ø–∫–∞: `request_contact=True` –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è TG.

## 4. –ú–µ—Ö–∞–Ω–∏–∑–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫–≤–∏–∑–∞ –±–æ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á–µ—Ç –≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—É—é –≥—Ä—É–ø–ø—É.

*   **–ú–µ—Ç–æ–¥:** `message.bot.send_message`.
*   **–§–æ—Ä–º–∞—Ç:** HTML-—Ä–∞–∑–º–µ—Ç–∫–∞ —Å —ç–º–æ–¥–∑–∏.
*   **–°–æ—Å—Ç–∞–≤ —Å–æ–æ–±—â–µ–Ω–∏—è:**
    *   –ó–∞–≥–æ–ª–æ–≤–æ–∫: "üìã –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞ (–ö–≤–∏–∑)"
    *   –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (@username, ID, –¢–µ–ª–µ—Ñ–æ–Ω)
    *   –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏ (–ì–æ—Ä–æ–¥, –¢–∏–ø, –°—Ç–∞–¥–∏—è, –°–ª–æ–∂–Ω–æ—Å—Ç—å, –¶–µ–ª—å, –ë–¢–ò)
    *   **Payload (–ò—Å—Ç–æ—á–Ω–∏–∫):** –§–∏–∫—Å–∞—Ü–∏—è –¥–∏–ø–ª–∏–Ω–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `start=torion_main`).
*   **Fallback:** –ï—Å–ª–∏ `ADMIN_GROUP_ID` –Ω–µ –∑–∞–¥–∞–Ω –≤ `.env`, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É—Ö–æ–¥–∏—Ç –≤ `LEADS_GROUP_CHAT_ID`.

## 5. UX-—ç–ª–µ–º–µ–Ω—Ç—ã
*   **–ö–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞:** `ReplyKeyboardMarkup` (–æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–¥ –ø–æ–ª–µ–º –≤–≤–æ–¥–∞) –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –±–µ–∑ –æ–ø–µ—á–∞—Ç–æ–∫.
*   **Inline-–∫–Ω–æ–ø–∫–∏:** `InlineKeyboardMarkup` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–º —ç–∫—Ä–∞–Ω–µ.
*   **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä:** –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω–∞—è —à–∫–∞–ª–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω–æ –∫ –≤–Ω–µ–¥—Ä–µ–Ω–∏—é).
*   **–§–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω:** –°–æ–¥–µ—Ä–∂–∏—Ç –∫–Ω–æ–ø–∫—É ¬´üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —ç–∫—Å–ø–µ—Ä—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é¬ª —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞ `@torion_expert`.

## 6. –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å—Ö–µ–º–∞ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ (Flow-report)

### –°—Ö–µ–º–∞:
```text
[START] --> (–°–æ–≥–ª–∞—Å–∏–µ –ü–î)
   |
[–ö–í–ò–ó: –†–æ–ª—å, –ì–æ—Ä–æ–¥]
   |
[–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞: –ñ–∏–ª–æ–µ / –ù–µ–∂–∏–ª–æ–µ]
   |
[–°—Ç–∞–¥–∏—è: –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è / –°–¥–µ–ª–∞–Ω–æ] <--- (–ö–ª—é—á–µ–≤–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞)
   |
[–°–ª–æ–∂–Ω–æ—Å—Ç—å, –¶–µ–ª—å, –ë–¢–ò, –°—Ä–æ—á–Ω–æ—Å—Ç—å]
   |
[–¢–µ–ª–µ—Ñ–æ–Ω / –ö–æ–Ω—Ç–∞–∫—Ç]
   |
[SAVE TO DB] --> [NOTIFICATION TO ADMIN]
   |
[FINAL SCREEN]
   - –ï—Å–ª–∏ –°–¥–µ–ª–∞–Ω–æ: "–ö–∞–∫ —É–∑–∞–∫–æ–Ω–∏—Ç—å?"
   - –ï—Å–ª–∏ –ü–ª–∞–Ω–∏—Ä—É—é: "–ö–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å?"
   - [–ö–Ω–æ–ø–∫–∞: –ó–∞–ø–∏—Å—å –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é]
```

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –∑–æ–Ω—ã —Ä–æ—Å—Ç–∞:
1.  **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –¥–∏—Å—Å–æ–Ω–∞–Ω—Å:** –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ –≤ `handlers/quiz.py` (–∞–∫—Ç–∏–≤–Ω—ã–π –∫–≤–∏–∑) –∏ `services/lead_service.py` (—Å–µ—Ä–≤–∏—Å –ª–∏–¥–æ–≤). –ù–∞–ø—Ä–∏–º–µ—Ä, —Å–µ—Ä–≤–∏—Å –æ–∂–∏–¥–∞–µ—Ç `floor` –∏ `change_plan`, –∫–æ—Ç–æ—Ä—ã–µ –∫–≤–∏–∑ –Ω–µ —Å–æ–±–∏—Ä–∞–µ—Ç. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
2.  **–ú–µ—Ç—Ä–∞–∂ –∏ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –í —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø—Ä—è–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –º–µ—Ç—Ä–∞–∂–µ –ø–æ–º–µ—â–µ–Ω–∏—è –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ –∫–æ–º–º–µ—Ä—Ü–∏–∏ (–≤–∞–∂–Ω–æ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —Å—Ç–æ–∏–º–æ—Å—Ç–∏). –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å —à–∞–≥ –ø–æ—Å–ª–µ "–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞".
3.  **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä:** –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç "–®–∞–≥ 3 –∏–∑ 10" –≤ –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —É–¥–µ—Ä–∂–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
3.  **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–µ—Ç–≤–ª–µ–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤:** –î–ª—è "–ù–µ–∂–∏–ª–æ–≥–æ" (–∫–æ–º–º–µ—Ä—Ü–∏–∏) —Å—Ç–æ–∏—Ç –¥–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å—ã –æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–∏ (–æ–±—â–µ–ø–∏—Ç, –æ—Ñ–∏—Å, –º–µ–¥–∏—Ü–∏–Ω–∞), —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º —Ä–∞–∑–Ω—ã–µ –Ω–æ—Ä–º—ã –°–∞–Ω–ü–∏–ù.
4.  **–í–∞–ª–∏–¥–∞—Ü–∏—è payload:** –°–µ–π—á–∞—Å –∏—Å—Ç–æ—á–Ω–∏–∫ –ø–∏—à–µ—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ –ø–æ–Ω—è—Ç–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–†–µ–∫–ª–∞–º–∞ FB", "–ü–æ—Å—Ç –≤ –∫–∞–Ω–∞–ª–µ").
