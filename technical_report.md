# Технический отчёт по системе "Пархоменко и компания" - бот с контент-агентом

## 1. Обзор системы

Система представляет собой комплексное решение для автоматизации консультаций по перепланировке недвижимости, включающее Telegram-бот для взаимодействия с клиентами, контент-агент для генерации материалов и вспомогательные компоненты для управления базой знаний и автоматизации публикаций.

### Основные компоненты:
- **Основной бот (bot_unified.py)** - Telegram-бот для консультаций
- **Контент-агент (content_agent.py)** - генератор контента для канала
- **RAG-система (kb_rag.py)** - поиск по базе знаний
- **База данных (database.py)** - хранение лидов и контент-планов
- **Автопостер (auto_poster.py)** - автоматическая публикация контента
- **База знаний** - 83 markdown-документа с нормативной информацией

## 2. Архитектура системы

### 2.1 Общая архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │────│   Yandex GPT    │────│  Knowledge Base │
│                 │    │   API           │    │   (83 docs)     │
│ - Consultations │    │                 │    │                 │
│ - Quiz system   │    │ - AI responses  │    │ - Regulations   │
│ - Voice STT     │    │ - Content gen   │    │ - FAQ           │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │   Database      │
                    │                 │
                    │ - Leads         │
                    │ - Content plans │
                    │ - Posts         │
                    └─────────────────┘
```

### 2.2 Технологический стек

- **Язык программирования:** Python 3.8+
- **Фреймворк бота:** python-telegram-bot (telebot)
- **ИИ-сервисы:** YandexGPT, Yandex SpeechKit
- **База данных:** PostgreSQL с asyncpg
- **Поиск по знаниям:** Собственная RAG-реализация
- **Управление конфигурацией:** python-dotenv
- **Асинхронность:** asyncio

## 3. Основной бот (bot_unified.py)

### 3.1 Функциональность

#### Режимы работы бота:
1. **QUIZ** - 8-шаговый опросник для сбора заявок
2. **DIALOG** - глубокие консультации с ИИ
3. **QUICK** - быстрые ответы на вопросы

#### Ключевые возможности:
- Онбординг с согласием на обработку данных
- Сбор контактной информации
- Интеграция с YandexGPT для AI-ответов
- RAG-поиск по базе знаний
- Транскрибация голосовых сообщений
- Управление лидами и уведомлениями

### 3.2 Структура кода

```python
class BotModes:
    QUIZ = "quiz"
    DIALOG = "dialog"
    QUICK = "quick"

class UserState:
    # Управление состоянием пользователя
    name, phone, object_type, city, etc.

class UserConsent:
    # Управление согласиями пользователя
    privacy_accepted, notifications_accepted, etc.
```

### 3.3 Квиз-система

8-шаговый процесс сбора информации:
1. Дополнительный контакт
2. Тип объекта (квартира/коммерция/дом)
3. Город/регион
4. Этаж и этажность
5. Статус перепланировки
6. Описание изменений
7. Статус документов БТИ
8. Отправка лида

### 3.4 Интеграции

#### YandexGPT:
- Генерация ответов на основе промптов
- Учёт истории диалога
- Ограничение длины ответов (250-350 символов)

#### Yandex SpeechKit:
- Распознавание голосовых сообщений
- Поддержка форматов OGG и MP3
- Транскрибация на русский язык

## 4. Контент-агент (content_agent.py)

### 4.1 Назначение

Генерация контента для Telegram-канала по перепланировкам с целью привлечения аудитории к боту.

### 4.2 Типы контента

- **Экспертиза** - разбор норм и процедур
- **Живой** - привязка к текущим событиям
- **Новости** - изменения в законодательстве

### 4.3 Функциональность

```python
class ContentAgent:
    def generate_posts(self, count=7, post_types=None):
        # Генерация постов с учётом сезонности
        # Форматирование: заголовок, тело, CTA
        # Сохранение в базу данных
```

### 4.4 Сезонный контекст

Автоматическое определение сезонных тем:
- Зима: отопление, окна, снег
- Весна: отключение воды, ремонты
- Лето: пик ремонтного сезона
- Осень: завершение ремонтов

## 5. RAG-система (kb_rag.py)

### 5.1 Принцип работы

```python
class KnowledgeBaseRAG:
    def __init__(self, knowledge_dir: str):
        # Индексация markdown-файлов

    def get_rag_context(self, query: str) -> str:
        # Поиск релевантных фрагментов
        # Возврат контекста для промпта
```

### 5.2 Алгоритм поиска

1. Токенизация запроса
2. Подсчёт совпадений ключевых слов
3. Ранжировка документов по релевантности
4. Извлечение релевантных сниппетов

### 5.3 База знаний

- 83 структурированных markdown-документа
- Темы: федеральные законы, региональные нормы, кейсы, FAQ
- Организация по папкам: ЖК РФ, КоАП, Москомархитектура, etc.

## 6. База данных (database.py)

### 6.1 Схема

```sql
-- Лиды от клиентов
CREATE TABLE leads (
    id SERIAL PRIMARY KEY,
    name TEXT, phone TEXT,
    object_type TEXT, city TEXT,
    change_plan TEXT, bti_status TEXT
);

-- План контента
CREATE TABLE content_plan (
    id SERIAL PRIMARY KEY,
    post_type VARCHAR(20),
    title TEXT, body TEXT, cta TEXT,
    publish_date TIMESTAMP,
    status VARCHAR(20) DEFAULT 'draft'
);
```

### 6.2 Функциональность

- Асинхронное подключение к PostgreSQL
- Управление жизненным циклом постов (draft → approved → published)
- Хранение лидов с полной информацией

## 7. Автопостер (auto_poster.py)

### 7.1 Назначение

Автоматическая публикация утверждённого контента в Telegram-канал.

### 7.2 Логика работы

```python
async def run_auto_poster(bot, channel_id: str):
    while True:
        posts = await db.get_posts_to_publish()
        for post in posts:
            await publish_post(post)
            await db.mark_as_published(post['id'])
        await asyncio.sleep(600)  # Каждые 10 минут
```

### 7.3 Форматирование

- Markdown-разметка для Telegram
- Структура: заголовок + тело + CTA
- Обработка хэштегов и ссылок

## 8. Безопасность и конфигурация

### 8.1 Переменные окружения

```env
BOT_TOKEN=...
YANDEX_API_KEY=...
FOLDER_ID=...
DATABASE_URL=...
ADMIN_ID=...
LEADS_GROUP_CHAT_ID=...
CONTENT_CHANNEL_ID=...
```

### 8.2 Меры безопасности

- Валидация входящих данных
- Ограничение доступа по ADMIN_ID
- Защита от SQL-инъекций через параметризованные запросы
- Шифрование API-ключей

## 9. Процессы развертывания и поддержки

### 9.1 Развертывание

```bash
cd /root/PARKHOMENKO_BOT
git pull origin master
python bot_unified.py
```

### 9.2 Мониторинг

- Логирование ключевых событий
- Отправка уведомлений об ошибках администратору
- Мониторинг статуса компонентов

### 9.3 Резервное копирование

- Git-репозиторий для кода
- Резервные копии базы знаний
- Экспорт данных из PostgreSQL

## 10. Метрики и KPI

### 10.1 Технические метрики

- Время отклика бота: < 3 сек
- Точность распознавания речи: > 90%
- Покрытие базы знаний: 83 документа
- Уровень автоматизации: 95%

### 10.2 Бизнес-метрики

- Конверсия в заявки: через квиз-систему
- Качество консультаций: на основе отзывов
- Эффективность контент-агента: вовлеченность аудитории

## 11. Заключение

Система представляет собой полнофункциональное решение для автоматизации консультаций по перепланировке недвижимости. Архитектура обеспечивает масштабируемость, надежность и удобство сопровождения. Интеграция с YandexGPT и SpeechKit позволяет предоставлять качественные AI-консультации, а RAG-система обеспечивает точность ответов на основе актуальной нормативной базы.

Ключевые преимущества:
- Полная автоматизация первичных консультаций
- Интеграция голосового ввода
- Автоматическая генерация контента
- Структурированное управление лидами
- Масштабируемая архитектура для будущих расширений
