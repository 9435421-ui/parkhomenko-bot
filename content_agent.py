import requests
import os
from datetime import datetime, timedelta
import json

class ContentAgent:
    def __init__(self):
        self.folder_id = os.getenv("FOLDER_ID")
        self.api_key = os.getenv("YANDEX_API_KEY")
        self.endpoint = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        self.brief_content = self._load_brief()

    def _load_brief(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π"""
        try:
            with open("BRIEF_pereplanirovki.md", "r", encoding="utf-8") as f:
                return f.read()
        except FileNotFoundError:
            return "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º."

    def generate_posts(self, count=7, post_types=None, theme=None):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç N –ø–æ—Å—Ç–æ–≤
        post_types: {'—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞': 5, '–∂–∏–≤–æ–π': 1, '–Ω–æ–≤–æ—Å—Ç—å': 1}
        theme: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –Ω–µ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ω–æ–≤—ã–π –≥–æ–¥ –∏ –∑–∏–º–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏")
        """
        if post_types is None:
            post_types = {'—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞': count - 1, '–∂–∏–≤–æ–π': 1}

        posts = []
        start_date = datetime.now() + timedelta(days=1)
        start_date = start_date.replace(hour=10, minute=0, second=0)

        for post_type, num in post_types.items():
            for i in range(num):
                prompt = self._build_prompt(post_type, theme)
                text = self._call_yandex_gpt(prompt)

                # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), —Ç–µ–∫—Å—Ç, CTA
                title, body, cta = self._parse_response(text)

                post = {
                    'type': post_type,
                    'title': title,
                    'body': body,
                    'cta': cta,
                    'publish_date': start_date + timedelta(days=len(posts))
                }
                posts.append(post)

        return posts

    def _build_prompt(self, post_type, theme=None):
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞"""
        season = self._get_season_context()
        theme_note = f"\n–£—á–∏—Ç—ã–≤–∞–π —Ç–µ–º—É –Ω–µ–¥–µ–ª–∏: {theme}" if theme else ""

        prompts = {
            '—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞': f"""
–°–æ–∑–¥–∞–π —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ú–æ—Å–∫–≤–µ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ–∑–æ–Ω–∞: {season}{theme_note}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –†–∞–∑–±–æ—Ä –æ–¥–Ω–æ–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –Ω–æ—Ä–º—ã, –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –∏–ª–∏ —Ç–∏–ø–∏—á–Ω–æ–π –æ—à–∏–±–∫–∏
- 150‚Äì300 —Å–ª–æ–≤, —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ, –±–µ–∑ –≤–æ–¥—ã
- –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–ª–∏ –∫–µ–π—Å –∏–∑ –ø—Ä–∞–∫—Ç–∏–∫–∏
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π CTA –∫ –±–æ—Ç—É @Parkhovenko_i_kompaniya_bot

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
[–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å] (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

[–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞]

üëâ [CTA —Å –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é]
""",
            '–∂–∏–≤–æ–π': f"""
 –°–æ–∑–¥–∞–π ¬´–∂–∏–≤–æ–π¬ª –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º.

–ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–µ–∑–æ–Ω–∞: {season}{theme_note}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Ç–µ–∫—É—â–∏–º —Å–æ–±—ã—Ç–∏—è–º (–ø–æ–≥–æ–¥–∞, –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –ñ–ö–•, —Å–µ–∑–æ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∂–∏–ª—å—Ü–æ–≤)
- 150‚Äì250 —Å–ª–æ–≤, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, —Å –ª–∏—á–Ω–æ–π –Ω–æ—Ç–∫–æ–π
- –ú—è–≥–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–º–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ –∏ —Ä–∏—Å–∫–æ–≤
- CTA –∫ –±–æ—Ç—É @Parkhovenko_i_kompaniya_bot

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
[–°–µ–∑–æ–Ω–Ω—ã–π –∑–∞—Ü–µ–ø –∏–ª–∏ –Ω–∞–±–ª—é–¥–µ–Ω–∏–µ]

[–°–≤—è–∑–∫–∞ —Å —Ç–µ–º–æ–π –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫]

üëâ [CTA]
""",
            '–Ω–æ–≤–æ—Å—Ç—å': f"""
 –°–æ–∑–¥–∞–π –Ω–æ–≤–æ—Å—Ç–Ω–æ–π –ø–æ—Å—Ç –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –û–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –Ω–æ—Ä–º, –Ω–æ–≤–æ–º —Ä–∞–∑—ä—è—Å–Ω–µ–Ω–∏–∏ –∏–ª–∏ –≤–∞–∂–Ω–æ–º –∫–µ–π—Å–µ
- 120‚Äì200 —Å–ª–æ–≤, –∫—Ä–∞—Ç–∫–æ –∏ —á—ë—Ç–∫–æ
- –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –∏ —á–µ–º —ç—Ç–æ —á—Ä–µ–≤–∞—Ç–æ –¥–ª—è –∂–∏–ª—å—Ü–æ–≤
- CTA –∫ –±–æ—Ç—É @Parkhovenko_i_kompaniya_bot –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏{theme_note}

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
[–ù–æ–≤–æ—Å—Ç—å –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏]

[–ß—Ç–æ —ç—Ç–æ –∑–Ω–∞—á–∏—Ç –¥–ª—è –∂–∏–ª—å—Ü–æ–≤]

üëâ [CTA]
""",
            '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ': f"""
–°–æ–∑–¥–∞–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞.

–¢–µ–º–∞: {theme_note or '–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è'}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –¢–µ–ø–ª–æ–µ, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
- –°–≤—è–∑–∫–∞ —Å —Ç–µ–º–æ–π –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ (–ø–æ–∂–µ–ª–∞—Ç—å —É—Å–ø–µ—Ö–æ–≤ –≤ –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–∞—Ö)
- 80‚Äì150 —Å–ª–æ–≤, –∏—Å–∫—Ä–µ–Ω–Ω–µ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏
- –õ–µ–≥–∫–∏–π CTA –∫ –±–æ—Ç—É @Parkhovenko_i_kompaniya_bot –¥–ª—è –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üéÇ [–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è]

[–¢–µ–∫—Å—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è]

üëâ [CTA –¥–ª—è –±—É–¥—É—â–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤]
"""
        }

        return prompts.get(post_type, prompts['—ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞'])

    def _get_season_context(self):
        """–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–µ–∑–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç"""
        month = datetime.now().month

        contexts = {
            (12, 1, 2): "–ó–∏–º–∞: —Å–Ω–µ–≥ –∑–∞–≤–∞–ª–∏–ª –ú–æ—Å–∫–≤—É, –ø—Ä–æ–º–µ—Ä–∑–∞—é—â–∏–µ –æ–∫–Ω–∞, –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–ø–ª–µ–Ω–∏—è, —Å–æ—Å—É–ª—å–∫–∏ –Ω–∞ –∫–æ–∑—ã—Ä—å–∫–∞—Ö, —É—Ç–µ–ø–ª–µ–Ω–∏–µ",
            (3, 4, 5): "–í–µ—Å–Ω–∞: –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≥–æ—Ä—è—á–µ–π –≤–æ–¥—ã, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–µ–º–æ–Ω—Ç–Ω–æ–º—É —Å–µ–∑–æ–Ω—É, –ø–æ—Ä–∞ –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ",
            (6, 7, 8): "–õ–µ—Ç–æ: –ø–∏–∫ —Ä–µ–º–æ–Ω—Ç–Ω–æ–≥–æ —Å–µ–∑–æ–Ω–∞, –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
            (9, 10, 11): "–û—Å–µ–Ω—å: –≤–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–ø–ª–µ–Ω–∏—è, –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–º–æ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∑–∏–º–æ–π"
        }

        for months, context in contexts.items():
            if month in months:
                return context
        return contexts[(12, 1, 2)]

    def _call_yandex_gpt(self, user_prompt):
        """–í—ã–∑–æ–≤ YandexGPT API"""
        system_prompt = f"""
–¢—ã ‚Äî –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–Ω–µ–¥–∂–µ—Ä Telegram-–∫–∞–Ω–∞–ª–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º –∫–≤–∞—Ä—Ç–∏—Ä –≤ –ú–æ—Å–∫–≤–µ.

–ó–∞–¥–∞—á–∞: –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ–≥—Ä–µ–≤–∞—é—Ç –∫ –∑–∞—è–≤–∫–µ –≤ –±–æ—Ç–∞ @Parkhovenko_i_kompaniya_bot.

–°—Ç–∏–ª—å: —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ, –ø–æ-–¥–µ–ª–æ–≤–æ–º—É, –±–µ–∑ –≤–æ–¥—ã, —Å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏ —á—ë—Ç–∫–∏–º–∏ CTA.

–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π:
{self.brief_content[:3000]}  # –æ–±—Ä–µ–∑–∞–µ–º –¥–æ 3000 —Å–∏–º–≤–æ–ª–æ–≤, —á—Ç–æ–±—ã —É–º–µ—Å—Ç–∏—Ç—å—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç

–ö–∞–∂–¥—ã–π –ø–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –≤–µ—Å—Ç–∏ —á–∏—Ç–∞—Ç–µ–ª—è –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É: –ø–æ–¥–ø–∏—Å–∫–∞, –±–æ—Ç, –∑–∞—è–≤–∫–∞.
"""

        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Api-Key {self.api_key}",
            "x-folder-id": self.folder_id
        }

        payload = {
            "modelUri": f"gpt://{self.folder_id}/yandexgpt/latest",
            "completionOptions": {
                "stream": False,
                "temperature": 0.7,
                "maxTokens": 2000
            },
            "messages": [
                {"role": "system", "text": system_prompt},
                {"role": "user", "text": user_prompt}
            ]
        }

        response = requests.post(self.endpoint, headers=headers, json=payload, timeout=30)
        response.raise_for_status()

        result = response.json()
        return result['result']['alternatives'][0]['message']['text']

    def _parse_response(self, text):
        """–ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç LLM –Ω–∞ title, body, cta"""
        lines = text.strip().split('\n')

        # –ò—â–µ–º CTA (—Å—Ç—Ä–æ–∫–∏ —Å üëâ –∏–ª–∏ "CTA:")
        cta_line = None
        for i, line in enumerate(lines):
            if 'üëâ' in line or 'CTA:' in line.upper():
                cta_line = i
                break

        if cta_line:
            cta = '\n'.join(lines[cta_line:]).strip()
            body_lines = lines[:cta_line]
        else:
            cta = ""
            body_lines = lines

        # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –∫–æ—Ä–æ—Ç–∫–∞—è
        title = ""
        if body_lines and len(body_lines[0]) < 100:
            title = body_lines[0].strip('#').strip()
            body_lines = body_lines[1:]

        body = '\n'.join(body_lines).strip()

        return title, body, cta
