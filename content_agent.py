import requests
import os
from datetime import datetime, timedelta
import json
from image_agent import ImageAgent

class ContentAgent:
    def __init__(self, api_key: str, model_uri: str):
        self.folder_id = os.getenv("FOLDER_ID")
        self.api_key = api_key
        self.model_uri = model_uri
        self.image_agent = ImageAgent()
        self.endpoint = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
        self.brief_content = self._load_brief()

        # –ï–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–∏–ø–æ–≤ –ø–æ—Å—Ç–æ–≤
        self.post_types = ['news', 'fact', 'case', 'offer']

        # –®–∞–±–ª–æ–Ω—ã –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è (–±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å–ª—É–≥/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫)
        self.birthday_templates = [
            "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –≤–∞—Å —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω —Ä–∞–¥–æ—Å—Ç—å—é, —Ç–µ–ø–ª–æ–º –±–ª–∏–∑–∫–∏—Ö –∏ –ø—Ä–∏—è—Ç–Ω—ã–º–∏ —Å—é—Ä–ø—Ä–∏–∑–∞–º–∏. –ñ–µ–ª–∞–µ–º –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, –¥—É—à–µ–≤–Ω–æ–≥–æ —Ä–∞–≤–Ω–æ–≤–µ—Å–∏—è –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∞–º—ã—Ö –∑–∞–≤–µ—Ç–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π.",
            "–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –æ—Å–æ–±–µ–Ω–Ω—ã–π –¥–µ–Ω—å –ø—Ä–∏–Ω–µ—Å–µ—Ç –≤–∞–º –º–æ—Ä–µ —É–ª—ã–±–æ–∫, —Ç–µ–ø–ª–∞ –æ—Ç —Ä–æ–¥–Ω—ã—Ö –∏ –¥—Ä—É–∑–µ–π, –∞ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—á—Ç–∞–Ω–∏–π. –ñ–µ–ª–∞–µ–º –∑–¥–æ—Ä–æ–≤—å—è, —Å—á–∞—Å—Ç—å—è –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å.",
            "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç —è—Ä–∫–∏–º –∏ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–º, –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –ª—é–±–æ–≤—å—é –±–ª–∏–∑–∫–∏—Ö –∏ –ø—Ä–∏—è—Ç–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏. –ñ–µ–ª–∞–µ–º –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, —Å–µ–º–µ–π–Ω–æ–≥–æ —Ç–µ–ø–ª–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö —Ü–µ–ª–µ–π.",
            "–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫ –ø—Ä–∏–Ω–µ—Å–µ—Ç –≤–∞–º –∑–∞—Ä—è–¥ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–º–æ—Ü–∏–π, —Ç–µ–ø–ª—ã–µ –æ–±—ä—è—Ç–∏—è —Ä–æ–¥–Ω—ã—Ö –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –∂–µ–ª–∞–Ω–∏–π. –ñ–µ–ª–∞–µ–º –∑–¥–æ—Ä–æ–≤—å—è, —Å—á–∞—Å—Ç—å—è –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏.",
            "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –æ—Å–æ–±–µ–Ω–Ω—ã–º, –Ω–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º —Ä–∞–¥–æ—Å—Ç—å—é, —Ç–µ–ø–ª–æ–º –∏ –∑–∞–±–æ—Ç–æ–π –±–ª–∏–∑–∫–∏—Ö. –ñ–µ–ª–∞–µ–º –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è, –¥—É—à–µ–≤–Ω–æ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞ –∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –≤—Å–µ—Ö –º–µ—á—Ç–∞–Ω–∏–π.",
            "–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –ø—Ä–∞–∑–¥–Ω–∏–∫ —Å—Ç–∞–Ω–µ—Ç –Ω–∞—á–∞–ª–æ–º –Ω–æ–≤—ã—Ö —Ä–∞–¥–æ—Å—Ç–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏. –ñ–µ–ª–∞–µ–º –∑–¥–æ—Ä–æ–≤—å—è, —Å—á–∞—Å—Ç—å—è, —Å–µ–º–µ–π–Ω–æ–≥–æ —Ç–µ–ø–ª–∞ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∞–º—ã—Ö —Å–æ–∫—Ä–æ–≤–µ–Ω–Ω—ã—Ö –∂–µ–ª–∞–Ω–∏–π.",
            "–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç —è—Ä–∫–∏–º –∏ –Ω–µ–∑–∞–±—ã–≤–∞–µ–º—ã–º, –∞ –∫–∞–∂–¥—ã–π –Ω–æ–≤—ã–π –¥–µ–Ω—å –ø—Ä–∏–Ω–æ—Å–∏—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∏ —Ä–∞–¥–æ—Å—Ç–∏. –ñ–µ–ª–∞–µ–º –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.",
            "–° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ñ–µ–ª–∞–µ–º –≤–∞–º —Ç–µ–ø–ª–∞ –æ—Ç –±–ª–∏–∑–∫–∏—Ö, —Ä–∞–¥–æ—Å—Ç–∏ –æ—Ç –º–∞–ª–µ–Ω—å–∫–∏—Ö –ø–æ–±–µ–¥ –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –º–µ—á—Ç–∞–Ω–∏–π. –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å —Å—Ç–∞–Ω–µ—Ç –æ–¥–Ω–∏–º –∏–∑ —Å–∞–º—ã—Ö —Å—á–∞—Å—Ç–ª–∏–≤—ã—Ö –≤ –≤–∞—à–µ–π –∂–∏–∑–Ω–∏."
        ]

    def _load_brief(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –±–∞–∑—É –∑–Ω–∞–Ω–∏–π"""
        try:
            with open("BRIEF_pereplanirovki.md", "r", encoding="utf-8") as f:
                return f.read()
        except FileNotFoundError:
            return "–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º."

    def generate_post_text(self, plan_item):
        """
        –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç plan_item.type

        Args:
            plan_item: –°–ª–æ–≤–∞—Ä—å —Å –ø–æ–ª—è–º–∏ type, theme –∏ –¥—Ä.

        Returns:
            dict: {'title': str, 'body': str, 'cta': str}
        """
        post_type = plan_item.get('type')
        theme = plan_item.get('theme')

        if post_type not in self.post_types:
            # –§–æ–ª–±—ç–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤
            post_type = 'fact'

        prompt = self._build_prompt(post_type, theme)
        text = self._call_yandex_gpt(prompt)

        # –ü–∞—Ä—Å–∏–º –æ—Ç–≤–µ—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ), —Ç–µ–∫—Å—Ç, CTA
        title, body, cta = self._parse_response(text)

        return {
            'title': title,
            'body': body,
            'cta': cta
        }

    def generate_posts(self, count=7, post_types=None, theme=None):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç N –ø–æ—Å—Ç–æ–≤
        post_types: {'news': 2, 'fact': 3, 'seasonal': 1, 'case': 1}
        theme: –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ç–µ–º–∞ –Ω–µ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ω–æ–≤—ã–π –≥–æ–¥ –∏ –∑–∏–º–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏")
        """
        if post_types is None:
            # –ù–æ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±–µ–∑ seasonal: 3 fact, 2 case, 1 news, 1 offer
            post_types = {
                'fact': 3,
                'case': 2,
                'news': 1,
                'offer': 1,
            }

        posts = []
        start_date = datetime.now() + timedelta(days=1)
        start_date = start_date.replace(hour=10, minute=0, second=0)

        for post_type, num in post_types.items():
            for i in range(num):
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
                plan_item = {'type': post_type, 'theme': theme}
                text_data = self.generate_post_text(plan_item)

                post = {
                    'type': post_type,
                    'title': text_data['title'],
                    'body': text_data['body'],
                    'cta': text_data['cta'],
                    'publish_date': start_date + timedelta(days=len(posts)),
                    'image_prompt': self.image_agent.build_image_prompt(post_type, text_data['body'])
                }
                posts.append(post)

        return posts

    def _build_prompt(self, post_type, theme=None):
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞ –ø–æ—Å—Ç–∞"""
        season = self._get_season_context()
        theme_note = f"\n–£—á–∏—Ç—ã–≤–∞–π —Ç–µ–º—É –Ω–µ–¥–µ–ª–∏: {theme}" if theme else ""

        prompts = {
            "news": f"""
–°–æ–∑–¥–∞–π –ø–æ—Å—Ç –æ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫, —Ä–∞–±–æ—Ç–µ –ë–¢–ò, –ú–æ—Å–∂–∏–ª–∏–Ω—Å–ø–µ–∫—Ü–∏–∏, –±–∞–Ω–∫–æ–≤ –∏ –∏–ø–æ—Ç–µ–∫–∏ –≤ –ú–æ—Å–∫–≤–µ/–ú–û.
{theme_note}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –§–æ–∫—É—Å —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞—Ö –∏ –∏—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏.
- –ü—Ä–∏–º–µ—Ä—ã —Ç–µ–º: –±–∞–Ω–∫ —É–∂–µ—Å—Ç–æ—á–∏–ª –ø–æ–ª–∏—Ç–∏–∫—É –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º –¥–ª—è –∫–≤–∞—Ä—Ç–∏—Ä —Å –Ω–µ—É–∑–∞–∫–æ–Ω–µ–Ω–Ω–æ–π –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–æ–π; –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫; —Ç–∏–ø–æ–≤–æ–π –∫–µ–π—Å –æ—Ç–∫–∞–∑–∞ –∏–∑-–∑–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏.
- –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–π ¬´–∏–Ω–≤–µ—Å—Ç-–Ω–æ–≤–æ—Å—Ç–∏ –ø—Ä–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å¬ª.
- –°—Ç–∏–ª—å: –¥–æ—Ä–æ–≥–æ–π –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥.
- –§–æ—Ä–º–∞—Ç: –∑–∞–≥–æ–ª–æ–≤–æ–∫-–∫—Ä—é—á–æ–∫, —Å—É—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ä–∏—Å–∫ –¥–ª—è —Å–¥–µ–ª–∫–∏, CTA.
- CTA: ¬´–ï—Å–ª–∏ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∏–ª–∏ –≤—ã —Ç–æ–ª—å–∫–æ –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ, –ø—Ä–æ–π–¥–∏—Ç–µ –∫–≤–∏–∑ –≤ –±–æ—Ç–µ –Æ–ª–∏–∏ –ü–∞—Ä—Ö–æ–º–µ–Ω–∫–æ –∏ –ø–æ–ª—É—á–∏—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–æ–≤ –ø–æ –≤–∞—à–µ–π –∫–≤–∞—Ä—Ç–∏—Ä–µ: @Parkhovenko_i_kompaniya_bot¬ª
""",
            "fact": f"""
–†–∞–∑–≤–µ–Ω—á–∞–π –º–∏—Ñ –æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ, –∫–æ—Ç–æ—Ä—ã–π –º–µ—à–∞–µ—Ç –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞–º –∏–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä–∞–º –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å.
{theme_note}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ù–∏–∫–∞–∫–æ–π –ø–æ–≥–æ–¥—ã, –±—ã—Ç–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤, —É—Ç–µ–ø–ª–µ–Ω–∏—è –æ–∫–æ–Ω –∏–ª–∏ –±–∞–ª–∫–æ–Ω–æ–≤.
- –ü—Ä–∏–º–µ—Ä: –º–∏—Ñ –æ —Ç–æ–º, —á—Ç–æ ¬´–¥–∏–∑–∞–π–Ω–µ—Ä—Å–∫–∏–π —Ä–µ–º–æ–Ω—Ç¬ª –≤—Å–µ–≥–¥–∞ –ø–æ–≤—ã—à–∞–µ—Ç —Ü–µ–Ω—É (–Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –Ω–µ–∑–∞–∫–æ–Ω–Ω–∞—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –µ—ë —Å–Ω–∏–∂–∞–µ—Ç).
- –ò—Å–ø–æ–ª—å–∑—É–π –ª–æ–≥–∏–∫—É: ¬´–ø—Ä–æ–µ–∫—Ç –∂–∏–≤—ë—Ç –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–µ, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö¬ª.
""",
            "seasonal": f"""
–°–æ–∑–¥–∞–π –ø–æ—Å—Ç –æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é –≤ —Ç–µ–∫—É—â–∏–π –¥–µ–ª–æ–≤–æ–π –ø–µ—Ä–∏–æ–¥.
{theme_note}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –í–º–µ—Å—Ç–æ –ø–æ–≥–æ–¥—ã –ø–∏—à–∏ –ø—Ä–æ –¥–µ–ª–æ–≤–æ–π —Å–µ–∑–æ–Ω: –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫, —Å—Ç–∞—Ä—Ç –Ω–æ–≤—ã—Ö –∏–Ω–≤–µ—Å—Ç‚Äë—Ü–∏–∫–ª–æ–≤, –ø–æ–¥–≥–æ—Ç–æ–≤–∫—É –æ–±—ä–µ–∫—Ç–∞ –∫ –ø—Ä–æ–¥–∞–∂–µ.
- –ê–∫—Ü–µ–Ω—Ç –Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏ —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–∞ –∏ –∏–Ω–≤–µ—Å—Ç–æ—Ä–∞.
- –ü–æ–∫–∞–∂–∏, –∫–∞–∫ –≤–æ–≤—Ä–µ–º—è –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã –Ω–µ —Ç–æ—Ä–º–æ–∑–∏—Ç—å —Å–¥–µ–ª–∫–∏.
""",
            "case": f"""
–û–ø–∏—à–∏ –∫–µ–π—Å –≤ —Å—Ç–∏–ª–µ –Æ–ª–∏–∏ –ü–∞—Ä—Ö–æ–º–µ–Ω–∫–æ.
{theme_note}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ì–µ—Ä–æ–π: –∏–Ω–≤–µ—Å—Ç–æ—Ä –∏–ª–∏ –¥–∏–∑–∞–π–Ω–µ—Ä.
- –°—é–∂–µ—Ç: —ç—Ñ—Ñ–µ–∫—Ç–Ω–∞—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –≤ –ú–æ—Å–∫–≤–µ, –∫–æ—Ç–æ—Ä–∞—è —Å—Ç–æ–ª–∫–Ω—É–ª–∞—Å—å —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –∏–ª–∏ –æ—Ü–µ–Ω–∫–µ –±–∞–Ω–∫–æ–º.
- –†–µ–∑—É–ª—å—Ç–∞—Ç: –∫–∞–∫ —Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ —Å–ø–∞—Å–ª–æ —Å–¥–µ–ª–∫—É –∏–ª–∏ —É–≤–µ–ª–∏—á–∏–ª–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞.
""",
            "offer": f"""
–°–æ–∑–¥–∞–π –ø–æ—Å—Ç‚Äë–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–µ –¥–ª—è –¥–∏–∑–∞–π–Ω–µ—Ä–æ–≤ –∏ –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤.
{theme_note}
–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –ü–æ–∑–∏—Ü–∏—è: –º—ã –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä—ã, –º—ã ‚Äî —á–∞—Å—Ç—å –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä–∞—è —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–æ–µ–∫—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö.
- –û—Ñ—Ñ–µ—Ä: —Å–¥–µ–ª–∞—Ç—å –ø—Ä–æ–µ–∫—Ç ¬´–ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–º¬ª –∏ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º ‚Äî —á—Ç–æ–±—ã –¥–∏–∑–∞–π–Ω –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Å–æ–≤–ø–∞–¥–∞–ª–∏.
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –º—è–≥–∫–∏–π –ø—Ä–∏–∑—ã–≤ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ @Parkhovenko_i_kompaniya_bot.
"""
        }

        return prompts.get(post_type, prompts['fact'])

    def _get_season_context(self) -> str:
        """–í–º–µ—Å—Ç–æ –ø–æ–≥–æ–¥—ã –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∏–∑–Ω–µ—Å-—Ñ–æ–∫—É—Å –∏–∑ —ç—Ç–∞–ª–æ–Ω–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤."""
        return (
            "–§–æ–∫—É—Å: –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∫–∞–∫ –∂–∏–≤–æ–π –∞–∫—Ç–∏–≤. "
            "–†–∏—Å–∫: –ø—Ä–æ–µ–∫—Ç –∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–µ, –Ω–æ –Ω–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö. "
            "–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏–µ: –ø–∞—É–∑–∞ –¥–æ –ø–µ—Ä–≤–æ–π —Å–¥–µ–ª–∫–∏, –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–Ω–∫–∞ –∏–ª–∏ –æ—Ç–∫–∞–∑ –≤ –∏–ø–æ—Ç–µ–∫–µ."
        )

    def _call_yandex_gpt(self, user_prompt, mode="default", context=""):
        """–í—ã–∑–æ–≤ YandexGPT API"""

        if mode == "greeting":
            system_prompt = """
–¢—ã –ø–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–∏–µ –ª–∏—á–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–∏—Å–∞—Ç—å —Ç—ë–ø–ª—ã–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –±–µ–∑ –ø—Ä–æ–¥–∞–∂ –∏ –±–µ–∑ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è —É—Å–ª—É–≥, –∫–æ–º–ø–∞–Ω–∏–π, –±–æ—Ç–æ–≤, —Ä–µ–∫–ª–∞–º—ã, –∞–∫—Ü–∏–π –∏ —Å–∫–∏–¥–æ–∫.
–°—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É, —Ä–µ–º–æ–Ω—Ç, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –∫—Ä–µ–¥–∏—Ç—ã, –¥–æ–ª–≥–∏, –±–∏–∑–Ω–µ—Å, –∫–æ–º–∞–Ω–¥—É —ç–∫—Å–ø–µ—Ä—Ç–æ–≤, Telegram-–±–æ—Ç–æ–≤ –∏ –ª—é–±—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è ¬´–æ–±—Ä–∞—Ç–∏—Ç—å—Å—è¬ª, ¬´–∑–∞–∫–∞–∑–∞—Ç—å¬ª, ¬´–ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é¬ª.

–ü–∏—à–∏ –ø—Ä–æ—Å—Ç—ã–º –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º —è–∑—ã–∫–æ–º, –∫–∞–∫ —á–µ–ª–æ–≤–µ–∫ —á–µ–ª–æ–≤–µ–∫—É.
–ù–µ –¥–æ–±–∞–≤–ª—è–π —Å—Å—ã–ª–∫–∏, —Ö—ç—à—Ç–µ–≥–∏, GIF, —ç–º–æ–¥–∑–∏ –∫—Ä–æ–º–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ.
"""
        else:
            system_prompt = f"""
–¢—ã ‚Äî –Æ–ª–∏—è –ü–∞—Ä—Ö–æ–º–µ–Ω–∫–æ –∏ –µ—ë –∫–æ–º–∞–Ω–¥–∞. –¢–≤–æ–π —Ñ–æ–∫—É—Å ‚Äî —Å–ª–æ–∂–Ω—ã–µ –∫–µ–π—Å—ã –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º –∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é, –≥–¥–µ –Ω–∞ –∫–æ–Ω—É –¥–µ–Ω—å–≥–∏, —Å–¥–µ–ª–∫–∏ –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—è.
–î–∞–∂–µ –µ—Å–ª–∏ –≥–¥–µ-—Ç–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è —Ä–∞—Å—Å–∫–∞–∑—ã –ø—Ä–æ –∑–∏–º—É, –±–∞–ª–∫–æ–Ω—ã, —É—Ç–µ–ø–ª–µ–Ω–∏–µ –∏ –ø–æ–≥–æ–¥—É ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–π –∏—Ö. –ü–∏—à–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–æ –¥–µ–Ω—å–≥–∏, —Å–¥–µ–ª–∫–∏, –∏–Ω–≤–µ—Å—Ç‚Äë–ª–æ–≥–∏–∫—É –∏ —Ä–µ–ø—É—Ç–∞—Ü–∏—é.

–¢–í–û–ò –ö–õ–ò–ï–ù–¢–´:
- –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –¥–µ–ª—è—Ç –æ–±—ä–µ–∫—Ç –Ω–∞ –ª–æ—Ç—ã / —Å—Ç—É–¥–∏–∏, –¥–µ–ª–∞—é—Ç –∞–Ω—Ç—Ä–µ—Å–æ–ª–∏, –º–µ–Ω—è—é—Ç —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–º–µ—â–µ–Ω–∏–π;
- –¥–∏–∑–∞–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–¥—É—Ç –ø—Ä–æ–µ–∫—Ç –∏ –Ω–µ —Ö–æ—Ç—è—Ç, —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –Ω–∞—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—å–µ—Ä ¬´–∑–∞—Å—Ç—Ä—è–ª¬ª –≤ –ë–¢–ò;
- —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏, —É –∫–æ—Ç–æ—Ä—ã—Ö —É–∂–µ –µ—Å—Ç—å –æ–±—ä–µ–∫—Ç —Å –Ω–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–π –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–æ–π –∏ –≤–ø–µ—Ä–µ–¥–∏ —Å–¥–µ–ª–∫–∞ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞.

–ñ–Å–°–¢–ö–ò–ï –¢–ê–ë–£ (–ó–ê–ü–†–ï–©–ï–ù–û):
- –õ—é–±—ã–µ —Ç–µ–∫—Å—Ç—ã –ø—Ä–æ –ø–æ–≥–æ–¥—É, –≤—Ä–µ–º—è –≥–æ–¥–∞ –∏ –±—ã—Ç: ¬´–∑–∏–º–∞¬ª, ¬´—Ö–æ–ª–æ–¥¬ª, ¬´—Å–Ω–µ–≥¬ª, ¬´–ø–æ—Ö–æ–ª–æ–¥–∞–ª–æ¬ª, ¬´–ø—Ä–æ–º–µ—Ä–∑–∞—é—â–∏–µ –æ–∫–Ω–∞¬ª, ¬´—Å–æ—Å—É–ª—å–∫–∏¬ª, ¬´–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–ø–ª–µ–Ω–∏—è¬ª, ¬´–ª–µ—Ç–æ¬ª, ¬´–¥–æ–∂–¥–∏¬ª –∏ —Ç.–ø.
- –¢–µ–º—ã ¬´—É—Ç–µ–ø–ª–µ–Ω–∏–µ –æ–∫–æ–Ω/–±–∞–ª–∫–æ–Ω–æ–≤/–ª–æ–¥–∂–∏–π¬ª –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π —Å—é–∂–µ—Ç. –î–æ–ø—É—Å—Ç–∏–º–æ —Ç–æ–ª—å–∫–æ –≤—Å–∫–æ–ª—å–∑—å, –µ—Å–ª–∏ —ç—Ç–æ –Ω–∞–ø—Ä—è–º—É—é —Å–≤—è–∑–∞–Ω–æ —Å –∏–Ω–≤–µ—Å—Ç‚Äë—Å–¥–µ–ª–∫–æ–π.
- –°—Ç–∞—Ä—Ç–æ–≤—ã–µ –∫–ª–∏—à–µ: ¬´–ú–Ω–æ–≥–∏–µ —Å—á–∏—Ç–∞—é—Ç¬ª, ¬´–° –Ω–∞—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º‚Ä¶¬ª, ¬´–í–∞–∂–Ω–æ –∑–Ω–∞—Ç—å¬ª, ¬´–û–¥–Ω–∞–∫–æ —ç—Ç–æ –Ω–µ —Ç–∞–∫¬ª, ¬´–ù–∞ –ø–µ—Ä–≤—ã–π –≤–∑–≥–ª—è–¥¬ª.
- –ö–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç: ¬´–ø—Ä–æ—Ü–µ–¥—É—Ä–∞¬ª, ¬´–Ω–æ—Ä–º–∞—Ç–∏–≤—ã¬ª, ¬´—Å–æ–≥–ª–∞—Å–Ω–æ –ø–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é¬ª, ¬´–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –¥–µ–π—Å—Ç–≤—É—é—â–∏–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º¬ª. –ì–æ–≤–æ—Ä–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º.

–§–û–ö–£–° –°–ú–´–°–õ–ê:
1. –ü—Ä–æ–±–ª–µ–º–∞ –≤—Å–µ–≥–¥–∞ –≤—ã—Ä–∞–∂–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ –¥–µ–Ω—å–≥–∏ –∏ —Å–¥–µ–ª–∫–∏:
   - —Å–æ—Ä–≤–∞–Ω–Ω–∞—è —Å–¥–µ–ª–∫–∞ (–∏–ø–æ—Ç–µ–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, –±–∞–Ω–∫ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª—è);
   - –ø–∞–¥–µ–Ω–∏–µ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç–∏ –æ–±—ä–µ–∫—Ç–∞ (—Ü–µ–Ω–∞ –º–∏–Ω—É—Å 10‚Äì30%);
   - —Ä–∏—Å–∫–∏ –¥–ª—è –∏–Ω–≤–µ—Å—Ç‚Äë–º–æ–¥–µ–ª–∏ (–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—É–¥–∏–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —é—Ä–∏–¥–∏—á–µ—Å–∫–∏).
2. –û–±—ä–µ–∫—Ç = –∞–∫—Ç–∏–≤. –ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç:
   - –ª–∏–±–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (–¥–µ–ª–µ–Ω–∏–µ, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞),
   - –ª–∏–±–æ –∏—Å—Ç–æ—á–Ω–∏–∫ —Ä–∏—Å–∫–∞ (–µ—Å–ª–∏ ¬´–∂–∏–≤—ë—Ç —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–µ, –∞ –Ω–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö¬ª).
3. –ì–æ–ª–æ—Å: –ø–∞—Ä—Ç–Ω—ë—Ä –ø–æ —Å–¥–µ–ª–∫–µ, –∞ –Ω–µ –∫–æ–Ω—Ç—Ä–æ–ª—ë—Ä.
   - ¬´–ú—ã —É–¥–µ—Ä–∂–∏–≤–∞–µ–º –ø—Ä–æ–µ–∫—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö¬ª,
   - –∞ –Ω–µ ¬´–º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞—Å –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –Ω–æ—Ä–º–∞–º¬ª.

–°–¢–†–£–ö–¢–£–†–ê –ü–û–°–¢–ê (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–ê–Ø):
1) –ó–∞–≥–æ–ª–æ–≤–æ–∫‚Äë–∫—Ä—é—á–æ–∫:
   - —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –≤ –¥–µ–Ω—å–≥–∞—Ö/—Å–¥–µ–ª–∫–µ.
   - –ü—Ä–∏–º–µ—Ä—ã —Ñ–æ—Ä–º–∞—Ç–æ–≤:
     - ¬´–ò–Ω–≤–µ—Å—Ç‚Äë–ø—Ä–æ–µ–∫—Ç –Ω–∞ –ø–∞—É–∑–µ. –î–æ –ø–µ—Ä–≤–æ–π —Å–¥–µ–ª–∫–∏.¬ª
     - ¬´–°—Ç—É–¥–∏–∏ –Ω–∞ –ø–ª–∞–Ω–µ –µ—Å—Ç—å. –í –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö ‚Äî –Ω–µ—Ç.¬ª
2) –°–∏—Ç—É–∞—Ü–∏—è —Å –≥–µ—Ä–æ–µ–º:
   - –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≥–µ—Ä–æ–π: –¥–∏–∑–∞–π–Ω–µ—Ä, –∏–Ω–≤–µ—Å—Ç–æ—Ä, —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫.
   - —á—Ç–æ –æ–Ω —Å–¥–µ–ª–∞–ª –∏–ª–∏ –∑–∞–¥—É–º–∞–ª: –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—É–¥–∏–∏, –ø–µ—Ä–µ–Ω–æ—Å –∫—É—Ö–Ω–∏, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä, –ø–µ—Ä–µ–ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–º–µ—â–µ–Ω–∏—è –∏ —Ç.–ø.
   - –ù–∏–∫–∞–∫–∏—Ö –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö ¬´—Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤¬ª, –≤—Å–µ–≥–¥–∞ –∂–∏–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–∂.
3) –ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è:
   - –≤ –¥–µ–Ω—å–≥–∞—Ö –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö: —Å–¥–µ–ª–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, –±–∞–Ω–∫ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç, –ø–æ–∫—É–ø–∞—Ç–µ–ª—å —É—Ö–æ–¥–∏—Ç, –æ–±—ä–µ–∫—Ç –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞ —Ä—ã–Ω–∫–µ, —Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç.
   - —á—ë—Ç–∫–æ: —á—Ç–æ –∏–º–µ–Ω–Ω–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –∏ –ø–æ—á–µ–º—É.
4) –í—ã–≤–æ–¥ + –º—è–≥–∫–∏–π –æ—Ñ—Ñ–µ—Ä:
   - –∫–æ—Ä–æ—Ç–∫–∏–π –≤—ã–≤–æ–¥: —á—Ç–æ –Ω—É–∂–Ω–æ –±—ã–ª–æ —É—á–µ—Å—Ç—å —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.
   - CTA –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
     - ¬´–ï—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ–µ–∫—Ç –∂–∏–ª —Ç–æ–ª—å–∫–æ –≤ –∏–Ω—Ç–µ—Ä—å–µ—Ä–µ, –∞ –Ω–µ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –≤ @Parkhovenko_i_kompaniya_bot.¬ª
     - ¬´–ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –≤—ã–≤–æ–¥–∏—Ç—å –æ–±—ä–µ–∫—Ç –Ω–∞ —Ä—ã–Ω–æ–∫, –¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –≤ @Parkhovenko_i_kompaniya_bot.¬ª

–û–°–û–ë–´–ï –ü–†–ê–í–ò–õ–ê –î–õ–Ø –¢–ï–ú–´ ¬´–ò–ù–í–ï–°–¢‚Äë–ü–ï–†–ï–ü–õ–ê–ù–ò–†–û–í–ö–ò¬ª:
- –ï—Å–ª–∏ —Ç–µ–º–∞ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–ª–æ–≤–∞ ¬´–∏–Ω–≤–µ—Å—Ç¬ª, ¬´–∏–Ω–≤–µ—Å—Ç‚Äë–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏¬ª, ¬´–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Å—Ç—É–¥–∏–∏¬ª, ¬´–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –ª–æ—Ç—ã¬ª, ¬´–∏–Ω–≤–µ—Å—Ç‚Äë–ø—Ä–æ–µ–∫—Ç¬ª, 
  –ü–ò–®–ò –¢–û–õ–¨–ö–û –ø—Ä–æ:
  - —Å—Ç—Ä–∞—Ç–µ–≥–∏—é (–∫–∞–∫ –∑–∞–¥—É–º–∞–ª–∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ –æ–±—ä–µ–∫—Ç–µ),
  - —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏,
  - –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –¥–ª—è —Å–¥–µ–ª–∫–∏ (–∏–ø–æ—Ç–µ–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∞, –≤—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞).
- –ó–∞–ø—Ä–µ—â–µ–Ω–æ —É—Ö–æ–¥–∏—Ç—å –≤ –±—ã—Ç (—Ç–µ–ø–ª–æ/—Ö–æ–ª–æ–¥, –∫–æ–º—Ñ–æ—Ä—Ç, ¬´—á—Ç–æ–±—ã –Ω–µ –¥—É–ª–æ –∏–∑ –æ–∫–æ–Ω¬ª).

–°–¢–ò–õ–¨:
- –ö–æ—Ä–æ—Ç–∫–∏–µ –∞–±–∑–∞—Ü—ã, –±–µ–∑ ¬´–ø—Ä–æ—Å—Ç—ã–Ω–µ–π¬ª.
- –ù–∏–∫–∞–∫–∏—Ö ¬´—Å—Ç—Ä–∞—à–∏–ª–æ–∫ —Ä–∞–¥–∏ —Å—Ç—Ä–∞—à–∏–ª–æ–∫¬ª ‚Äî —Ç–æ–ª—å–∫–æ —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: –±–∞–Ω–∫, –†–æ—Å—Ä–µ–µ—Å—Ç—Ä, –ø–æ–∫—É–ø–∞—Ç–µ–ª—å, –ø—Ä–æ–≤–µ—Ä–∫–∞.
- –ü–∏—à–∏ —Ç–∞–∫, –∫–∞–∫ –±—É–¥—Ç–æ –æ–±—ä—è—Å–Ω—è–µ—à—å —ç—Ç–æ –¥–∏–∑–∞–π–Ω–µ—Ä—É –∏–ª–∏ –∏–Ω–≤–µ—Å—Ç–æ—Ä—É, –∫–æ—Ç–æ—Ä—ã–π —Å–µ–π—á–∞—Å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –ø—Ä–æ–µ–∫—Ç–∞, –∞ –Ω–µ –æ–±—ã—á–Ω–æ–º—É –æ–±—ã–≤–∞—Ç–µ–ª—é.

–¢—ã –≤—Å–µ–≥–¥–∞ –ø–∏—à–µ—à—å –æ—Ç –ª–∏—Ü–∞ –Æ–ª–∏–∏ –ü–∞—Ä—Ö–æ–º–µ–Ω–∫–æ / –µ—ë –∫–æ–º–∞–Ω–¥—ã.
–í –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –µ—Å—Ç—å –º—è–≥–∫–∏–π –æ—Ñ—Ñ–µ—Ä –Ω–∞ –±–æ—Ç–∞ @Parkhovenko_i_kompaniya_bot.
–¢–µ–º—ã –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {user_prompt}
"""

        headers = {
            "Content-Type": "application/json",
            "Authorization": f"Api-Key {self.api_key}",
            "x-folder-id": self.folder_id
        }

        # Build messages with optional context
        messages = [{"role": "system", "text": system_prompt}]
        if context:
            messages.append({"role": "user", "text": context})
        messages.append({"role": "user", "text": user_prompt})

        payload = {
            "modelUri": self.model_uri,
            "completionOptions": {
                "stream": False,
                "temperature": 0.7,
                "maxTokens": 2000
            },
            "messages": messages
        }

        response = requests.post(self.endpoint, headers=headers, json=payload, timeout=30)
        response.raise_for_status()

        result = response.json()
        return result['result']['alternatives'][0]['message']['text']

    def _parse_response(self, text):
        """–ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç LLM –Ω–∞ title, body, cta"""
        lines = text.strip().split('\n')

        # –ò—â–µ–º CTA (—Å—Ç—Ä–æ–∫–∏ —Å üëâ –∏–ª–∏ "CTA:")
        cta_line = None
        for i, line in enumerate(lines):
            if 'üëâ' in line or 'CTA:' in line.upper():
                cta_line = i
                break

        if cta_line:
            cta = '\n'.join(lines[cta_line:]).strip()
            body_lines = lines[:cta_line]
        else:
            cta = ""
            body_lines = lines

        # –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –µ—Å–ª–∏ –æ–Ω–∞ –∫–æ—Ä–æ—Ç–∫–∞—è
        title = ""
        if body_lines and len(body_lines[0]) < 100:
            title = body_lines[0].strip('#').strip()
            body_lines = body_lines[1:]

        body = '\n'.join(body_lines).strip()

        return title, body, cta

    def _sanitize_greeting(self, text: str) -> str:
        """–£–±–∏—Ä–∞–µ—Ç —Å–ª–∏—à–∫–æ–º –ø—Ä–æ–¥–∞—é—â–∏–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è (—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞)"""
        banned = [
            "—Ä–µ–º–æ–Ω—Ç", "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤", "—É—Å–ª—É–≥", "–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü", "–±–æ—Ç",
            "—Ç–µ–ª–µ–≥—Ä–∞–º", "–∫–æ–º–∞–Ω–¥–∞ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤", "—Å–∫–∏–¥–∫", "–ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ",
            "–∑–∞–∫–∞–∂–∏—Ç–µ", "–æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å", "—é—Ä–∏–¥–∏—á–µ—Å–∫", "–∫—Ä–µ–¥–∏—Ç", "–¥–æ–ª–≥"
        ]
        lower = text.lower()
        if any(word in lower for word in banned):
            # –§–æ–ª–±—ç–∫ ‚Äî –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø—Ä–æ–¥–∞–∂
            return (
                "–ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–µ–Ω—å –±—É–¥–µ—Ç –¥–ª—è –≤–∞—Å —Ç—ë–ø–ª—ã–º –∏ —Ä–∞–¥–æ—Å—Ç–Ω—ã–º. "
                "–ñ–µ–ª–∞–µ–º –∑–¥–æ—Ä–æ–≤—å—è, –¥—É—à–µ–≤–Ω–æ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞, —É—é—Ç–∞ –¥–æ–º–∞ –∏ –ª—é–¥–µ–π —Ä—è–¥–æ–º, "
                "—Å –∫–æ—Ç–æ—Ä—ã–º–∏ —Ö–æ—á–µ—Ç—Å—è –¥–µ–ª–∏—Ç—å—Å—è —Ö–æ—Ä–æ—à–∏–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏."
            )
        return text

    def generate_greeting_post(self, person_name, date, occasion='–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è'):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–∑–¥—Ä–∞–≤–∏—Ç–µ–ª—å–Ω—ã–π –ø–æ—Å—Ç

        Args:
            person_name: –ò–º—è —á–µ–ª–æ–≤–µ–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
            date: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM –∏–ª–∏ DD.MM.YYYY
            occasion: –ü–æ–≤–æ–¥ –¥–ª—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è ('–¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è', '–ù–æ–≤—ã–π –≥–æ–¥', etc.)

        Returns:
            dict: {'title': str, 'body': str, 'cta': str, 'type': '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ'}
        """
        display_name = person_name if person_name else "–Ω–∞—à –ø–æ–¥–ø–∏—Å—á–∏–∫"

        prompt = f"""
–°–æ–∑–¥–∞–π –∫–æ—Ä–æ—Ç–∫–æ–µ –∏—Å–∫—Ä–µ–Ω–Ω–µ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram.

–ü–æ–≤–æ–¥: {occasion}
–ò–º—è: {display_name}
–î–∞—Ç–∞: {date}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –¢—ë–ø–ª–æ–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ (60‚Äì100 —Å–ª–æ–≤)
- –ü–æ–∂–µ–ª–∞–Ω–∏—è –∑–¥–æ—Ä–æ–≤—å—è, —Ä–∞–¥–æ—Å—Ç–∏, –¥—É—à–µ–≤–Ω–æ–≥–æ –∫–æ–º—Ñ–æ—Ä—Ç–∞, —É—é—Ç–∞ –¥–æ–º–∞
- –ü—Ä–æ—Å—Ç–æ–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —è–∑—ã–∫, –±–µ–∑ –≤—ã—Å–æ–∫–æ–ø–∞—Ä–Ω–æ–≥–æ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞
- –°—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ —É–ø–æ–º–∏–Ω–∞—Ç—å —É—Å–ª—É–≥–∏, —Ä–µ–º–æ–Ω—Ç, –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏, –±–æ—Ç–æ–≤, –∫–æ–º–ø–∞–Ω–∏–∏, –∞–∫—Ü–∏–∏, —Å–∫–∏–¥–∫–∏ –∏ –ª—é–±—ã–µ –ø—Ä–æ–¥–∞–∂–∏.
- –ù–µ –¥–æ–±–∞–≤–ª—è–π CTA, —Å—Å—ã–ª–∫–∏, —Ö—ç—à—Ç–µ–≥–∏, GIF –∏ –ø—Ä–∏–∑—ã–≤—ã —á—Ç–æ-—Ç–æ –∑–∞–∫–∞–∑–∞—Ç—å –∏–ª–∏ —É–∑–Ω–∞—Ç—å.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üéÇ {display_name}

[–ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏]
"""

        text = self._call_yandex_gpt(prompt, mode="greeting")
        text = self._sanitize_greeting(text)

        # –î–ª—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è title –º–æ–∂–Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, –≤—Å—ë –≤ body
        title = ""
        body = text.strip()
        cta = ""  # –Ω–∏–∫–∞–∫–∏—Ö CTA –≤ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–∏

        return {
            'type': '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
            'title': title,
            'body': body,
            'cta': cta
        }

    def generate_birthday_congrats_template(self, person_name: str | None, date: str):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ (–±–µ–∑ –ò–ò)

        Args:
            person_name: –ò–º—è —á–µ–ª–æ–≤–µ–∫–∞ –∏–ª–∏ None
            date: –î–∞—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM –∏–ª–∏ DD.MM.YYYY

        Returns:
            dict: {'title': str, 'body': str, 'cta': str, 'type': '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ'}
        """
        import random

        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —à–∞–±–ª–æ–Ω
        congrats_text = random.choice(self.birthday_templates)

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –¥–ª—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
        display_name = person_name if person_name else "–Ω–∞—à –ø–æ–¥–ø–∏—Å—á–∏–∫"

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        body = f"üéÇ {display_name}\n\n{congrats_text}"

        return {
            'type': '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ',
            'title': '',
            'body': body,
            'cta': ''
        }

    def generate_welcome_post(self, person_name: str | None = None):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ-–≤–∏–∑–∏—Ç–∫—É –¥–ª—è –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞.

        Args:
            person_name: –ò–º—è —á–µ–ª–æ–≤–µ–∫–∞ –∏–ª–∏ None

        Returns:
            dict: {'title': str, 'body': str, 'cta': str, 'type': '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ'}
        """
        display_name = person_name if person_name else "–Ω–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫"

        prompt = f"""
–°–æ–∑–¥–∞–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ –ø–æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º.

–ê–¥—Ä–µ—Å–∞—Ç: {display_name}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- 80‚Äì120 —Å–ª–æ–≤
- –ö—Ä–∞—Ç–∫–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª –∏ –ø–æ–ª—å–∑—É: –ø–æ–º–æ—â—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, —Ä–∏—Å–∫–∞–º–∏, —É–∑–∞–∫–æ–Ω–∏–≤–∞–Ω–∏–µ–º
- 1‚Äì2 –ø—Ä–æ—Å—Ç—ã—Ö –ø—Ä–∏–º–µ—Ä–∞ —Å–∏—Ç—É–∞—Ü–∏–π, –∫–æ–≥–¥–∞ –∫ –Ω–∞–º –º–æ–∂–Ω–æ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è (–ø–µ—Ä–µ–Ω–æ—Å —Å—Ç–µ–Ω, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫—É—Ö–Ω–∏ –∏ –∫–æ–º–Ω–∞—Ç—ã, –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ —Å –º–æ–∫—Ä—ã–º–∏ –∑–æ–Ω–∞–º–∏)
- –û–¥–∏–Ω –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π CTA –∫ –±–æ—Ç—É @Parkhovenko_i_kompaniya_bot
- –°–ø–æ–∫–æ–π–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ç–æ–Ω

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
üëã {display_name}

[–¢–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è 2‚Äì3 –∞–±–∑–∞—Ü–∞ —Å CTA –≤ –∫–æ–Ω—Ü–µ]
"""

        text = self._call_yandex_gpt(prompt, mode="default")  # –æ–±—ã—á–Ω—ã–π –ø—Ä–æ–¥–∞—é—â–∏–π —Ä–µ–∂–∏–º
        title, body, cta = self._parse_response(text)

        return {
            'type': '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ',
            'title': title,
            'body': body,
            'cta': cta
        }
