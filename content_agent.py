import os
import random
import requests
import logging
from datetime import datetime
from llm_client import call_llm

logger = logging.getLogger(__name__)

class ContentAgent:
    """
    –ê–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–ø–æ—Å—Ç—ã, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–æ–≤–æ—Å—Ç–∏).
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç OpenRouter (—á–µ—Ä–µ–∑ llm_client) –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–æ–≤.
    """

    def __init__(self):
        self.brand_name = "–õ–ê–î: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –∏ –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        self.bot_username = "@LadBot"

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—Ä–∞—Ç–∫—É—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        self.brief_content = ""
        knowledge_path = "knowledge_base/README.md"
        if os.path.exists(knowledge_path):
            with open(knowledge_path, 'r', encoding='utf-8') as f:
                self.brief_content = f.read()

        self.birthday_templates = [
            "–ñ–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –≤–∞—à –¥–æ–º –≤—Å–µ–≥–¥–∞ –±—ã–ª –º–µ—Å—Ç–æ–º —Å–∏–ª—ã, –∞ –ª—é–±–∞—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏–Ω–æ—Å–∏–ª–∞ —Ç–æ–ª—å–∫–æ —Ä–∞–¥–æ—Å—Ç—å –∏ —É—é—Ç! –° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! ü•Ç",
            "–ü—É—Å—Ç—å –≤ –∂–∏–∑–Ω–∏ –≤—Å—ë —Å–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫ –∂–µ –∏–¥–µ–∞–ª—å–Ω–æ, –∫–∞–∫ —É–¥–∞—á–Ω—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ–µ–∫—Ç. –° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! üéÇ",
            "–ñ–µ–ª–∞–µ–º –≥–∞—Ä–º–æ–Ω–∏–∏, —É—é—Ç–∞ –∏ —Ç–µ–ø–ª–∞ –≤–∞—à–µ–º—É –¥–æ–º—É. –ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π –º–µ—Ç—Ä –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –≤–¥–æ—Ö–Ω–æ–≤–ª—è–µ—Ç! –° –¥–Ω–µ–º —Ä–æ–∂–¥–µ–Ω–∏—è! üéâ"
        ]

    def generate_posts(self, count=7, theme=None):
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–∞—á–∫—É –ø–æ—Å—Ç–æ–≤ (–¢–ó-1: –¥–æ 15 –ø–æ—Å—Ç–æ–≤).
        """
        prompt = f"""
–°–æ–∑–¥–∞–π –Ω–∞–±–æ—Ä –∏–∑ {count} SEO-–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞ ¬´{self.brand_name}¬ª.
{"–¢–µ–º–∞: " + theme if theme else "–¢–µ–º—ã: –∂–∏–≤–æ–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π, –∫–µ–π—Å, —Å–µ–∑–æ–Ω–Ω—ã–π, –º–µ–º."}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ö–ê–ñ–î–û–ú–£ –ü–û–°–¢–£:
1. –¢–ï–ö–°–¢: 600‚Äì900 —Å–∏–º–≤–æ–ª–æ–≤. –ñ–∏–≤–æ–π, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —è–∑—ã–∫, —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥.
2. SEO: –ú–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –∫–ª—é—á –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∏ –æ–¥–∏–Ω –≤ —Ç–µ–∫—Å—Ç–µ.
3. –°–¢–†–£–ö–¢–£–†–ê: –ó–∞–≥–æ–ª–æ–≤–æ–∫ -> –ò—Å—Ç–æ—Ä–∏—è/–ü—Ä–æ–±–ª–µ–º–∞ -> –†–µ—à–µ–Ω–∏–µ -> CTA -> –•—ç—à—Ç–µ–≥–∏.
4. CTA (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
   –•–æ—á–µ—à—å —Ç–∞–∫ –∂–µ? –ü—Ä–æ–π–¥–∏ —Ç–µ—Å—Ç: https://t.me/LadBot?start=quiz_land
   –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è: https://t.me/LadBot?start=consult
5. –•–≠–®–¢–ï–ì–ò: 3‚Äì4 —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ö—ç—à—Ç–µ–≥–∞ –≤ –∫–æ–Ω—Ü–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, #–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ #—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ #–ª–∞–¥—ç–∫—Å–ø–µ—Ä—Ç).
6. –ö–ê–†–¢–ò–ù–ö–ê: –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ –ø—Ä–∏–¥—É–º–∞–π image_prompt –¥–ª—è Yandex Art (1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –±–µ–∑ —Ç–µ–∫—Å—Ç–∞, 16:9, —Å–≤–µ—Ç–ª–∞—è –ø–∞–ª–∏—Ç—Ä–∞, –∏–Ω—Ç–µ—Ä—å–µ—Ä/–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞).

–ö–ª—é—á–∏ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –ø–æ –ø–æ—Å—Ç–∞–º):
–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã, —à—Ç—Ä–∞—Ñ –∑–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É 2025, —Å–Ω–æ—Å —Å—Ç–µ–Ω—ã –≤ –ø–∞–Ω–µ–ª—å–Ω–æ–º –¥–æ–º–µ, –ª–µ—Ç–Ω—è—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ 2025, —Ä–µ–º–æ–Ω—Ç –±–µ–∑ –Ω–µ—Ä–≤–æ–≤, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ —Å–∞–Ω—É–∑–ª–∞, –ø–µ—Ä–µ–Ω–æ—Å –∫—É—Ö–Ω–∏ –≤ –≥–æ—Å—Ç–∏–Ω—É—é, –≤—ã–ø–∏—Å–∫–∞ –ï–ì–†–ù –¥–ª—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –≤ –ú–æ—Å–∫–≤–µ 2025, –≥–∞–∑–æ–≤–∞—è –ø–ª–∏—Ç–∞ –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, —ç–ª–µ–∫—Ç—Ä–æ–ø–ª–∏—Ç–∞ –ø–æ—Å–ª–µ —Å–Ω–æ—Å–∞ —Å—Ç–µ–Ω—ã, –∏–ø–æ—Ç–µ–∫–∞ –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, –º–æ–∫—Ä–∞—è –∑–æ–Ω–∞ –Ω–∞–¥ –∂–∏–ª–æ–π, –æ–±—â–µ–¥–æ–º–æ–≤–æ–µ –∏–º—É—â–µ—Å—Ç–≤–æ, —Ä–∞–∑–≤–æ–¥–∫–∞ —Ç—Ä—É–± –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏–π, –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ JSON —Å–ø–∏—Å–æ–∫):
[
  {{
    "type": "—Ç–∏–ø –ø–æ—Å—Ç–∞",
    "title": "–ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–ª—é—á–æ–º",
    "body": "–û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ —Å –∫–ª—é—á–æ–º –∏ CTA",
    "cta": "–°—Å—ã–ª–∫–∏ –∏ —Ö—ç—à—Ç–µ–≥–∏",
    "image_prompt": "–ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–∞—Ä—Ç–∏–Ω–∫–∏",
    "publish_date": "YYYY-MM-DD HH:MM:SS"
  }},
  ...
]
–ü–†–ò–ú–ï–ß–ê–ù–ò–ï: publish_date –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è 10:00:00 –∏ –∏–¥—Ç–∏ —Å —à–∞–≥–æ–º –≤ 1 –¥–µ–Ω—å.
"""

        try:
            response_text = call_llm("–¢—ã - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π SEO-–∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä –∏ —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏.", prompt)

            # –ò–∑–≤–ª–µ–∫–∞–µ–º JSON
            import json
            import re

            json_match = re.search(r'\[.*\]', response_text, re.DOTALL)
            if json_match:
                posts = json.loads(json_match.group(0))
                return posts
            else:
                logger.error("LLM did not return valid JSON for posts")
                return []
        except Exception as e:
            logger.error(f"Error generating posts: {e}")
            return []

    def generate_birthday_congrats_template(self, person_name: str | None, date: str):
        display_name = person_name if person_name else "–Ω–∞—à –ø–æ–¥–ø–∏—Å—á–∏–∫"
        body = f"üéÇ {display_name}\n\n{random.choice(self.birthday_templates)}"
        return {'type': '–ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ', 'title': '', 'body': body, 'cta': ''}

    def generate_welcome_post(self, person_name: str | None = None):
        display_name = person_name if person_name else "–Ω–æ–≤—ã–π –ø–æ–¥–ø–∏—Å—á–∏–∫"
        prompt = f"–°–æ–∑–¥–∞–π —Ç–µ–ø–ª–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (80-120 —Å–ª–æ–≤) –¥–ª—è –∫–∞–Ω–∞–ª–∞ {self.brand_name}. –£–ø–æ–º—è–Ω–∏ –ø–æ–º–æ—â—å —Å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–æ–π –∏ –±–æ—Ç–∞ @LadBot."
        text = call_llm("–¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏.", prompt)
        return {'type': '–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', 'title': f"üëã {display_name}", 'body': text, 'cta': f"–£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ: {self.bot_username}"}

    def monitor_legal_news(self):
        # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
        return []

    def get_russian_holidays(self):
        return {
            "01.01": "–ù–æ–≤—ã–π –≥–æ–¥",
            "07.01": "–†–æ–∂–¥–µ—Å—Ç–≤–æ",
            "23.02": "–î–µ–Ω—å –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞",
            "08.03": "–ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –∂–µ–Ω—Å–∫–∏–π –¥–µ–Ω—å",
            "01.05": "–ü—Ä–∞–∑–¥–Ω–∏–∫ –í–µ—Å–Ω—ã –∏ –¢—Ä—É–¥–∞",
            "09.05": "–î–µ–Ω—å –ü–æ–±–µ–¥—ã",
            "12.06": "–î–µ–Ω—å –†–æ—Å—Å–∏–∏",
            "04.11": "–î–µ–Ω—å –Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–∞"
        }
