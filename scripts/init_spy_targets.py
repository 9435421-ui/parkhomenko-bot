import asyncio
import logging
from database import db

logger = logging.getLogger("init_spy_targets")

# =============================================================================
# СТРАТЕГИЯ «ГЛОБАЛЬНЫЙ ПОИСК С ГЕО-ФИЛЬТРАЦИЕЙ»
# =============================================================================
# Шпион НЕ привязан к конкретным ЖК.
# 
# Как работает:
# 1. Discovery автоматически находит каналы по ключевым словам (перепланировка, ремонт, недвижимость)
# 2. Шпион мониторит ВСЕ найденные каналы
# 3. Гео-фильтрация: только Москва и Московская область (определяется через AI или по тексту)
# 4. Парсинг комментариев в Discussion Groups (если есть)
# 5. Автоматический ответ Антона в комментариях при обнаружении лида
#
# Преимущества:
# - Не нужно обновлять список ЖК вручную
# - Автоматически подхватывает новые каналы
# - Широкий охват всех обсуждений
# - Фильтрация только по гео (Москва/МО)
# =============================================================================

# =============================================================================
# ПРИМЕЧАНИЕ: Этот скрипт больше не используется для добавления конкретных ЖК.
# Discovery автоматически находит каналы по ключевым словам.
# Этот файл оставлен для совместимости, но INITIAL_TARGETS пуст.
# =============================================================================

INITIAL_TARGETS = [
    # Пусто — Discovery найдёт каналы автоматически
]


async def main():
    await db.connect()
    added = 0
    skipped = 0
    for t in INITIAL_TARGETS:
        try:
            await db.add_target_resource(
                "telegram",
                t["link"],
                title=t.get("title"),
                participants_count=t.get("participants_count", 0),
                status="active",
                geo_tag=t.get("geo_tag"),
                is_high_priority=1 if t.get("is_high_priority") else 0,
            )
            added += 1
            flag = " ⭐ ПРИОРИТЕТНЫЙ" if t.get("is_high_priority") else ""
            print(f"  ✅ Добавлен{flag}: {t['title']} ({t['link']})")
        except Exception as e:
            skipped += 1
            print(f"  ⚠️  Пропущен: {t.get('link')} — {e}")
            logger.warning("add target %s failed: %s", t.get("link"), e)
    await db.conn.close()
    print(f"\nГотово: добавлено {added}, пропущено {skipped}.")
    if skipped:
        print("Пропущенные записи уже есть в БД или произошла ошибка (см. выше).")
    print(
        "\n✅ Стратегия «Глобальный поиск с гео-фильтрацией» активирована.\n"
        "Discovery автоматически находит каналы по ключевым словам.\n"
        "Шпион мониторит все найденные каналы (только Москва/МО).\n"
        "При обнаружении лида → Антон отвечает публично в ветке обсуждения."
    )


if __name__ == "__main__":
    asyncio.run(main())
