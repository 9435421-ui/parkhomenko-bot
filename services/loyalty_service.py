"""
–°–µ—Ä–≤–∏—Å –ª–æ—è–ª—å–Ω–æ—Å—Ç–∏: –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–∞–º–∏ –∏ –¥–Ω—è–º–∏ —Ä–æ–∂–¥–µ–Ω–∏—è
"""
import asyncio
from datetime import datetime
from aiogram import Bot

class LoyaltyService:
    def __init__(self, bot: Bot):
        self.bot = bot
        # –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–∞–∑–¥–Ω–∏–∫–∏ –†–§
        self.holidays = {
            "01.01": "–° –ù–æ–≤—ã–º –≥–æ–¥–æ–º!",
            "07.01": "–° –†–æ–∂–¥–µ—Å—Ç–≤–æ–º –•—Ä–∏—Å—Ç–æ–≤—ã–º!",
            "23.02": "–° –î–Ω–µ–º –∑–∞—â–∏—Ç–Ω–∏–∫–∞ –û—Ç–µ—á–µ—Å—Ç–≤–∞!",
            "08.03": "–° –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–º –∂–µ–Ω—Å–∫–∏–º –¥–Ω–µ–º!",
            "01.05": "–° –ü—Ä–∞–∑–¥–Ω–∏–∫–æ–º –í–µ—Å–Ω—ã –∏ –¢—Ä—É–¥–∞!",
            "09.05": "–° –î–Ω–µ–º –ü–æ–±–µ–¥—ã!",
            "12.06": "–° –î–Ω–µ–º –†–æ—Å—Å–∏–∏!",
            "04.11": "–° –î–Ω–µ–º –Ω–∞—Ä–æ–¥–Ω–æ–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–∞!"
        }

    async def check_and_send_greetings(self, db):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π"""
        now = datetime.now()
        today_str = now.strftime("%d.%m")

        # 1. –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –ø—Ä–∞–∑–¥–Ω–∏–∫–æ–º (–≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
        holiday_name = self.holidays.get(today_str)
        if holiday_name:
            users = await db.get_all_users()
            for user in users:
                try:
                    await self.bot.send_message(
                        user['user_id'],
                        f"üéâ {holiday_name}\n\n–ö–æ–º–∞–Ω–¥–∞ –¢–ï–†–ò–û–ù –∂–µ–ª–∞–µ—Ç –≤–∞–º —É—Å–ø–µ—Ö–æ–≤, –ø—Ä–æ—Ü–≤–µ—Ç–∞–Ω–∏—è –∏ —É—é—Ç–∞ –≤ –≤–∞—à–µ–º –¥–æ–º–µ!"
                    )
                    await asyncio.sleep(0.05) # –õ–∏–º–∏—Ç 20 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —Å–µ–∫—É–Ω–¥—É
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∞–∑–¥–Ω–∏—á–Ω–æ–≥–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

        # 2. –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –î–Ω–µ–º –†–æ–∂–¥–µ–Ω–∏—è
        birthday_users = await db.get_users_with_birthday(today_str)
        for user in birthday_users:
            try:
                name = user['first_name'] or "–¥–æ—Ä–æ–≥–æ–π –∫–ª–∏–µ–Ω—Ç"
                await self.bot.send_message(
                    user['user_id'],
                    f"üéÇ –° –î–Ω–µ–º –†–æ–∂–¥–µ–Ω–∏—è, {name}!\n\n–ü—É—Å—Ç—å –≤–∞—à –¥–æ–º –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —É—é—Ç–Ω—ã–º, –∞ –≤—Å–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –∑–∞–∫–æ–Ω–Ω—ã–º–∏ –∏ –ª–µ–≥–∫–∏–º–∏. –° –Ω–∞–∏–ª—É—á—à–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏, –≤–∞—à –¢–ï–†–ò–û–ù."
                )
                await asyncio.sleep(0.05)
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —Å –î–† –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user['user_id']}: {e}")

    async def run_daily_check(self, db):
        """–§–æ–Ω–æ–≤—ã–π —Ü–∏–∫–ª –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏"""
        while True:
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –≤ 10:00 –ø–æ –º–µ—Å—Ç–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞
            now = datetime.now()
            # –ú–æ–∂–Ω–æ —É—Å–ª–æ–∂–Ω–∏—Ç—å –¥–æ –æ–∂–∏–¥–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —á–∞—Å–∞, –Ω–æ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ ‚Äî —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏
            await self.check_and_send_greetings(db)
            await asyncio.sleep(86400) # 24 —á–∞—Å–∞
