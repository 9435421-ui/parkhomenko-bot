import logging
import os
import re
from utils import router_ai

logger = logging.getLogger(__name__)

# =============================================================================
# –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö ‚Äî ¬´–û—Ç–∫—Ä—ã—Ç–∞—è –æ—Ö–æ—Ç–∞¬ª
# –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –ñ–ö –ò —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
# (–∑–∞–∫–æ–Ω, —à—Ç—Ä–∞—Ñ, —Ä–µ–º–æ–Ω—Ç, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ) ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≥–æ—Ä—è—á–∏–π –ª–∏–¥ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
# =============================================================================

# =============================================================================
# –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö (9 –ñ–ö –∏–∑ –¢–ó)
# –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –ñ–ö ‚Äî –ª–∏–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ ‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô
# =============================================================================
PRIORITY_ZHK = [
    "–∑–∏–ª–∞—Ä—Ç",
    "—Å–∏–º–≤–æ–ª",
    "—Å–µ—Ä–¥—Ü–µ —Å—Ç–æ–ª–∏—Ü—ã",
    "–¥–∏–Ω–∞—Å—Ç–∏—è",
    "–ø—Ä–µ—Å–Ω—è —Å–∏—Ç–∏",
    "–Ω–µ–∫—Ä–∞—Å–æ–≤–∫–∞",
    "–ª—é–±–ª–∏–Ω—Å–∫–∏–π –ø–∞—Ä–∫",
    "—Ñ–∏–ª–∏ –≥—Ä–∞–¥",
    "–≤–æ–ª–∂—Å–∫–∏–π –ø–∞—Ä–∫",
    "—Å–∞–ª–∞—Ä—å–µ–≤–æ",
    "–º–∏—Ç–∏–Ω–æ",
    "—Å–∫–æ–ª–∫–æ–≤–æ",
    "–±—Ä–∞—Ç–µ–µ–≤–æ",
]

# =============================================================================
# TRIGGER WORDS ‚Äî –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤
# –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —ç—Ç–∏ —Ñ—Ä–∞–∑—ã ‚Äî –ª–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –≥–æ—Ä—è—á–∏–π
# =============================================================================
TRIGGER_WORDS = [
    "–º–æ–∂–Ω–æ –ª–∏ —Å–Ω–æ—Å–∏—Ç—å",
    "–º–æ–∂–Ω–æ —Å–Ω–æ—Å–∏—Ç—å",
    "–≥–¥–µ –∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç",
    "–∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "—à—Ç—Ä–∞—Ñ –±—Ç–∏",
    "—à—Ç—Ä–∞—Ñ –æ—Ç –±—Ç–∏",
    "–∫—Ä–∞—Å–Ω—ã–µ –ª–∏–Ω–∏–∏",
    "–∫—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è",
    "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫—É—Ö–Ω–∏",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫—É—Ö–Ω—é",
    "–ø–µ—Ä–µ–Ω–æ—Å –º–æ–∫—Ä–æ–π –∑–æ–Ω—ã",
    "–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–æ–∫—Ä—É—é –∑–æ–Ω—É",
    "—Å–Ω–æ—Å —Å—Ç–µ–Ω—ã",
    "—Å–Ω–æ—Å–∏—Ç—å —Å—Ç–µ–Ω—É",
    "—É–∑–∞–∫–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "–∫–∞–∫ —É–∑–∞–∫–æ–Ω–∏—Ç—å",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "–Ω—É–∂–µ–Ω –ø—Ä–æ–µ–∫—Ç",
    "–∫—Ç–æ –¥–µ–ª–∞–ª –ø—Ä–æ–µ–∫—Ç",
    "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
]

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã: –ø—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–µ–º–æ–Ω—Ç/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
ZHK_PROBLEM_KEYWORDS = [
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏",
    "—É–∑–∞–∫–æ–Ω–∏",
    "–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ",
    "–º–∂–∏",
    "—à—Ç—Ä–∞—Ñ",
    "–∏–Ω—Å–ø–µ–∫—Ü–∏—è",
    "—Å—É–¥",
    "–ø—Ä–æ–µ–∫—Ç",
    "—Å–Ω–æ—Å —Å—Ç–µ–Ω",
    "—Å–Ω–µ—Å—Ç–∏ —Å—Ç–µ–Ω—É",
    "–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å",
    "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
    "—Å–∞–Ω—É–∑–µ–ª",
    "–±—Ç–∏",
    "–∞–∫—Ç —Å–∫—Ä—ã—Ç—ã—Ö",
    "—Å—Ä–æ",
    "–ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
    "—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
    "–∫—Ç–æ –¥–µ–ª–∞–ª",
    "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
    "–ø–æ–º–æ–≥–∏—Ç–µ",
    "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ",
    "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å",
]


# –ì–µ–æ-–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞ –∏ –ú–û)
GEO_MOSCOW_MARKERS = [
    "–º–æ—Å–∫–≤–∞", "–º–æ—Å–∫–æ–≤—Å–∫", "–º—Å–∫", "–º–∫–¥", "–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–º–æ",
    "—Ö–∏–º–∫–∏", "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫", "–º—ã—Ç–∏—â–∏", "–±–∞–ª–∞—à–∏—Ö–∞", "–ª—é–±–µ—Ä—Ü—ã",
    "–ø–æ–¥–º–æ—Å–∫–æ–≤—å–µ", "–Ω–æ–≤–∞—è –º–æ—Å–∫–≤–∞", "–Ω–∞–æ", "–∑–∞–æ", "—Å–∞–æ", "—Å–≤–∞–æ", "–≤–∞–æ", "—é–≤–∞–æ", "—é–∞–æ", "—Å–∑–∞–æ", "—Ü–∞–æ",
    "—é–≥–æ-–≤–æ—Å—Ç–æ–∫", "—é–≥–æ-–∑–∞–ø–∞–¥", "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫", "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥",
]


def _is_moscow_geo(text: str, source_name: str = "") -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ—Å—Ç –∫ –ú–æ—Å–∫–≤–µ –∏–ª–∏ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏.
    –§–∏–ª—å—Ç—Ä—É–µ—Ç –ª–∏–¥—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤.
    
    Returns:
        True –µ—Å–ª–∏ –≥–µ–æ = –ú–æ—Å–∫–≤–∞/–ú–û, False –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω
    """
    if not text and not source_name:
        return True  # –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º)
    
    combined = f"{text} {source_name}".lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ú–æ—Å–∫–≤—ã/–ú–û
    has_moscow = any(marker in combined for marker in GEO_MOSCOW_MARKERS)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ (–æ—Ç—Å–µ–∏–≤–∞–µ–º)
    other_regions = [
        "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±", "–ø–∏—Ç–µ—Ä", "–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥",
        "–∫–∞–∑–∞–Ω—å", "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥", "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
        "—Ä–æ—Å—Ç–æ–≤", "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä", "—Å–æ—á–∏", "–∫—Ä—ã–º",
    ]
    has_other_region = any(region in combined for region in other_regions)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –¥—Ä—É–≥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ –ò –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ú–æ—Å–∫–≤—ã ‚Äî –æ—Ç—Å–µ–∏–≤–∞–µ–º
    if has_other_region and not has_moscow:
        return False
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –ú–æ—Å–∫–≤—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if has_moscow:
        return True
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–≥–æ)
    return True


def _detect_priority_zhk_hot(text: str) -> tuple[bool, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (True, –Ω–∞–∑–≤–∞–Ω–∏–µ_–∂–∫) –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö
    –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –ò–ò ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    –∫–∞–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –≥–æ—Ä—è—á–µ–≥–æ –ª–∏–¥–∞.
    """
    if not text:
        return False, ""
    t = text.lower()
    found_zhk = next((zhk for zhk in PRIORITY_ZHK if zhk in t), None)
    if not found_zhk:
        return False, ""
    has_problem = any(kw in t for kw in ZHK_PROBLEM_KEYWORDS)
    if has_problem:
        return True, found_zhk
    return False, ""


class LeadAnalyzer:
    """AI-–∞–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–∞–∑—ã –ó–Ω–∞–Ω–∏–π '–î—Ä—É–≥–∞-—ç–∫—Å–ø–µ—Ä—Ç–∞'"""

    def __init__(self):
        self.kb_path = "knowledge_base/sales/hunter_manual.md"

    async def analyze_post(self, text: str, source_name: str = "") -> dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç, —Å–≤–µ—Ä—è—è—Å—å —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–¥–∞–∂.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å –æ—Ü–µ–Ω–∫–æ–π (1-10) –∏ —Å—Ç–∞–¥–∏–µ–π –±–æ–ª–∏ (ST-1‚Ä¶ST-4).

        –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç—Å–µ–∏–≤–∞–µ—Ç –ª–∏–¥—ã –∏–∑ —Ä–µ–≥–∏–æ–Ω–æ–≤, –∫—Ä–æ–º–µ –ú–æ—Å–∫–≤—ã –∏ –ú–û.
        
        –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî
        –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ST-4 –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
        """
        if text is None:
            text = ""
        text = (text or "").strip()

        if len(text) < 10:
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False}
        
        # ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –ü–û –î–õ–ò–ù–ï: –°—Ç–∞—Ç—å–∏ (> 500 —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî —ç—Ç–æ –Ω–µ –ª–∏–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if len(text) > 500:
            logger.debug(f"üö´ –§–∏–ª—å—Ç—Ä –¥–ª–∏–Ω—ã: —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ (—ç—Ç–æ —Å—Ç–∞—Ç—å—è, –Ω–µ –ª–∏–¥)")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "length_filtered": True}
        
        # ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –ü–û –¢–ò–ü–£ –ö–û–ù–¢–ï–ù–¢–ê: –¢–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–º–æ—â–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        QUESTION_KEYWORDS = [
            "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ", "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ", "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
            "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å", "–∫–∞–∫–∞—è —Ü–µ–Ω–∞",
            "–º–æ–∂–Ω–æ –ª–∏", "–º–æ–∂–Ω–æ", "–º–æ–∂–Ω–æ?", "–º–æ–∂–Ω–æ?",
            "–∫–∞–∫", "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å", "–∫–∞–∫ —É–∑–∞–∫–æ–Ω–∏—Ç—å", "–∫–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å",
            "–≥–¥–µ", "–≥–¥–µ –∑–∞–∫–∞–∑–∞—Ç—å", "–≥–¥–µ —Å–¥–µ–ª–∞—Ç—å", "–≥–¥–µ –∫—É–ø–∏—Ç—å",
            "–∫—Ç–æ", "–∫—Ç–æ –¥–µ–ª–∞–ª", "–∫—Ç–æ –¥–µ–ª–∞–ª –ø—Ä–æ–µ–∫—Ç", "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
            "—á—Ç–æ", "—á—Ç–æ –Ω—É–∂–Ω–æ", "—á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è", "—á—Ç–æ –¥–µ–ª–∞—Ç—å",
            "?", "?", "?",  # –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏
        ]
        
        text_lower = text.lower()
        has_question_mark = "?" in text
        has_question_keywords = any(keyword in text_lower for keyword in QUESTION_KEYWORDS)
        
        if not (has_question_mark or has_question_keywords):
            logger.debug("üö´ –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–º–æ—â–∏ ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "content_type_filtered": True}
        
        # –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç—Å–µ–∏–≤–∞–µ–º –ª–∏–¥—ã –Ω–µ –∏–∑ –ú–æ—Å–∫–≤—ã/–ú–û
        if not _is_moscow_geo(text, source_name):
            logger.debug("üö´ –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä: –ø–æ—Å—Ç –Ω–µ –∏–∑ –ú–æ—Å–∫–≤—ã/–ú–û ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "geo_filtered": True}

        result = {}

        # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TRIGGER WORDS (–≥–æ—Ä—è—á–∏–µ —Ñ—Ä–∞–∑—ã) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        found_triggers = [trigger for trigger in TRIGGER_WORDS if trigger in text_lower]
        if found_triggers:
            logger.info(f"üî• Trigger words –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã: {found_triggers} ‚Üí –ì–û–†–Ø–ß–ò–ô –õ–ò–î")
            result.update({
                "priority_score": 8,
                "pain_stage": "ST-3",  # –í—ã—Å–æ–∫–∞—è —Å—Ç–∞–¥–∏—è –±–æ–ª–∏
                "is_lead": True,
                "trigger_words": found_triggers,
                "justification": f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã: {', '.join(found_triggers)}",
            })

        # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ñ–ö (–¥–ª—è –ø–æ–º–µ—Ç–∫–∏ ‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        found_zhk = next((zhk for zhk in PRIORITY_ZHK if zhk in text_lower), None)
        if found_zhk:
            result["is_priority_zhk"] = True
            result["zhk_name"] = found_zhk
            result["priority_marker"] = "‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô"
            logger.info(f"‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω: {found_zhk}")

        # ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        is_zhk_hot, zhk_name = _detect_priority_zhk_hot(text)
        if is_zhk_hot:
            logger.info(
                "üö® –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ñ–ö '%s' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –ì–û–†–Ø–ß–ò–ô –õ–ò–î ST-4",
                zhk_name,
            )
            return {
                "priority_score": 9,
                "pain_stage": "ST-4",
                "is_lead": True,
                "justification": f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{zhk_name}' —É–ø–æ–º—è–Ω—É—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∞–≤–æ–≤—ã—Ö/—Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º",
                "zhk_name": zhk_name,
                "is_priority_zhk": True,
                "priority_marker": "‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô",
            }
        
        # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç trigger words ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        if result.get("is_lead"):
            return result

        logger.info("üß† LeadAnalyzer: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π...")

        # ‚îÄ‚îÄ –ß–∏—Ç–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        manual = ""
        if os.path.exists(self.kb_path):
            with open(self.kb_path, "r", encoding="utf-8") as f:
                manual = f.read()

        priority_zhk_hint = (
            "–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑ –ñ–ö ‚Äî "
            "–ó–∏–ª–∞—Ä—Ç, –°–∏–º–≤–æ–ª, –°–µ—Ä–¥—Ü–µ –°—Ç–æ–ª–∏—Ü—ã, –î–∏–Ω–∞—Å—Ç–∏—è, –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ ‚Äî "
            "–∏ —Ä–µ—á—å –∏–¥—ë—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–∫–æ–Ω–æ–º, —Ä–µ–º–æ–Ω—Ç–æ–º –∏–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ–º, "
            "–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–π pain_stage ST-4 –∏ priority_score –Ω–µ –Ω–∏–∂–µ 8."
        )

        prompt = f"""
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏: {manual}

        {priority_zhk_hint}

        –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: "{text}"

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –µ–≥–æ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10 –∏ –ø—Ä–∏—Å–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±–æ–ª–∏:
        - ST-1 (–ò–Ω—Ñ–æ): –ü—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ç–µ–æ—Ä–∏–µ–π.
        - ST-2 (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ): –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç, –∏—â–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã.
        - ST-3 (–ê–∫—Ç–∏–≤): –£–∂–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç, –±–æ–∏—Ç—Å—è —à—Ç—Ä–∞—Ñ–æ–≤.
        - ST-4 (–ö—Ä–∏—Ç–∏—á–Ω–æ): –ü–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏—à–ª–∞ –∏–Ω—Å–ø–µ–∫—Ü–∏—è, —Å—É–¥, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–¥–µ–ª–∫–∏.

        –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
        {{
            "priority_score": —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10,
            "pain_stage": "ST-1" | "ST-2" | "ST-3" | "ST-4",
            "justification": "–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ —Å—Ç–∞–¥–∏—è"
        }}
        """

        try:
            response = await router_ai.generate_response(prompt)
            if response is None or not str(response).strip():
                raise ValueError("Router AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")

            import json
            match = re.search(r"\{.*\}", response, re.DOTALL)
            if not match:
                raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ: {response}")

            data = json.loads(match.group(0))
            data["is_lead"] = data.get("priority_score", 0) >= 5

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ò–ò –Ω–µ –∑–∞–º–µ—Ç–∏–ª –ñ–ö, –Ω–æ –æ–Ω –µ—Å—Ç—å ‚Äî –ø–æ–≤—ã—à–∞–µ–º
            t_lower = text.lower()
            found_zhk_after = next((zhk for zhk in PRIORITY_ZHK if zhk in t_lower), None)
            if found_zhk_after and not data["is_lead"]:
                has_problem = any(kw in t_lower for kw in ZHK_PROBLEM_KEYWORDS)
                if has_problem:
                    data["priority_score"] = max(data.get("priority_score", 0), 8)
                    data["pain_stage"] = "ST-4"
                    data["is_lead"] = True
                    data["zhk_name"] = found_zhk_after
                    data["justification"] = (
                        data.get("justification", "")
                        + f" [–ü–æ–≤—ã—à–µ–Ω–æ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{found_zhk_after}']"
                    )

            logger.info("üéØ –û—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞: %s", data)
            return data

        except Exception as e:
            logger.error("‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: %s", e)
            # ‚îÄ‚îÄ Fallback: —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            t_lower = text.lower() if text else ""

            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è –ò–ò)
            is_zhk_hot_fb, zhk_name_fb = _detect_priority_zhk_hot(text)
            if is_zhk_hot_fb:
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": f"Fallback: –ñ–ö '{zhk_name_fb}' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
                    "zhk_name": zhk_name_fb,
                }

            triggers_critical = ["–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ", "—Å—É–¥", "–∏–Ω—Å–ø–µ–∫—Ü–∏—è", "–º–∂–∏", "—à—Ç—Ä–∞—Ñ"]
            if any(word in t_lower for word in triggers_critical):
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            triggers_med = ["–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞", "—É–∑–∞–∫–æ–Ω–∏—Ç—å", "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏"]
            if any(word in t_lower for word in triggers_med):
                return {
                    "priority_score": 7,
                    "pain_stage": "ST-3",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            return {
                "priority_score": 1,
                "pain_stage": "ST-1",
                "is_lead": False,
                "justification": "Fallback: –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
            }
