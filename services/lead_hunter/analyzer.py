import logging
import os
from utils import router_ai

logger = logging.getLogger(__name__)

class LeadAnalyzer:
    """AI-–∞–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–∞–∑—ã –ó–Ω–∞–Ω–∏–π '–î—Ä—É–≥–∞-—ç–∫—Å–ø–µ—Ä—Ç–∞'"""
    
    def __init__(self):
        self.kb_path = "knowledge_base/sales/hunter_manual.md"
        
    async def analyze_post(self, text: str) -> float:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç, —Å–≤–µ—Ä—è—è—Å—å —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–¥–∞–∂.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ü–µ–Ω–∫—É –æ—Ç 0 –¥–æ 1.
        """
        logger.info("üß† LeadAnalyzer: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π...")
        
        # 1. –ß–∏—Ç–∞–µ–º –≤–∞—à–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
        manual = ""
        if os.path.exists(self.kb_path):
            with open(self.kb_path, 'r', encoding='utf-8') as f:
                manual = f.read()
        
        # 2. –ï—Å–ª–∏ –ø–æ—Å—Ç —Å–æ–≤—Å–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –ø—É—Å—Ç–æ–π
        if len(text) < 10:
            return 0.0

        # 3. –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ê–Ω—Ç–æ–Ω—É (–ò–ò)
        prompt = f"""
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏: {manual}
        
        –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: "{text}"
        
        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        1. –û—Ü–µ–Ω–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 0.0 –¥–æ 1.0, –Ω–∞—Å–∫–æ–ª—å–∫–æ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Ü–µ–ª–µ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º (–ª–∏–¥–æ–º).
        2. –¶–µ–ª–µ–≤–æ–π –∑–∞–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –≤–æ–ø—Ä–æ—Å—ã –ø—Ä–æ —Ä–µ–º–æ–Ω—Ç, –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –∏–ø–æ—Ç–µ–∫—É –≤ —É–∫–∞–∑–∞–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–∞—Ö.
        3. –û—Ç–≤–µ—Ç –¥–∞–π –û–î–ù–ò–ú –ß–ò–°–õ–û–ú.
        """
        
        try:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º router_ai (–∫–∞–∫ –≤ scout_agent.py)
            response = await router_ai.generate_response(prompt)
            score = float(response.strip())
            logger.info(f"üéØ –û—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞: {score}")
            return score
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: {e}")
            # Fallback: –µ—Å–ª–∏ –ò–ò —É–ø–∞–ª, –∏—â–µ–º –≤–∞—à–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –≤—Ä—É—á–Ω—É—é
            triggers = ["–º–æ–∫—Ä–∞—è —Ç–æ—á–∫–∞", "—É–∑–∞–∫–æ–Ω–∏—Ç—å", "—Ö–∏–º–∫–∏", "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫", "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤"]
            if any(word in text.lower() for word in triggers):
                return 0.8
            return 0.1
