import logging
import os
import re
from utils import router_ai

logger = logging.getLogger(__name__)

# =============================================================================
# –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö ‚Äî ¬´–û—Ç–∫—Ä—ã—Ç–∞—è –æ—Ö–æ—Ç–∞¬ª
# –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –ñ–ö –ò —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
# (–∑–∞–∫–æ–Ω, —à—Ç—Ä–∞—Ñ, —Ä–µ–º–æ–Ω—Ç, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ) ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≥–æ—Ä—è—á–∏–π –ª–∏–¥ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
# =============================================================================

# =============================================================================
# –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö (9 –ñ–ö –∏–∑ –¢–ó)
# –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –ñ–ö ‚Äî –ª–∏–¥ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ ‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô
# =============================================================================
PRIORITY_ZHK = [
    "–∑–∏–ª–∞—Ä—Ç",
    "—Å–∏–º–≤–æ–ª",
    "—Å–µ—Ä–¥—Ü–µ —Å—Ç–æ–ª–∏—Ü—ã",
    "–¥–∏–Ω–∞—Å—Ç–∏—è",
    "–ø—Ä–µ—Å–Ω—è —Å–∏—Ç–∏",
    "–Ω–µ–∫—Ä–∞—Å–æ–≤–∫–∞",
    "–ª—é–±–ª–∏–Ω—Å–∫–∏–π –ø–∞—Ä–∫",
    "—Ñ–∏–ª–∏ –≥—Ä–∞–¥",
    "–≤–æ–ª–∂—Å–∫–∏–π –ø–∞—Ä–∫",
    "—Å–∞–ª–∞—Ä—å–µ–≤–æ",
    "–º–∏—Ç–∏–Ω–æ",
    "—Å–∫–æ–ª–∫–æ–≤–æ",
    "–±—Ä–∞—Ç–µ–µ–≤–æ",
]

# =============================================================================
# TRIGGER WORDS ‚Äî –ö–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤
# –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –µ—Å—Ç—å —ç—Ç–∏ —Ñ—Ä–∞–∑—ã ‚Äî –ª–∏–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –≥–æ—Ä—è—á–∏–π
# =============================================================================
TRIGGER_WORDS = [
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    "–º–æ–∂–Ω–æ –ª–∏ —Å–Ω–æ—Å–∏—Ç—å",
    "–º–æ–∂–Ω–æ —Å–Ω–æ—Å–∏—Ç—å",
    "–≥–¥–µ –∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç",
    "–∑–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "—à—Ç—Ä–∞—Ñ –±—Ç–∏",
    "—à—Ç—Ä–∞—Ñ –æ—Ç –±—Ç–∏",
    "–∫—Ä–∞—Å–Ω—ã–µ –ª–∏–Ω–∏–∏",
    "–∫—Ä–∞—Å–Ω–∞—è –ª–∏–Ω–∏—è",
    "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫—É—Ö–Ω–∏",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫—É—Ö–Ω—é",
    "–ø–µ—Ä–µ–Ω–æ—Å –º–æ–∫—Ä–æ–π –∑–æ–Ω—ã",
    "–ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –º–æ–∫—Ä—É—é –∑–æ–Ω—É",
    "—Å–Ω–æ—Å —Å—Ç–µ–Ω—ã",
    "—Å–Ω–æ—Å–∏—Ç—å —Å—Ç–µ–Ω—É",
    "—É–∑–∞–∫–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "–∫–∞–∫ —É–∑–∞–∫–æ–Ω–∏—Ç—å",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "–Ω—É–∂–µ–Ω –ø—Ä–æ–µ–∫—Ç",
    "–∫—Ç–æ –¥–µ–ª–∞–ª –ø—Ä–æ–µ–∫—Ç",
    "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
    # –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–µ–∞–ª—å–Ω—ã—Ö –ª–∏–¥–æ–≤
    "–Ω—É–∂–µ–Ω –ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "—É–∑–∞–∫–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É –≤ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–µ",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫—É—Ö–Ω—é –∏ –∫–æ–º–Ω–∞—Ç—É",
    "–ø–µ—Ä–µ–Ω–æ—Å –º–æ–∫—Ä–æ–π –∑–æ–Ω—ã",
    "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "—É–∑–∞–∫–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É –±–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞",
    "—Å–¥–µ–ª–∞–ª–∏ –ø—Ä–æ–µ–º –≤ –Ω–µ—Å—É—â–µ–π —Å—Ç–µ–Ω–µ",
    "–Ω–µ—Å—É—â–∞—è —Å—Ç–µ–Ω–∞",
    "–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤—â–∏–∫",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "–∂–∏–ª–∏—â–Ω–∞—è –∏–Ω—Å–ø–µ–∫—Ü–∏—è",
    "—Å–º–µ–∂–Ω–∞—è —Å—Ç–µ–Ω–∞",
    "–ø—Ä–æ–µ–∫—Ç–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è",
    "–∞–∫—Ç—ã —Å–∫—Ä—ã—Ç—ã—Ö —Ä–∞–±–æ—Ç",
    "–∫ –∫–æ–º—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è",
    "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç",
    "—Å–¥–µ–ª–∞–µ—Ç–µ",
    "–¥–µ–ª–∞–ª–∏ –ª–∏ –∫—Ç–æ-—Ç–æ",
    "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é",
    "–µ—Å—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç",
    "–∏—â—É –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è",
    "–≥–æ—Ç–æ–≤ –∑–∞–ø–ª–∞—Ç–∏—Ç—å",
    "—Å—Ä–æ—á–Ω–æ",
]

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã: –ø—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–µ–º–æ–Ω—Ç/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
ZHK_PROBLEM_KEYWORDS = [
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏",
    "—É–∑–∞–∫–æ–Ω–∏",
    "–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ",
    "–º–∂–∏",
    "—à—Ç—Ä–∞—Ñ",
    "–∏–Ω—Å–ø–µ–∫—Ü–∏—è",
    "—Å—É–¥",
    "–ø—Ä–æ–µ–∫—Ç",
    "—Å–Ω–æ—Å —Å—Ç–µ–Ω",
    "—Å–Ω–µ—Å—Ç–∏ —Å—Ç–µ–Ω—É",
    "–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å",
    "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
    "—Å–∞–Ω—É–∑–µ–ª",
    "–±—Ç–∏",
    "–∞–∫—Ç —Å–∫—Ä—ã—Ç—ã—Ö",
    "—Å—Ä–æ",
    "–ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
    "—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
    "–∫—Ç–æ –¥–µ–ª–∞–ª",
    "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
    "–ø–æ–º–æ–≥–∏—Ç–µ",
    "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ",
    "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å",
]


# –ì–µ–æ-–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (—Ç–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞ –∏ –ú–û)
GEO_MOSCOW_MARKERS = [
    "–º–æ—Å–∫–≤–∞", "–º–æ—Å–∫–æ–≤—Å–∫", "–º—Å–∫", "–º–∫–¥", "–º–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å", "–º–æ",
    "—Ö–∏–º–∫–∏", "–∫—Ä–∞—Å–Ω–æ–≥–æ—Ä—Å–∫", "–º—ã—Ç–∏—â–∏", "–±–∞–ª–∞—à–∏—Ö–∞", "–ª—é–±–µ—Ä—Ü—ã",
    "–ø–æ–¥–º–æ—Å–∫–æ–≤—å–µ", "–Ω–æ–≤–∞—è –º–æ—Å–∫–≤–∞", "–Ω–∞–æ", "–∑–∞–æ", "—Å–∞–æ", "—Å–≤–∞–æ", "–≤–∞–æ", "—é–≤–∞–æ", "—é–∞–æ", "—Å–∑–∞–æ", "—Ü–∞–æ",
    "—é–≥–æ-–≤–æ—Å—Ç–æ–∫", "—é–≥–æ-–∑–∞–ø–∞–¥", "—Å–µ–≤–µ—Ä–æ-–≤–æ—Å—Ç–æ–∫", "—Å–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥",
]


def _is_moscow_geo(text: str, source_name: str = "") -> bool:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ—Ç–Ω–æ—Å–∏—Ç—Å—è –ª–∏ –ø–æ—Å—Ç –∫ –ú–æ—Å–∫–≤–µ –∏–ª–∏ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏.
    –§–∏–ª—å—Ç—Ä—É–µ—Ç –ª–∏–¥—ã –∏–∑ –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤.
    
    Returns:
        True –µ—Å–ª–∏ –≥–µ–æ = –ú–æ—Å–∫–≤–∞/–ú–û, False –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π —Ä–µ–≥–∏–æ–Ω
    """
    if not text and not source_name:
        return True  # –ï—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º)
    
    combined = f"{text} {source_name}".lower()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –ú–æ—Å–∫–≤—ã/–ú–û
    has_moscow = any(marker in combined for marker in GEO_MOSCOW_MARKERS)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥—Ä—É–≥–∏—Ö —Ä–µ–≥–∏–æ–Ω–æ–≤ (–æ—Ç—Å–µ–∏–≤–∞–µ–º)
    other_regions = [
        "—Å–∞–Ω–∫—Ç-–ø–µ—Ç–µ—Ä–±—É—Ä–≥", "—Å–ø–±", "–ø–∏—Ç–µ—Ä", "–ª–µ–Ω–∏–Ω–≥—Ä–∞–¥",
        "–∫–∞–∑–∞–Ω—å", "–Ω–∏–∂–Ω–∏–π –Ω–æ–≤–≥–æ—Ä–æ–¥", "–µ–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥", "–Ω–æ–≤–æ—Å–∏–±–∏—Ä—Å–∫",
        "—Ä–æ—Å—Ç–æ–≤", "–∫—Ä–∞—Å–Ω–æ–¥–∞—Ä", "—Å–æ—á–∏", "–∫—Ä—ã–º",
    ]
    has_other_region = any(region in combined for region in other_regions)
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –¥—Ä—É–≥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ –ò –Ω–µ—Ç –º–∞—Ä–∫–µ—Ä–∞ –ú–æ—Å–∫–≤—ã ‚Äî –æ—Ç—Å–µ–∏–≤–∞–µ–º
    if has_other_region and not has_moscow:
        return False
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Ä–∫–µ—Ä –ú–æ—Å–∫–≤—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if has_moscow:
        return True
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —è–≤–Ω—ã—Ö –º–∞—Ä–∫–µ—Ä–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º (–Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Å—Ç—Ä–æ–≥–æ)
    return True


def _detect_priority_zhk_hot(text: str) -> tuple[bool, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (True, –Ω–∞–∑–≤–∞–Ω–∏–µ_–∂–∫) –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö
    –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –ò–ò ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    –∫–∞–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –≥–æ—Ä—è—á–µ–≥–æ –ª–∏–¥–∞.
    """
    if not text:
        return False, ""
    t = text.lower()
    found_zhk = next((zhk for zhk in PRIORITY_ZHK if zhk in t), None)
    if not found_zhk:
        return False, ""
    has_problem = any(kw in t for kw in ZHK_PROBLEM_KEYWORDS)
    if has_problem:
        return True, found_zhk
    return False, ""


class LeadAnalyzer:
    """AI-–∞–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–∞–∑—ã –ó–Ω–∞–Ω–∏–π '–î—Ä—É–≥–∞-—ç–∫—Å–ø–µ—Ä—Ç–∞'"""

    def __init__(self):
        self.kb_path = "knowledge_base/sales/hunter_manual.md"

    async def analyze_post(self, text: str, source_name: str = "") -> dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç, —Å–≤–µ—Ä—è—è—Å—å —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–¥–∞–∂.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å –æ—Ü–µ–Ω–∫–æ–π (1-10) –∏ —Å—Ç–∞–¥–∏–µ–π –±–æ–ª–∏ (ST-1‚Ä¶ST-4).

        –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç—Å–µ–∏–≤–∞–µ—Ç –ª–∏–¥—ã –∏–∑ —Ä–µ–≥–∏–æ–Ω–æ–≤, –∫—Ä–æ–º–µ –ú–æ—Å–∫–≤—ã –∏ –ú–û.
        
        –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî
        –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ST-4 –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
        """
        if text is None:
            text = ""
        text = (text or "").strip()

        if len(text) < 10:
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False}
        
        # ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –ü–û –î–õ–ò–ù–ï: –°—Ç–∞—Ç—å–∏ (> 500 —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî —ç—Ç–æ –Ω–µ –ª–∏–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if len(text) > 500:
            logger.debug(f"üö´ –§–∏–ª—å—Ç—Ä –¥–ª–∏–Ω—ã: —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ ({len(text)} —Å–∏–º–≤–æ–ª–æ–≤) ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ (—ç—Ç–æ —Å—Ç–∞—Ç—å—è, –Ω–µ –ª–∏–¥)")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "length_filtered": True}
        
        # ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –°–ü–ê–ú–ê –ò –†–ï–ö–õ–ê–ú–´: –û—Ç—Å–µ–∏–≤–∞–µ–º —Ä–µ–∫–ª–∞–º—É –¥—Ä—É–≥–∏—Ö –±—Ä–∏–≥–∞–¥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        spam_patterns = [
            r"\+?\d{10,}",  # –ù–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ (10+ —Ü–∏—Ñ—Ä)
            r"–∑–≤–æ–Ω–∏—Ç–µ|–∑–≤–æ–Ω.*—Ç–µ|—Ç–µ–ª\.|—Ç–µ–ª–µ—Ñ–æ–Ω",  # –ü—Ä–∏–∑—ã–≤—ã –∑–≤–æ–Ω–∏—Ç—å
            r"–ø–∏—à–∏—Ç–µ –≤ –ª—Å|–Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ª—Å|–≤ –ª–∏—á–∫—É|–≤ –¥–∏—Ä–µ–∫—Ç",  # –ü—Ä–∏–∑—ã–≤—ã –ø–∏—Å–∞—Ç—å –≤ –õ–°
            r"–Ω–∞—à–∞ –±—Ä–∏–≥–∞–¥–∞|–Ω–∞—à–∞ –∫–æ–º–∞–Ω–¥–∞|–º—ã –¥–µ–ª–∞–µ–º|–º—ã –≤—ã–ø–æ–ª–Ω—è–µ–º",  # –†–µ–∫–ª–∞–º–∞ —É—Å–ª—É–≥
            r"–ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ|–ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç|—Å–º–æ—Ç—Ä–∏—Ç–µ —Ä–∞–±–æ—Ç—ã",  # –°—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ
            r"–¥–ª—è —Å–º–µ—Ç—ã|–¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏|–¥–ª—è —Ä–∞—Å—á–µ—Ç–∞",  # –ü—Ä–∏–∑—ã–≤—ã –∫ –¥–µ–π—Å—Ç–≤–∏—é –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞
        ]
        
        text_lower = text.lower()
        is_spam = False
        for pattern in spam_patterns:
            if re.search(pattern, text_lower):
                is_spam = True
                logger.debug(f"üö´ –§–∏–ª—å—Ç—Ä —Å–ø–∞–º–∞: –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω '{pattern}' ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ")
                break
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        text_without_emoji = re.sub(r'[^\w\s]', '', text_lower).strip()
        if len(text_without_emoji) < 10 and not any(kw in text_lower for kw in ["–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω", "—É–∑–∞–∫–æ–Ω–∏", "–±—Ç–∏", "–º–∂–∏"]):
            is_spam = True
            logger.debug("üö´ –§–∏–ª—å—Ç—Ä —Å–ø–∞–º–∞: —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ —ç–º–æ–¥–∑–∏/–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ")
        
        if is_spam:
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "spam_filtered": True}
        
        # ‚îÄ‚îÄ –§–ò–õ–¨–¢–† –ü–û –¢–ò–ü–£ –ö–û–ù–¢–ï–ù–¢–ê: –¢–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å—ã –∏ –∑–∞–ø—Ä–æ—Å—ã –ø–æ–º–æ—â–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        QUESTION_KEYWORDS = [
            "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ", "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ", "–ø–æ–¥—Å–∫–∞–∂–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞",
            "—Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Å–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å", "–∫–∞–∫–∞—è —Ü–µ–Ω–∞",
            "–º–æ–∂–Ω–æ –ª–∏", "–º–æ–∂–Ω–æ", "–º–æ–∂–Ω–æ?", "–º–æ–∂–Ω–æ?",
            "–∫–∞–∫", "–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å", "–∫–∞–∫ —É–∑–∞–∫–æ–Ω–∏—Ç—å", "–∫–∞–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å",
            "–≥–¥–µ", "–≥–¥–µ –∑–∞–∫–∞–∑–∞—Ç—å", "–≥–¥–µ —Å–¥–µ–ª–∞—Ç—å", "–≥–¥–µ –∫—É–ø–∏—Ç—å",
            "–∫—Ç–æ", "–∫—Ç–æ –¥–µ–ª–∞–ª", "–∫—Ç–æ –¥–µ–ª–∞–ª –ø—Ä–æ–µ–∫—Ç", "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
            "—á—Ç–æ", "—á—Ç–æ –Ω—É–∂–Ω–æ", "—á—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è", "—á—Ç–æ –¥–µ–ª–∞—Ç—å",
            "?", "?", "?",  # –í–æ–ø—Ä–æ—Å–∏—Ç–µ–ª—å–Ω—ã–µ –∑–Ω–∞–∫–∏
        ]
        
        has_question_mark = "?" in text
        has_question_keywords = any(keyword in text_lower for keyword in QUESTION_KEYWORDS)
        
        if not (has_question_mark or has_question_keywords):
            logger.debug("üö´ –§–∏–ª—å—Ç—Ä —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–º–æ—â–∏ ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–æ")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "content_type_filtered": True}
        
        # ‚îÄ‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –ñ–ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –ï—Å–ª–∏ –∏—Å—Ç–æ—á–Ω–∏–∫ ‚Äî –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö –∏–∑ –ë–î (is_high_priority), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–µ–æ-—Ñ–∏–ª—å—Ç—Ä
        is_priority_zhk_source = False
        if source_name:
            source_lower = source_name.lower()
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö
            for zhk in PRIORITY_ZHK:
                if zhk in source_lower:
                    is_priority_zhk_source = True
                    logger.debug(f"‚≠ê –ò—Å—Ç–æ—á–Ω–∏–∫ —è–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–º –ñ–ö: {source_name}")
                    break
        
        # –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è: –æ—Ç—Å–µ–∏–≤–∞–µ–º –ª–∏–¥—ã –Ω–µ –∏–∑ –ú–æ—Å–∫–≤—ã/–ú–û (–∫—Ä–æ–º–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ñ–ö)
        if not is_priority_zhk_source and not _is_moscow_geo(text, source_name):
            logger.debug("üö´ –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä: –ø–æ—Å—Ç –Ω–µ –∏–∑ –ú–æ—Å–∫–≤—ã/–ú–û –∏ –Ω–µ –∏–∑ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –ñ–ö ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω")
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False, "geo_filtered": True}

        result = {}

        # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TRIGGER WORDS (–≥–æ—Ä—è—á–∏–µ —Ñ—Ä–∞–∑—ã) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        found_triggers = [trigger for trigger in TRIGGER_WORDS if trigger in text_lower]
        
        # ‚îÄ‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê: –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π boost –¥–ª—è core-—Ç–µ—Ä–º–∏–Ω–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ
        PRIORITY_KEYWORDS = {
            "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫": 2,  # +2 –∫ priority_score
            "—É–∑–∞–∫–æ–Ω–∏": 2,        # +2 –∫ priority_score
            "–±—Ç–∏": 2,            # +2 –∫ priority_score
            "–ø—Ä–æ–µ–∫—Ç –ø—Ä–æ–µ–º–∞": 2,  # +2 –∫ priority_score
            "–ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏": 2,  # +2 –∫ priority_score
        }
        
        keyword_boost = 0
        found_priority_keywords = []
        for keyword, boost in PRIORITY_KEYWORDS.items():
            if keyword in text_lower:
                keyword_boost += boost
                found_priority_keywords.append(keyword)
        
        if found_triggers:
            base_score = 8
            # –ü—Ä–∏–º–µ–Ω—è–µ–º boost –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
            final_score = min(10, base_score + keyword_boost)
            logger.info(f"üî• Trigger words –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã: {found_triggers} ‚Üí –ì–û–†–Ø–ß–ò–ô –õ–ò–î (score: {final_score}, boost: +{keyword_boost} –æ—Ç {found_priority_keywords})")
            result.update({
                "priority_score": final_score,
                "pain_stage": "ST-3",  # –í—ã—Å–æ–∫–∞—è —Å—Ç–∞–¥–∏—è –±–æ–ª–∏
                "is_lead": True,
                "trigger_words": found_triggers,
                "priority_keywords": found_priority_keywords,
                "keyword_boost": keyword_boost,
                "justification": f"–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã: {', '.join(found_triggers)}" + (f" + boost –æ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö —Å–ª–æ–≤: {', '.join(found_priority_keywords)}" if found_priority_keywords else ""),
            })

        # ‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ñ–ö (–¥–ª—è –ø–æ–º–µ—Ç–∫–∏ ‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        found_zhk = next((zhk for zhk in PRIORITY_ZHK if zhk in text_lower), None)
        if found_zhk:
            result["is_priority_zhk"] = True
            result["zhk_name"] = found_zhk
            result["priority_marker"] = "‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô"
            logger.info(f"‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö –æ–±–Ω–∞—Ä—É–∂–µ–Ω: {found_zhk}")

        # ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        is_zhk_hot, zhk_name = _detect_priority_zhk_hot(text)
        if is_zhk_hot:
            logger.info(
                "üö® –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ñ–ö '%s' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –ì–û–†–Ø–ß–ò–ô –õ–ò–î ST-4",
                zhk_name,
            )
            return {
                "priority_score": 9,
                "pain_stage": "ST-4",
                "is_lead": True,
                "justification": f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{zhk_name}' —É–ø–æ–º—è–Ω—É—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∞–≤–æ–≤—ã—Ö/—Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º",
                "zhk_name": zhk_name,
                "is_priority_zhk": True,
                "priority_marker": "‚≠ê –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ô",
            }
        
        # –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –æ—Ç trigger words ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –µ–≥–æ
        if result.get("is_lead"):
            return result

        logger.info("üß† LeadAnalyzer: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π...")

        # ‚îÄ‚îÄ –ß–∏—Ç–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        manual = ""
        if os.path.exists(self.kb_path):
            with open(self.kb_path, "r", encoding="utf-8") as f:
                manual = f.read()

        priority_zhk_hint = (
            "–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑ –ñ–ö ‚Äî "
            "–ó–∏–ª–∞—Ä—Ç, –°–∏–º–≤–æ–ª, –°–µ—Ä–¥—Ü–µ –°—Ç–æ–ª–∏—Ü—ã, –î–∏–Ω–∞—Å—Ç–∏—è, –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ ‚Äî "
            "–∏ —Ä–µ—á—å –∏–¥—ë—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–∫–æ–Ω–æ–º, —Ä–µ–º–æ–Ω—Ç–æ–º –∏–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ–º, "
            "–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–π pain_stage ST-4 –∏ priority_score –Ω–µ –Ω–∏–∂–µ 8."
        )

        prompt = f"""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ª–∏–¥–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ TERION (—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ –≤ –ú–æ—Å–∫–≤–µ).

–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏: {manual}

{priority_zhk_hint}

–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: "{text}"

–ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚Äî –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –°–ü–ê–ú–ê –ò –†–ï–ö–õ–ê–ú–´:
1. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —è–≤–Ω—É—é —Ä–µ–∫–ª–∞–º—É —É—Å–ª—É–≥ (–Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞ —Ä–µ–º–æ–Ω—Ç–∞, —Å—Å—ã–ª–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ, –ø—Ä–∏–∑—ã–≤—ã "–ø–∏—à–∏—Ç–µ –≤ –õ–° –¥–ª—è —Å–º–µ—Ç—ã", "–∑–≤–æ–Ω–∏—Ç–µ –¥–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏", "–Ω–∞—à–∞ –±—Ä–∏–≥–∞–¥–∞"), –ø—Ä–∏—Å–≤–∞–∏–≤–∞–π priority_score=0 –∏ –ø–æ–º–µ—á–∞–π –∫–∞–∫ SPAM (is_lead=false).
2. –ò–≥–Ω–æ—Ä–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–æ—Å—Ç–æ—è—â–∏–µ —Ç–æ–ª—å–∫–æ –∏–∑ —ç–º–æ–¥–∑–∏ –∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–π –±–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫.
3. –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∫–æ–Ω—Ç–∞–∫—Ç—ã (—Ç–µ–ª–µ—Ñ–æ–Ω, WhatsApp, Telegram) –±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞ –æ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ ‚Äî —ç—Ç–æ —Å–ø–∞–º (is_lead=false, priority_score=0).

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –µ–≥–æ –ø–æ —à–∫–∞–ª–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (1-10) –∏ —Å—Ç–∞–¥–∏–∏ –±–æ–ª–∏:

–°–¢–ê–î–ò–ò –ë–û–õ–ò:
- ST-1 (–ò–Ω—Ç–µ—Ä–µ—Å): –ü—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ç–µ–æ—Ä–∏–µ–π, –æ–±—â–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏. –ù–µ—Ç —Å—Ä–æ—á–Ω–æ—Å—Ç–∏.
- ST-2 (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ): –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç, –∏—â–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã, –∏–∑—É—á–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏. –ï—Å—Ç—å –≤—Ä–µ–º—è –Ω–∞ –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏—è.
- ST-3 (–ê–∫—Ç–∏–≤): –£–∂–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç, –±–æ–∏—Ç—Å—è —à—Ç—Ä–∞—Ñ–æ–≤, –Ω—É–∂–µ–Ω –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è. –ï—Å—Ç—å —Å—Ä–æ—á–Ω–æ—Å—Ç—å.
- ST-4 (–ö—Ä–∏—Ç–∏—á–Ω–æ): –ü–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ –ú–ñ–ò, –ø—Ä–∏—à–ª–∞ –∏–Ω—Å–ø–µ–∫—Ü–∏—è, —Å—É–¥, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–¥–µ–ª–∫–∏, —à—Ç—Ä–∞—Ñ –ë–¢–ò. –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –°–ò–¢–£–ê–¶–ò–Ø.

–ü–†–ò–û–†–ò–¢–ï–¢ (priority_score):
- 0: –°–ü–ê–ú/–†–ï–ö–õ–ê–ú–ê (–Ω–µ –ª–∏–¥)
- 1-3: –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (ST-1)
- 4-5: –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (ST-2)
- 6-7: –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (ST-3)
- 8-10: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (ST-4)

–í–ê–ñ–ù–û: –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ –≤–∞–ª–∏–¥–Ω–æ–≥–æ JSON, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞:
{{
    "priority_score": —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 10 (0 = —Å–ø–∞–º),
    "pain_stage": "ST-1" | "ST-2" | "ST-3" | "ST-4",
    "justification": "–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ —Å—Ç–∞–¥–∏—è",
    "is_lead": true –∏–ª–∏ false (false –¥–ª—è —Å–ø–∞–º–∞)
}}
"""

        try:
            response = await router_ai.generate_response(prompt)
            
            # ‚îÄ‚îÄ –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–ö–ò 401 (Unauthorized) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ response —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—à–∏–±–∫–µ 401
            if response is None:
                # Router AI –≤–µ—Ä–Ω—É–ª None - –≤–æ–∑–º–æ–∂–Ω–æ, –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ fallback –Ω–∞ Yandex
                logger.warning("‚ö†Ô∏è Router AI –≤–µ—Ä–Ω—É–ª None - –≤–æ–∑–º–æ–∂–Ω–æ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
                response = ""
            elif isinstance(response, str):
                response_upper = response.upper()
                if any(keyword in response_upper for keyword in ["401", "UNAUTHORIZED", "YANDEX_API_KEY", "AUTHENTICATION"]):
                    logger.error("=" * 60)
                    logger.error("‚ùå –û–®–ò–ë–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò YANDEX API (401 Unauthorized)")
                    logger.error("")
                    logger.error("üí° –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –û–±–Ω–æ–≤–∏—Ç–µ YANDEX_API_KEY –≤ .env")
                    logger.error("")
                    logger.error("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:")
                    logger.error("  1. YANDEX_API_KEY —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env")
                    logger.error("  2. –ö–ª—é—á –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∏ –Ω–µ –∏—Å—Ç–µ–∫")
                    logger.error("  3. FOLDER_ID —É–∫–∞–∑–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
                    logger.error("  4. –£ –∫–ª—é—á–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ YandexGPT API")
                    logger.error("=" * 60)
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤–º–µ—Å—Ç–æ –ø–∞–¥–µ–Ω–∏—è
                    return {
                        "priority_score": 3,
                        "pain_stage": "ST-1",
                        "is_lead": False,
                        "justification": "–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Yandex API - —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ YANDEX_API_KEY",
                        "error": "yandex_401"
                    }
            
            if not str(response).strip():
                raise ValueError("Router AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")

            import json
            # –ò—â–µ–º JSON –≤ –æ—Ç–≤–µ—Ç–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ–±—ë—Ä–Ω—É—Ç –≤ markdown –∏–ª–∏ —Ç–µ–∫—Å—Ç)
            match = re.search(r"\{[^{}]*\"priority_score\"[^{}]*\}", response, re.DOTALL)
            if not match:
                # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ª—é–±–æ–π JSON –æ–±—ä–µ–∫—Ç
                match = re.search(r"\{.*\}", response, re.DOTALL)
            
            if not match:
                logger.error(f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ Router AI: {response[:200]}")
                raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ: {response[:200]}")

            json_str = match.group(0)
            # –û—á–∏—â–∞–µ–º –æ—Ç markdown code blocks –µ—Å–ª–∏ –µ—Å—Ç—å
            json_str = re.sub(r"```json\s*", "", json_str)
            json_str = re.sub(r"```\s*", "", json_str)
            
            data = json.loads(json_str)
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
            priority_score = int(data.get("priority_score", 0))
            pain_stage = data.get("pain_stage", "ST-1")
            
            # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º priority_score –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 1-10
            priority_score = max(1, min(10, priority_score))
            
            # –í–∞–ª–∏–¥–∞—Ü–∏—è pain_stage
            if pain_stage not in ["ST-1", "ST-2", "ST-3", "ST-4"]:
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ priority_score –µ—Å–ª–∏ pain_stage –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
                if priority_score <= 3:
                    pain_stage = "ST-1"
                elif priority_score <= 5:
                    pain_stage = "ST-2"
                elif priority_score <= 7:
                    pain_stage = "ST-3"
                else:
                    pain_stage = "ST-4"
            
            # ‚îÄ‚îÄ –ü–†–ò–ú–ï–ù–Ø–ï–ú BOOST –û–¢ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–• –ö–õ–Æ–ß–ï–í–´–• –°–õ–û–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–µ
            PRIORITY_KEYWORDS = {
                "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫": 2,  # +2 –∫ priority_score
                "—É–∑–∞–∫–æ–Ω–∏": 2,        # +2 –∫ priority_score
                "–±—Ç–∏": 2,            # +2 –∫ priority_score
                "–ø—Ä–æ–µ–∫—Ç –ø—Ä–æ–µ–º–∞": 2,  # +2 –∫ priority_score
                "–ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏": 2,  # +2 –∫ priority_score
            }
            
            keyword_boost = 0
            found_priority_keywords = []
            t_lower = text.lower()
            for keyword, boost in PRIORITY_KEYWORDS.items():
                if keyword in t_lower:
                    keyword_boost += boost
                    found_priority_keywords.append(keyword)
            
            # –ü—Ä–∏–º–µ–Ω—è–µ–º boost –∫ priority_score (–º–∞–∫—Å–∏–º—É–º 10)
            priority_score_with_boost = min(10, priority_score + keyword_boost)
            
            if keyword_boost > 0:
                logger.info(f"üìà –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã: {found_priority_keywords} ‚Üí boost +{keyword_boost} (score: {priority_score} ‚Üí {priority_score_with_boost})")
            
            data.update({
                "priority_score": priority_score_with_boost,
                "pain_stage": pain_stage,
                "is_lead": data.get("is_lead", priority_score_with_boost >= 5),
                "priority_keywords": found_priority_keywords if keyword_boost > 0 else None,
                "keyword_boost": keyword_boost if keyword_boost > 0 else None,
            })

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ò–ò –Ω–µ –∑–∞–º–µ—Ç–∏–ª –ñ–ö, –Ω–æ –æ–Ω –µ—Å—Ç—å ‚Äî –ø–æ–≤—ã—à–∞–µ–º
            t_lower = text.lower()
            found_zhk_after = next((zhk for zhk in PRIORITY_ZHK if zhk in t_lower), None)
            if found_zhk_after and not data["is_lead"]:
                has_problem = any(kw in t_lower for kw in ZHK_PROBLEM_KEYWORDS)
                if has_problem:
                    data["priority_score"] = max(data.get("priority_score", 0), 8)
                    data["pain_stage"] = "ST-4"
                    data["is_lead"] = True
                    data["zhk_name"] = found_zhk_after
                    data["justification"] = (
                        data.get("justification", "")
                        + f" [–ü–æ–≤—ã—à–µ–Ω–æ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{found_zhk_after}']"
                    )

            logger.info("üéØ –û—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞: %s", data)
            return data

        except Exception as e:
            logger.error("‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: %s", e)
            # ‚îÄ‚îÄ Fallback: —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            t_lower = text.lower() if text else ""

            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è –ò–ò)
            is_zhk_hot_fb, zhk_name_fb = _detect_priority_zhk_hot(text)
            if is_zhk_hot_fb:
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": f"Fallback: –ñ–ö '{zhk_name_fb}' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
                    "zhk_name": zhk_name_fb,
                }

            triggers_critical = ["–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ", "—Å—É–¥", "–∏–Ω—Å–ø–µ–∫—Ü–∏—è", "–º–∂–∏", "—à—Ç—Ä–∞—Ñ"]
            if any(word in t_lower for word in triggers_critical):
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            triggers_med = ["–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞", "—É–∑–∞–∫–æ–Ω–∏—Ç—å", "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏"]
            if any(word in t_lower for word in triggers_med):
                return {
                    "priority_score": 7,
                    "pain_stage": "ST-3",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            return {
                "priority_score": 1,
                "pain_stage": "ST-1",
                "is_lead": False,
                "justification": "Fallback: –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
            }
