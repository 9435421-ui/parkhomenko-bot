import logging
import os
import re
from utils import router_ai

logger = logging.getLogger(__name__)

# =============================================================================
# –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ñ–ö ‚Äî ¬´–û—Ç–∫—Ä—ã—Ç–∞—è –æ—Ö–æ—Ç–∞¬ª
# –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç –ª—é–±–æ–π –∏–∑ —ç—Ç–∏—Ö –ñ–ö –ò —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
# (–∑–∞–∫–æ–Ω, —à—Ç—Ä–∞—Ñ, —Ä–µ–º–æ–Ω—Ç, —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ) ‚Äî –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≥–æ—Ä—è—á–∏–π –ª–∏–¥ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
# =============================================================================

PRIORITY_ZHK = [
    "–∑–∏–ª–∞—Ä—Ç",
    "—Å–∏–º–≤–æ–ª",
    "—Å–µ—Ä–¥—Ü–µ —Å—Ç–æ–ª–∏—Ü—ã",
    "–¥–∏–Ω–∞—Å—Ç–∏—è",
    "–ø—Ä–µ—Å–Ω—è —Å–∏—Ç–∏",
]

# –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ–±–ª–µ–º—ã: –ø—Ä–∞–≤–æ–≤—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ —Ä–µ–º–æ–Ω—Ç/–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞
ZHK_PROBLEM_KEYWORDS = [
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏",
    "—É–∑–∞–∫–æ–Ω–∏",
    "–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ",
    "–º–∂–∏",
    "—à—Ç—Ä–∞—Ñ",
    "–∏–Ω—Å–ø–µ–∫—Ü–∏—è",
    "—Å—É–¥",
    "–ø—Ä–æ–µ–∫—Ç",
    "—Å–Ω–æ—Å —Å—Ç–µ–Ω",
    "—Å–Ω–µ—Å—Ç–∏ —Å—Ç–µ–Ω—É",
    "–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞",
    "–æ–±—ä–µ–¥–∏–Ω–∏—Ç—å",
    "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ",
    "—Å–∞–Ω—É–∑–µ–ª",
    "–±—Ç–∏",
    "–∞–∫—Ç —Å–∫—Ä—ã—Ç—ã—Ö",
    "—Å—Ä–æ",
    "–ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ",
    "—Ä–µ–∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—è",
    "–∫—Ç–æ –¥–µ–ª–∞–ª",
    "–∫—Ç–æ —Å–æ–≥–ª–∞—Å–æ–≤—ã–≤–∞–ª",
    "–ø–æ–º–æ–≥–∏—Ç–µ",
    "–ø–æ—Å–æ–≤–µ—Ç—É–π—Ç–µ",
    "–∫–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å",
]


def _detect_priority_zhk_hot(text: str) -> tuple[bool, str]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (True, –Ω–∞–∑–≤–∞–Ω–∏–µ_–∂–∫) –µ—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö
    –≤–º–µ—Å—Ç–µ —Å –ø—Ä–æ–±–ª–µ–º–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑ –ò–ò ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
    –∫–∞–∫ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä –≥–æ—Ä—è—á–µ–≥–æ –ª–∏–¥–∞.
    """
    if not text:
        return False, ""
    t = text.lower()
    found_zhk = next((zhk for zhk in PRIORITY_ZHK if zhk in t), None)
    if not found_zhk:
        return False, ""
    has_problem = any(kw in t for kw in ZHK_PROBLEM_KEYWORDS)
    if has_problem:
        return True, found_zhk
    return False, ""


class LeadAnalyzer:
    """AI-–∞–Ω–∞–ª–∏–∑ –ø–æ—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ë–∞–∑—ã –ó–Ω–∞–Ω–∏–π '–î—Ä—É–≥–∞-—ç–∫—Å–ø–µ—Ä—Ç–∞'"""

    def __init__(self):
        self.kb_path = "knowledge_base/sales/hunter_manual.md"

    async def analyze_post(self, text: str) -> dict:
        """
        –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç, —Å–≤–µ—Ä—è—è—Å—å —Å –±–∞–∑–æ–π –∑–Ω–∞–Ω–∏–π –ø—Ä–æ–¥–∞–∂.
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å –æ—Ü–µ–Ω–∫–æ–π (1-10) –∏ —Å—Ç–∞–¥–∏–µ–π –±–æ–ª–∏ (ST-1‚Ä¶ST-4).

        –ë—ã—Å—Ç—Ä—ã–π –ø—É—Ç—å: –µ—Å–ª–∏ —É–ø–æ–º—è–Ω—É—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî
        –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º ST-4 –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è –ò–ò.
        """
        if text is None:
            text = ""
        text = (text or "").strip()

        if len(text) < 10:
            return {"priority_score": 0, "pain_stage": "ST-1", "is_lead": False}

        # ‚îÄ‚îÄ –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        is_zhk_hot, zhk_name = _detect_priority_zhk_hot(text)
        if is_zhk_hot:
            logger.info(
                "üö® –ë—ã—Å—Ç—Ä—ã–π —Ç—Ä–∏–≥–≥–µ—Ä: –ñ–ö '%s' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Üí –ì–û–†–Ø–ß–ò–ô –õ–ò–î ST-4",
                zhk_name,
            )
            return {
                "priority_score": 9,
                "pain_stage": "ST-4",
                "is_lead": True,
                "justification": f"–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{zhk_name}' —É–ø–æ–º—è–Ω—É—Ç –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –ø—Ä–∞–≤–æ–≤—ã—Ö/—Ä–µ–º–æ–Ω—Ç–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º",
                "zhk_name": zhk_name,
            }

        logger.info("üß† LeadAnalyzer: –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π...")

        # ‚îÄ‚îÄ –ß–∏—Ç–∞–µ–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        manual = ""
        if os.path.exists(self.kb_path):
            with open(self.kb_path, "r", encoding="utf-8") as f:
                manual = f.read()

        priority_zhk_hint = (
            "–û—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –µ—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –æ–¥–∏–Ω –∏–∑ –ñ–ö ‚Äî "
            "–ó–∏–ª–∞—Ä—Ç, –°–∏–º–≤–æ–ª, –°–µ—Ä–¥—Ü–µ –°—Ç–æ–ª–∏—Ü—ã, –î–∏–Ω–∞—Å—Ç–∏—è, –ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏ ‚Äî "
            "–∏ —Ä–µ—á—å –∏–¥—ë—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –∑–∞–∫–æ–Ω–æ–º, —Ä–µ–º–æ–Ω—Ç–æ–º –∏–ª–∏ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ–º, "
            "–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏—Å–≤–∞–∏–≤–∞–π pain_stage ST-4 –∏ priority_score –Ω–µ –Ω–∏–∂–µ 8."
        )

        prompt = f"""
        –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –æ—Ü–µ–Ω–∫–∏: {manual}

        {priority_zhk_hint}

        –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ —á–∞—Ç–∞: "{text}"

        –¢–≤–æ—è –∑–∞–¥–∞—á–∞:
        –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏—Ü–∏—Ä—É–π –µ–≥–æ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10 –∏ –ø—Ä–∏—Å–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é –±–æ–ª–∏:
        - ST-1 (–ò–Ω—Ñ–æ): –ü—Ä–æ—Å—Ç–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ç–µ–æ—Ä–∏–µ–π.
        - ST-2 (–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ): –°–æ–±–∏—Ä–∞–µ—Ç—Å—è –¥–µ–ª–∞—Ç—å —Ä–µ–º–æ–Ω—Ç, –∏—â–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç—ã.
        - ST-3 (–ê–∫—Ç–∏–≤): –£–∂–µ –¥–µ–ª–∞–µ—Ç —Ä–µ–º–æ–Ω—Ç, –±–æ–∏—Ç—Å—è —à—Ç—Ä–∞—Ñ–æ–≤.
        - ST-4 (–ö—Ä–∏—Ç–∏—á–Ω–æ): –ü–æ–ª—É—á–∏–ª –ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ, –ø—Ä–∏—à–ª–∞ –∏–Ω—Å–ø–µ–∫—Ü–∏—è, —Å—É–¥, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–¥–µ–ª–∫–∏.

        –í–µ—Ä–Ω–∏ –æ—Ç–≤–µ—Ç –¢–û–õ–¨–ö–û –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON:
        {{
            "priority_score": —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10,
            "pain_stage": "ST-1" | "ST-2" | "ST-3" | "ST-4",
            "justification": "–∫—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É –≤—ã–±—Ä–∞–Ω–∞ —ç—Ç–∞ —Å—Ç–∞–¥–∏—è"
        }}
        """

        try:
            response = await router_ai.generate_response(prompt)
            if response is None or not str(response).strip():
                raise ValueError("Router AI –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç")

            import json
            match = re.search(r"\{.*\}", response, re.DOTALL)
            if not match:
                raise ValueError(f"–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ JSON –≤ –æ—Ç–≤–µ—Ç–µ: {response}")

            data = json.loads(match.group(0))
            data["is_lead"] = data.get("priority_score", 0) >= 5

            # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ –ò–ò –Ω–µ –∑–∞–º–µ—Ç–∏–ª –ñ–ö, –Ω–æ –æ–Ω –µ—Å—Ç—å ‚Äî –ø–æ–≤—ã—à–∞–µ–º
            t_lower = text.lower()
            found_zhk_after = next((zhk for zhk in PRIORITY_ZHK if zhk in t_lower), None)
            if found_zhk_after and not data["is_lead"]:
                has_problem = any(kw in t_lower for kw in ZHK_PROBLEM_KEYWORDS)
                if has_problem:
                    data["priority_score"] = max(data.get("priority_score", 0), 8)
                    data["pain_stage"] = "ST-4"
                    data["is_lead"] = True
                    data["zhk_name"] = found_zhk_after
                    data["justification"] = (
                        data.get("justification", "")
                        + f" [–ü–æ–≤—ã—à–µ–Ω–æ: –æ–±–Ω–∞—Ä—É–∂–µ–Ω –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö '{found_zhk_after}']"
                    )

            logger.info("üéØ –û—Ü–µ–Ω–∫–∞ –ª–∏–¥–∞: %s", data)
            return data

        except Exception as e:
            logger.error("‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞: %s", e)
            # ‚îÄ‚îÄ Fallback: —Ä—É—á–Ω–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            t_lower = text.lower() if text else ""

            # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö + –ø—Ä–æ–±–ª–µ–º–∞ (–ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π —Å–±–æ—è –ò–ò)
            is_zhk_hot_fb, zhk_name_fb = _detect_priority_zhk_hot(text)
            if is_zhk_hot_fb:
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": f"Fallback: –ñ–ö '{zhk_name_fb}' + –ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç",
                    "zhk_name": zhk_name_fb,
                }

            triggers_critical = ["–ø—Ä–µ–¥–ø–∏—Å–∞–Ω–∏–µ", "—Å—É–¥", "–∏–Ω—Å–ø–µ–∫—Ü–∏—è", "–º–∂–∏", "—à—Ç—Ä–∞—Ñ"]
            if any(word in t_lower for word in triggers_critical):
                return {
                    "priority_score": 9,
                    "pain_stage": "ST-4",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            triggers_med = ["–º–æ–∫—Ä–∞—è –∑–æ–Ω–∞", "—É–∑–∞–∫–æ–Ω–∏—Ç—å", "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤", "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏"]
            if any(word in t_lower for word in triggers_med):
                return {
                    "priority_score": 7,
                    "pain_stage": "ST-3",
                    "is_lead": True,
                    "justification": "Fallback: –Ω–∞–π–¥–µ–Ω—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞",
                }

            return {
                "priority_score": 1,
                "pain_stage": "ST-1",
                "is_lead": False,
                "justification": "Fallback: –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
            }
