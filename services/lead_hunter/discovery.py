import logging
import os
from typing import List, Dict

logger = logging.getLogger(__name__)

# =============================================================================
# –†–ê–°–®–ò–†–ï–ù–ù–´–ï –ö–õ–Æ–ß–ï–í–´–ï –°–õ–û–í–ê –î–õ–Ø –ì–õ–û–ë–ê–õ–¨–ù–û–ì–û –ü–û–ò–°–ö–ê
# =============================================================================
# Discovery –∫–æ–º–±–∏–Ω–∏—Ä—É–µ—Ç —ç—Ç–∏ —Å–ª–æ–≤–∞ —Å —Ä–∞–π–æ–Ω–∞–º–∏ –ú–æ—Å–∫–≤—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç–µ–Ω —á–∞—Ç–æ–≤
# –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ú–æ—Å–∫–≤–∞/–ú–û) –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–∑–∂–µ –Ω–∞ —ç—Ç–∞–ø–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤
# =============================================================================

# –û–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã (–∫–æ–º–±–∏–Ω–∏—Ä—É—é—Ç—Å—è —Å —Ä–∞–π–æ–Ω–∞–º–∏)
GENERAL_KEYWORDS = [
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –º–æ—Å–∫–≤–∞",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "–ë–¢–ò –º–æ—Å–∫–≤–∞ —á–∞—Ç",
    "–¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ —á–∞—Ç",
    "—Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä –º—Å–∫",
]

# –ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã (—á–∞—Ç—ã –∂–∏–ª—å—Ü–æ–≤)
GEO_KEYWORDS = [
    "–ñ–ö –ú–æ—Å–∫–≤–∞ —á–∞—Ç",
    "—Å–æ—Å–µ–¥–∏ –ñ–ö",
    "–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –º–æ—Å–∫–≤–∞ –æ–±—Å—É–∂–¥–µ–Ω–∏–µ",
    "—á–∞—Ç –∂–∏–ª—å—Ü–æ–≤",
]

# –†–∞–π–æ–Ω—ã –ú–æ—Å–∫–≤—ã –¥–ª—è –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
MOSCOW_DISTRICTS = [
    "–Æ–í–ê–û", "–Æ–ê–û", "–Æ–ó–ê–û",
    "–°–í–ê–û", "–°–ê–û", "–°–ó–ê–û",
    "–í–ê–û", "–¶–ê–û", "–ó–ê–û",
    "–ù–ê–û", "–¢–ê–û",  # –ù–æ–≤–∞—è –ú–æ—Å–∫–≤–∞
]

# –ë–∞–∑–æ–≤—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ (–±–µ–∑ –∫–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–∏—è)
BASE_KEYWORDS = [
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "—É–∑–∞–∫–æ–Ω–∏—Ç—å –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É",
    "—Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã",
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ú–ñ–ò",
    "–ø—Ä–æ–µ–∫—Ç –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏",
    "–ú–æ—Å–∫–≤–∞",
    "–ú–æ—Å–∫–æ–≤—Å–∫–∞—è –æ–±–ª–∞—Å—Ç—å",
    "–ú–û",
    "–ñ–ö –ú–æ—Å–∫–≤–∞",
    "–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ú–æ—Å–∫–≤—ã",
]

# –ò—Ç–æ–≥–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏)
DEFAULT_KEYWORDS = BASE_KEYWORDS.copy()

# –ü—É–ª –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è ¬´–ì–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞¬ª.
# Discovery –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Ö –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–Ω—É—é —Ç–æ—á–∫—É –¥–ª—è –ø–æ–∏—Å–∫–∞.
# –í–ê–ñ–ù–û: Discovery –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º,
# —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
OPEN_HUNT_SOURCES = [
    # ‚îÄ‚îÄ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/novostroyki_moscow",     "title": "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ú–æ—Å–∫–≤—ã",               "participants_count": 4500},
    {"link": "https://t.me/realtymoscow",           "title": "–†–∏–µ–ª—Ç–æ—Ä—ã –ú–æ—Å–∫–≤—ã",                  "participants_count": 0},
    # ‚îÄ‚îÄ –†–µ–º–æ–Ω—Ç –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ —Ä–∞–±–æ—á–∏–µ) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/pereplanirovka_msk",     "title": "–ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –ú–æ—Å–∫–≤–∞",             "participants_count": 0},
    {"link": "https://t.me/remont_kvartir_moskva",  "title": "–†–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä –ú–æ—Å–∫–≤–∞",             "participants_count": 0},
    {"link": "https://t.me/stroitelstvo_remont",    "title": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ —Ä–µ–º–æ–Ω—Ç",            "participants_count": 0},
]


class Discovery:
    """–ê–≤—Ç–æ–ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ –≥—Ä—É–ø–ø –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

    –°—Ç—Ä–∞—Ç–µ–≥–∏—è ¬´–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫¬ª:
    - –ò—â–µ—Ç –∫–∞–Ω–∞–ª—ã –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞, —Ä–µ–º–æ–Ω—Ç, –ú–æ—Å–∫–≤–∞)
    - –ù–µ –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –ñ–ö
    - –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ú–æ—Å–∫–≤–∞/–ú–û) –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —ç—Ç–∞–ø–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤
    
    –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ—Ä—ë—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ SCOUT_KEYWORDS (env, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
    –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DEFAULT_KEYWORDS.
    """

    def __init__(self):
        """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Discovery —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏.
        
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —Å —Ä–∞–π–æ–Ω–∞–º–∏ –ú–æ—Å–∫–≤—ã –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç–µ–Ω —á–∞—Ç–æ–≤.
        """
        env = os.getenv("SCOUT_KEYWORDS", "").strip()
        if env:
            # –ï—Å–ª–∏ –∑–∞–¥–∞–Ω—ã —á–µ—Ä–µ–∑ env - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
            self.keywords = [k.strip() for k in env.split(",") if k.strip()]
        else:
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏
            self.keywords = self._generate_expanded_keywords()

    def _generate_expanded_keywords(self) -> List[str]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —Å –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏ —Ä–∞–π–æ–Ω–æ–≤."""
        expanded = BASE_KEYWORDS.copy()
        
        # –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –æ–±—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–π–æ–Ω–∞–º–∏
        for keyword in GENERAL_KEYWORDS:
            expanded.append(keyword)
            for district in MOSCOW_DISTRICTS:
                # –î–æ–±–∞–≤–ª—è–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã: "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –º–æ—Å–∫–≤–∞ –Æ–í–ê–û", "–Æ–í–ê–û –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –º–æ—Å–∫–≤–∞"
                expanded.append(f"{keyword} {district}")
                expanded.append(f"{district} {keyword}")
        
        # –ö–æ–º–±–∏–Ω–∏—Ä—É–µ–º –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –∑–∞–ø—Ä–æ—Å—ã —Å —Ä–∞–π–æ–Ω–∞–º–∏
        for keyword in GEO_KEYWORDS:
            expanded.append(keyword)
            for district in MOSCOW_DISTRICTS:
                expanded.append(f"{keyword} {district}")
                expanded.append(f"{district} {keyword}")
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ä–∞–π–æ–Ω–æ–≤ —Å –±–∞–∑–æ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏
        for district in MOSCOW_DISTRICTS:
            expanded.append(f"–ñ–ö {district}")
            expanded.append(f"—á–∞—Ç {district}")
            expanded.append(f"{district} —á–∞—Ç")
            expanded.append(f"—Å–æ—Å–µ–¥–∏ {district}")
        
        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º
        return list(dict.fromkeys(expanded))  # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫, —É–±–∏—Ä–∞–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã

    def get_keywords(self) -> List[str]:
        return self.keywords

    async def find_new_sources(self, keywords: List[str] = None) -> List[Dict]:
        """–ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (–≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫).

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö Telegram-–∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î.
        
        –õ–æ–≥–∏–∫–∞:
          1. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ (—Å –∫–æ–º–±–∏–Ω–∞—Ü–∏—è–º–∏ —Ä–∞–π–æ–Ω–æ–≤).
          2. –§–∏–ª—å—Ç—Ä—É–µ–º OPEN_HUNT_SOURCES –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ title/link.
          3. –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –≥–¥–µ —É–ø–æ–º—è–Ω—É—Ç–∞ –ú–æ—Å–∫–≤–∞/–ú–û –∏–ª–∏ —Ç–µ–º–∞—Ç–∏–∫–∞ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫.
          4. –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –ø—É–ª OPEN_HUNT_SOURCES.
        
        TODO: –í –±—É–¥—É—â–µ–º –¥–æ–±–∞–≤–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ —á–µ—Ä–µ–∑ Telegram API (SearchGlobalRequest)
        –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å–æ—Ç–µ–Ω —á–∞—Ç–æ–≤, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞.
        
        –ì–µ–æ-—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ –ú–æ—Å–∫–≤–∞/–ú–û) –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –ø–æ–∑–∂–µ –Ω–∞ —ç—Ç–∞–ø–µ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤.
        """
        kws = keywords or self.keywords
        
        # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–µ 10 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
        kws_preview = kws[:10]
        if len(kws) > 10:
            logger.info("üîç Discovery: –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º (%d –≤—Å–µ–≥–æ): %s...", 
                       len(kws), kws_preview)
        else:
            logger.info("üîç Discovery: –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: %s", kws_preview)

        # –ì–µ–æ-–º–∞—Ä–∫–µ—Ä—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        geo_markers = ["–º–æ—Å–∫–≤–∞", "–º–æ—Å–∫–æ–≤—Å–∫", "–º—Å–∫", "–º–∫–¥", "–Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏", "—é–≤–∞–æ", "—é–∞–æ", "—é–∑–∞–æ", 
                      "—Å–≤–∞–æ", "—Å–∞–æ", "—Å–∑–∞–æ", "–≤–∞–æ", "—Ü–∞–æ", "–∑–∞–æ", "–Ω–∞–æ", "—Ç–∞–æ"]
        lower_kws = [k.lower() for k in kws]

        found = []
        for s in OPEN_HUNT_SOURCES:
            title_lower = (s.get("title") or "").lower()
            link_lower = (s.get("link") or "").lower()

            # –í–∫–ª—é—á–∞–µ–º, –µ—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º –ò–õ–ò —É–ø–æ–º—è–Ω—É—Ç–∞ –ú–æ—Å–∫–≤–∞/–ú–û/—Ä–∞–π–æ–Ω
            keyword_match = any(k in title_lower or k in link_lower for k in lower_kws)
            geo_match = any(marker in title_lower or marker in link_lower for marker in geo_markers)

            if keyword_match or geo_match:
                found.append(s)

        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –ø—É–ª (—Ä–∞–±–æ—á–∏–µ –∫–∞–Ω–∞–ª—ã)
        result = found if found else OPEN_HUNT_SOURCES
        logger.info("üîç Discovery: –Ω–∞–π–¥–µ–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: %d", len(result))
        return result
