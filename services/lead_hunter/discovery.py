import logging
import os
from typing import List, Dict

logger = logging.getLogger(__name__)

# –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é:
# —Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã + –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ñ–ö (–û—Ç–∫—Ä—ã—Ç–∞—è –æ—Ö–æ—Ç–∞).
DEFAULT_KEYWORDS = [
    # –¢–µ–º–∞—Ç–∏–∫–∞
    "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞",
    "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ",
    "—Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã",
    "–ñ–ö –ú–æ—Å–∫–≤–∞",
    # –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –ñ–ö ‚Äî –∏–º–µ–Ω–Ω–æ –ø–æ –Ω–∏–º –∏—â–µ–º –≥–æ—Ä—è—á–∏—Ö –ª–∏–¥–æ–≤
    "–ó–∏–ª–∞—Ä—Ç",
    "–î–∏–Ω–∞—Å—Ç–∏—è",
    "–°–∏–º–≤–æ–ª",
    "–°–µ—Ä–¥—Ü–µ –°—Ç–æ–ª–∏—Ü—ã",
    "–ü—Ä–µ—Å–Ω—è –°–∏—Ç–∏",
]

# –ü—É–ª –æ—Ç–∫—Ä—ã—Ç—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è ¬´–û—Ç–∫—Ä—ã—Ç–æ–π –æ—Ö–æ—Ç—ã¬ª.
# Discovery –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö –∫–æ–≥–¥–∞ –æ—Å–Ω–æ–≤–Ω–æ–π —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –ø—É—Å—Ç.
OPEN_HUNT_SOURCES = [
    # ‚îÄ‚îÄ –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏ –Ω–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/msk_realty_chat",       "title": "–ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –ú–æ—Å–∫–≤—ã ‚Äî —á–∞—Ç",        "participants_count": 0},
    {"link": "https://t.me/novostroyki_moscow",     "title": "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ú–æ—Å–∫–≤—ã",               "participants_count": 4500},
    {"link": "https://t.me/msk_novostroyki",        "title": "–ù–æ–≤–æ—Å—Ç—Ä–æ–π–∫–∏ –ú–°–ö",                  "participants_count": 0},
    {"link": "https://t.me/realtymoscow",           "title": "–†–∏–µ–ª—Ç–æ—Ä—ã –ú–æ—Å–∫–≤—ã",                  "participants_count": 0},
    {"link": "https://t.me/kvartiry_moskvy",        "title": "–ö–≤–∞—Ä—Ç–∏—Ä—ã –ú–æ—Å–∫–≤—ã ‚Äî –æ–±—Å—É–∂–¥–µ–Ω–∏—è",     "participants_count": 0},
    # ‚îÄ‚îÄ –†–µ–º–æ–Ω—Ç –∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/remont_chats",           "title": "–†–µ–º–æ–Ω—Ç ‚Äî —á–∞—Ç—ã",                    "participants_count": 0},
    {"link": "https://t.me/pereplanirovka_msk",     "title": "–ü–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –ú–æ—Å–∫–≤–∞",             "participants_count": 0},
    {"link": "https://t.me/remont_kvartir_moskva",  "title": "–†–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä –ú–æ—Å–∫–≤–∞",             "participants_count": 0},
    {"link": "https://t.me/stroitelstvo_remont",    "title": "–°—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–æ –∏ —Ä–µ–º–æ–Ω—Ç",            "participants_count": 0},
    # ‚îÄ‚îÄ –î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/interiors_design",       "title": "–î–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤",                "participants_count": 0},
    {"link": "https://t.me/interior_ideas_ru",      "title": "–ò–¥–µ–∏ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞",                   "participants_count": 0},
    {"link": "https://t.me/dizayn_kvartiry",        "title": "–î–∏–∑–∞–π–Ω –∫–≤–∞—Ä—Ç–∏—Ä—ã",                  "participants_count": 0},
    # ‚îÄ‚îÄ –®–∏—Ä–æ–∫–∏–µ —Ñ–æ—Ä—É–º—ã –∂–∏—Ç–µ–ª–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    {"link": "https://t.me/zhiteli_moskvy",         "title": "–ñ–∏—Ç–µ–ª–∏ –ú–æ—Å–∫–≤—ã",                    "participants_count": 0},
    {"link": "https://t.me/msk_chat_official",      "title": "–ú–æ—Å–∫–≤–∞ ‚Äî –æ–±—â–∏–π —á–∞—Ç",               "participants_count": 0},
]


class Discovery:
    """–ê–≤—Ç–æ–ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏ –≥—Ä—É–ø–ø –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞.

    –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–µ—Ä—ë—Ç –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –∏–∑ SCOUT_KEYWORDS (env, —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é).
    –ï—Å–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ –∑–∞–¥–∞–Ω–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è DEFAULT_KEYWORDS, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç
    –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã—Ö –ñ–ö (–ó–∏–ª–∞—Ä—Ç, –î–∏–Ω–∞—Å—Ç–∏—è, –°–∏–º–≤–æ–ª, –°–µ—Ä–¥—Ü–µ –°—Ç–æ–ª–∏—Ü—ã).
    """

    def __init__(self):
        env = os.getenv("SCOUT_KEYWORDS", "").strip()
        if env:
            self.keywords = [k.strip() for k in env.split(",") if k.strip()]
        else:
            self.keywords = DEFAULT_KEYWORDS.copy()

    def get_keywords(self) -> List[str]:
        return self.keywords

    async def find_new_sources(self, keywords: List[str] = None) -> List[Dict]:
        """–ü–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º.

        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –æ—Ç–∫—Ä—ã—Ç—ã—Ö Telegram-–∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –ë–î.
        –õ–æ–≥–∏–∫–∞:
          1. –§–∏–ª—å—Ç—Ä—É–µ–º OPEN_HUNT_SOURCES –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ title/link.
          2. –í—Å–µ–≥–¥–∞ –¥–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –≥–¥–µ –≤ title —É–ø–æ–º—è–Ω—É—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –ñ–ö.
          3. –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤–µ—Å—å –ø—É–ª.
        """
        kws = keywords or self.keywords
        logger.info("üîç Discovery: –ø–æ–∏—Å–∫ –Ω–æ–≤—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º: %s", kws)

        priority_zhk = ["–∑–∏–ª–∞—Ä—Ç", "–¥–∏–Ω–∞—Å—Ç–∏—è", "—Å–∏–º–≤–æ–ª", "—Å–µ—Ä–¥—Ü–µ —Å—Ç–æ–ª–∏—Ü—ã", "–ø—Ä–µ—Å–Ω—è —Å–∏—Ç–∏"]
        lower_kws = [k.lower() for k in kws]

        found = []
        for s in OPEN_HUNT_SOURCES:
            title_lower = (s.get("title") or "").lower()
            link_lower = (s.get("link") or "").lower()

            # –í—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ–≥–æ –ñ–ö
            is_priority = any(zhk in title_lower for zhk in priority_zhk)
            # –ò–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–æ–º
            keyword_match = any(k in title_lower or k in link_lower for k in lower_kws)

            if is_priority or keyword_match:
                found.append(s)

        result = found or OPEN_HUNT_SOURCES
        logger.info("üîç Discovery: –Ω–∞–π–¥–µ–Ω–æ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è: %d", len(result))
        return result
