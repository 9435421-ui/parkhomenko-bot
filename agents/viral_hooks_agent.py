"""
Viral Hooks Agent ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ü–µ–ø–ª—è—é—â–∏—Ö –Ω–∞—á–∞–ª –¥–ª—è –ø–æ—Å—Ç–æ–≤.
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ –∏ –ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–º–µ—â–µ–Ω–∏–π.
"""
import os
import random
import logging
from typing import List, Dict
from utils import router_ai, yandex_gpt

logger = logging.getLogger(__name__)


# –®–∞–±–ª–æ–Ω—ã —Ö—É–∫–æ–≤ –¥–ª—è –Ω–∏—à–∏ "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫"
HOOK_TEMPLATES = {
    "—à—Ç—Ä–∞—Ñ—ã": [
        "üö® {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî –æ–¥–Ω–∞ –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω —à—Ç—Ä–∞—Ñ–æ–≤ –ú–æ—Å–∂–∏–ª–∏–Ω—Å–ø–µ–∫—Ü–∏–∏",
        "‚ö†Ô∏è –ü–æ—á–µ–º—É {–ø—Ä–æ–±–ª–µ–º–∞} –º–æ–∂–µ—Ç —Å—Ç–æ–∏—Ç—å –≤–∞–º {—Å—É–º–º–∞} ‚ÇΩ",
        "üò± 70% —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤ –Ω–µ –∑–Ω–∞—é—Ç –ø—Ä–æ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üõë {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —Å —ç—Ç–∏–º —Å—Ç–∞–ª–∫–∏–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –≤—Ç–æ—Ä–æ–π",
        "‚ùå –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π—Ç–µ {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî –≤–æ—Ç –ø–æ—á–µ–º—É",
        "üí• {–ø—Ä–æ–±–ª–µ–º–∞} –ø—Ä–∏–≤–µ–ª–æ –∫ —à—Ç—Ä–∞—Ñ—É –≤...",
        "‚è∞ –ï—Å–ª–∏ –≤—ã —É–∂–µ —Å–¥–µ–ª–∞–ª–∏ {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —á–∏—Ç–∞–π—Ç–µ —Å—Ä–æ—á–Ω–æ",
        "üî¥ {–ø—Ä–æ–±–ª–µ–º–∞}: —á—Ç–æ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –î–û –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç",
    ],
    "–∑–∞–∫–æ–Ω": [
        "‚úÖ –ö–∞–∫ –º—ã —Ä–µ—à–∏–ª–∏ {–ø—Ä–æ–±–ª–µ–º–∞} –ø–æ –∑–∞–∫–æ–Ω—É –∑–∞ 3 –¥–Ω—è",
        "‚ú® 5 –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Å–ø–æ—Å–æ–±–æ–≤ —É–∑–∞–∫–æ–Ω–∏—Ç—å {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üí° –ü—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ: {–ø—Ä–æ–±–ª–µ–º–∞} –ø–æ –ñ–ö –†–§",
        "üéØ –ù–∞—à–ª–∏ –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–æ–≥–ª–∞—Å–æ–≤–∞—Ç—å {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üöÄ –ö–∞–∫ {–ø—Ä–æ–±–ª–µ–º–∞} –ø—Ä–µ–≤—Ä–∞—Ç–∏–ª–æ—Å—å –≤ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç",
        "‚≠ê –ì–ª–∞–≤–Ω—ã–π —Å–µ–∫—Ä–µ—Ç: {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —ç—Ç–æ –ª–µ–≥–∞–ª—å–Ω–æ",
        "üíé {–ø—Ä–æ–±–ª–µ–º–∞} —Ä–µ—à–∞–µ—Ç—Å—è –≤ 3 —à–∞–≥–∞ ‚Äî —Å–º–æ—Ç—Ä–∏—Ç–µ",
    ],
    "—Ü–∏—Ñ—Ä—ã": [
        "üìä {—Ü–∏—Ñ—Ä–∞}% –ª—é–¥–µ–π —Å–æ–≤–µ—Ä—à–∞—é—Ç —ç—Ç—É –æ—à–∏–±–∫—É –ø—Ä–∏ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üí∞ {–ø—Ä–æ–±–ª–µ–º–∞} –æ–±–æ—à–ª–∞—Å—å –≤ {—Å—É–º–º–∞} ‚ÇΩ ‚Äî –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å",
        "‚è±Ô∏è {–ø—Ä–æ–±–ª–µ–º–∞} –∑–∞ {–≤—Ä–µ–º—è} ‚Äî —Ä–µ–∞–ª—å–Ω—ã–π —Å—Ä–æ–∫ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è",
        "üìà –°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî {—Å—É–º–º–∞} ‚ÇΩ",
        "üî¢ –ü–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ: {—Ñ–∞–∫—Ç} –ø—Ä–∏ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üíØ {–ø—Ä–æ–±–ª–µ–º–∞}: {—Ü–∏—Ñ—Ä–∞} –∏–∑ {—Ü–∏—Ñ—Ä–∞} —Å–ª—É—á–∞–µ–≤ ‚Äî —É—Å–ø–µ—à–Ω–æ",
        "üóìÔ∏è –ó–∞ {–≤—Ä–µ–º—è} –º—ã —Å–æ–≥–ª–∞—Å–æ–≤–∞–ª–∏ {—Ü–∏—Ñ—Ä–∞} –ø—Ä–æ–µ–∫—Ç–æ–≤",
        "üìç {—Å—É–º–º–∞}‚ÇΩ ‚Äî –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç {–ø—Ä–æ–±–ª–µ–º–∞}",
        "‚ö°{—Ü–∏—Ñ—Ä–∞} –¥–Ω–µ–π ‚Äî –∏–º–µ–Ω–Ω–æ —Å—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ –Ω–∞ {–ø—Ä–æ–±–ª–µ–º–∞}",
    ],
    "–∫–µ–π—Å—ã": [
        "üìñ –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ¬´–Ø —Ö–æ—Ç–µ–ª {–ø—Ä–æ–±–ª–µ–º–∞}, –Ω–æ...¬ª",
        "üè† –ö–∞–∫ –æ–¥–∏–Ω –∫–ª–∏–µ–Ω—Ç —É–∑–∞–∫–æ–Ω–∏–ª {–ø—Ä–æ–±–ª–µ–º–∞} –∏ —Ä–∞–∑–±–æ–≥–∞—Ç–µ–ª",
        "üë§ –†–µ–∞–ª—å–Ω—ã–π –æ—Ç–∑—ã–≤: ¬´–°–ø–∞—Å–∏–±–æ –∑–∞ {–ø—Ä–æ–±–ª–µ–º–∞}!¬ª",
        "üó£Ô∏è ¬´–Ø 5 –ª–µ—Ç –Ω–µ –º–æ–≥ —É–∑–∞–∫–æ–Ω–∏—Ç—å {–ø—Ä–æ–±–ª–µ–º–∞} –ø–æ–∫–∞...¬ª",
        "üìã –†–∞–∑–±–∏—Ä–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π —Å–ª—É—á–∞–π: {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üé¨ –î–æ/–ü–æ—Å–ª–µ: {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ {–≤—Ä–µ–º—è}",
        "üë• {—Ü–∏—Ñ—Ä–∞} —Å–µ–º–µ–π —É–∂–µ —É–∑–∞–∫–æ–Ω–∏–ª–∏ {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî –æ—Ç–∑—ã–≤—ã",
        "üèÜ –õ—É—á—à–∏–π –ø—Ä–æ–µ–∫—Ç –º–µ—Å—è—Ü–∞: {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üåü –ò—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—Ö–∞: –æ—Ç {–ø—Ä–æ–±–ª–µ–º–∞} –∫ –æ–¥–æ–±—Ä–µ–Ω–Ω–æ–º—É –ø—Ä–æ–µ–∫—Ç—É",
    ],
    "–≤–æ–ø—Ä–æ—Å—ã": [
        "ü§î –ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —ç—Ç–æ... –ø–æ –ñ–ö –†–§?",
        "‚ùì –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –µ—Å–ª–∏ {–ø—Ä–æ–±–ª–µ–º–∞} —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ?",
        "üí≠ –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å, –∫–∞–∫ {–ø—Ä–æ–±–ª–µ–º–∞} –≤–ª–∏—è–µ—Ç –Ω–∞... –∫–≤–∞—Ä—Ç–∏—Ä—É?",
        "üßê –ü—Ä–∞–≤–¥–∞ –ª–∏, —á—Ç–æ {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —ç—Ç–æ –ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?",
        "ü§® –ü–æ—á–µ–º—É –≤—Å–µ –º–æ–ª—á–∞—Ç –ø—Ä–æ {–ø—Ä–æ–±–ª–µ–º–∞} –≤ –ú–æ—Å–∂–∏–ª–∏–Ω—Å–ø–µ–∫—Ü–∏–∏?",
        "üëÄ –ó–∞–º–µ—á–∞–ª–∏ {–ø—Ä–æ–±–ª–µ–º–∞} —É —Å–æ—Å–µ–¥–µ–π? –í–æ—Ç –ø–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞...",
        "üîç –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç, –µ—Å–ª–∏ –Ω–µ —É–∑–∞–∫–æ–Ω–∏—Ç—å {–ø—Ä–æ–±–ª–µ–º–∞}?",
        "üéØ –£–≥–∞–¥–∞–π—Ç–µ: {–ø—Ä–æ–±–ª–µ–º–∞} ‚Äî —Ç—Ä–µ–±—É–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –∏–ª–∏ –Ω–µ—Ç?",
        "üí° –ó–Ω–∞–µ—Ç–µ –ª–∏ –≤—ã, —á—Ç–æ {–ø—Ä–æ–±–ª–µ–º–∞} –º–æ–∂–Ω–æ... —É–∑–∞–∫–æ–Ω–∏—Ç—å?",
    ],
    "—Ñ–∞–∫—Ç—ã": [
        "üì¢ –ú–∞–ª–æ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–∞–∫—Ç –æ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üîî –í–∞–∂–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ: {–ø—Ä–æ–±–ª–µ–º–∞} –º–µ–Ω—è–µ—Ç –≤—Å—ë",
        "üíé –≠–∫—Å–∫–ª—é–∑–∏–≤: {—Ñ–∞–∫—Ç} –ø—Ä–æ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üß† –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç: {—Ñ–∞–∫—Ç} –ø—Ä–∏ {–ø—Ä–æ–±–ª–µ–º–∞}",
        "üìö –î–æ–∫—É–º–µ–Ω—Ç–∞–ª—å–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ: {—Ñ–∞–∫—Ç}",
        "üèõÔ∏è –ü–æ –∑–∞–∫–æ–Ω—É: {—Ñ–∞–∫—Ç} –ø—Ä–æ {–ø—Ä–æ–±–ª–µ–º–∞}",
    ],
}


class ViralHooksAgent:
    """–ê–≥–µ–Ω—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤–∏—Ä—É—Å–Ω—ã—Ö —Ö—É–∫–æ–≤ –ø–æ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—é –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫"""
    
    def __init__(self):
        self.router_api_key = os.getenv("ROUTER_AI_KEY") or os.getenv("YANDEX_API_KEY")
        self.folder_id = os.getenv("FOLDER_ID")
        self.use_router = bool(self.router_api_key)
    
    async def generate_hooks(
        self,
        topic: str,
        count: int = 5,
        category: str = None
    ) -> List[Dict]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ö—É–∫–∏ –ø–æ —Ç–µ–º–µ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫"""
        hooks = []
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å API ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ò–ò
        if self.use_router:
            ai_hooks = await self._generate_with_ai(topic, count, category)
            hooks.extend(ai_hooks)
        
        # –î–æ–±–∞–≤–ª—è–µ–º —à–∞–±–ª–æ–Ω–Ω—ã–µ —Ö—É–∫–∏
        template_hooks = self._generate_templates(topic, count, category)
        hooks.extend(template_hooks)
        
        # –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
        random.shuffle(hooks)
        
        # –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ —Ç–µ–∫—Å—Ç—É
        seen = set()
        unique_hooks = []
        for hook in hooks:
            text = hook['text'][:50].lower()
            if text not in seen:
                seen.add(text)
                unique_hooks.append(hook)
        
        return unique_hooks[:count]
    
    async def _generate_with_ai(
        self,
        topic: str,
        count: int,
        category: str = None
    ) -> List[Dict]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ö—É–∫–∏ —á–µ—Ä–µ–∑ –ò–ò"""
        try:
            system_prompt = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é —Ü–µ–ø–ª—è—é—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –¥–ª—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–µ—Ç–µ–π –≤ –Ω–∏—à–µ ¬´–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ –∏ –ø–µ—Ä–µ—É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ–º–µ—â–µ–Ω–∏–π¬ª.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–∑–¥–∞–≤–∞—Ç—å ¬´—Ö—É–∫–µ—Ä—ã¬ª (hook) ‚Äî –ø–µ—Ä–≤—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏–≤–ª–µ–∫–∞—é—Ç –≤–Ω–∏–º–∞–Ω–∏–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–æ–≤, –ø–ª–∞–Ω–∏—Ä—É—é—â–∏—Ö –∏–ª–∏ —É–∂–µ —Å–¥–µ–ª–∞–≤—à–∏—Ö –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫—É.

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –¢–æ–Ω: –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —Å–ø–æ–∫–æ–π–Ω—ã–π, —Å –æ–ø–æ—Ä–æ–π –Ω–∞ –∑–∞–∫–æ–Ω (–ñ–ö –†–§, –ú–æ—Å–∂–∏–ª–∏–Ω—Å–ø–µ–∫—Ü–∏—è)
- –≠–º–æ—Ü–∏–∏: –ú—è–≥–∫–æ–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Ä–∏—Å–∫–∞—Ö, —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- –§–æ—Ä–º–∞—Ç: –ü—Ä–æ–±–ª–µ–º–∞ ‚Üí –†–µ—à–µ–Ω–∏–µ –ø–æ –∑–∞–∫–æ–Ω—É
- –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º: –Ω–∞–∑—ã–≤–∞–π —Å—É–º–º—ã —à—Ç—Ä–∞—Ñ–æ–≤, —Å—Ä–æ–∫–∏, —Å—Ç–∞—Ç—å–∏ –∑–∞–∫–æ–Ω–∞
- –ú–∞–∫—Å–∏–º—É–º 15 —Å–ª–æ–≤ –Ω–∞ —Ö—É–∫

–¢–µ–º–∞: –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ –≤ –ú–æ—Å–∫–≤–µ –∏ –†–æ—Å—Å–∏–∏.

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤."""

            user_prompt = f"""–°–æ–∑–¥–∞–π {count} —Ü–µ–ø–ª—è—é—â–∏—Ö —Ö—É–∫–æ–≤ –Ω–∞ —Ç–µ–º—É: {topic}

–¢–µ–º—ã —Ö—É–∫–æ–≤: —à—Ç—Ä–∞—Ñ—ã, –∑–∞–∫–æ–Ω, —Ü–∏—Ñ—Ä—ã, –∫–µ–π—Å—ã, –≤–æ–ø—Ä–æ—Å—ã, —Ñ–∞–∫—Ç—ã
{f'–ò—Å–ø–æ–ª—å–∑—É–π –∫–∞—Ç–µ–≥–æ—Ä–∏—é: {category}' if category else '–ò—Å–ø–æ–ª—å–∑—É–π —Ä–∞–∑–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}

–ü—Ä–∏–º–µ—Ä—ã —Ö–æ—Ä–æ—à–∏—Ö —Ö—É–∫–æ–≤:
- "üö® –°–Ω–æ—Å –Ω–µ—Å—É—â–µ–π —Å—Ç–µ–Ω—ã ‚Äî –æ–¥–Ω–∞ –∏–∑ –≥–ª–∞–≤–Ω—ã—Ö –ø—Ä–∏—á–∏–Ω —à—Ç—Ä–∞—Ñ–æ–≤ –ú–æ—Å–∂–∏–ª–∏–Ω—Å–ø–µ–∫—Ü–∏–∏"
- "üí∞ –ù–µ–∑–∞–∫–æ–Ω–Ω–∞—è –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –æ–±–æ—à–ª–∞—Å—å –≤ 800 000 ‚ÇΩ ‚Äî –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å"
- "üìñ –ò—Å—Ç–æ—Ä–∏—è –∫–ª–∏–µ–Ω—Ç–∞: ¬´–Ø —Ö–æ—Ç–µ–ª –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å –∫—É—Ö–Ω—é, –Ω–æ...¬ª"

–¢–≤–æ–π –æ—Ç–≤–µ—Ç ‚Äî —Ç–æ–ª—å–∫–æ —Ö—É–∫–∏, –ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫–µ, —Å —ç–º–æ–¥–∑–∏."""

            # –°–ù–ê–ß–ê–õ–ê YandexGPT (–≤ –†–§, —Ä–∞–±–æ—Ç–∞–µ—Ç!)
            try:
                response = await yandex_gpt.generate_response(
                    user_prompt=user_prompt,
                    system_prompt=system_prompt,
                    max_tokens=1000
                )
                if response:
                    return self._parse_ai_response(response, topic)
            except Exception as e:
                logger.warning(f"YandexGPT error: {e}")
            
            # Fallback –Ω–∞ Router AI
            if self.use_router:
                try:
                    response = await router_ai.generate_response(
                        user_prompt=user_prompt,
                        system_prompt=system_prompt,
                        max_tokens=1000
                    )
                    if response:
                        return self._parse_ai_response(response, topic)
                except Exception as e:
                    logger.warning(f"Router AI error: {e}")
                
        except Exception as e:
            logger.error(f"AI generation error: {e}")
        
        return []
    
    def _parse_ai_response(self, response: str, topic: str) -> List[Dict]:
        """–ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –ò–ò –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç"""
        hooks = []
        lines = response.strip().split('\n')
        
        for line in lines:
            line = line.strip()
            line = line[line.find('.')+1:].strip() if line and line[0].isdigit() else line
            line = line[line.find(')')+1:].strip() if ')' in line[:5] else line
            
            if line and len(line) > 10:
                hooks.append({
                    'text': line,
                    'topic': topic,
                    'source': 'ai'
                })
        
        return hooks
    
    def _generate_templates(
        self,
        topic: str,
        count: int,
        category: str = None
    ) -> List[Dict]:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ö—É–∫–∏ –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤"""
        hooks = []
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–±–ª–µ–º—É –∏–∑ —Ç–µ–º—ã
        problem = topic.lower()
        if '–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫' in problem:
            problem = '–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞'
        elif '—Ä–µ–º–æ–Ω—Ç' in problem:
            problem = '—Ä–µ–º–æ–Ω—Ç'
        elif '—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏' in problem:
            problem = '—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ'
        elif '–æ–±—ä–µ–¥–∏–Ω–µ–Ω' in problem:
            problem = '–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ–º–µ—â–µ–Ω–∏–π'
        else:
            problem = '—ç—Ç–æ—Ç –≤–æ–ø—Ä–æ—Å'
        
        # –í—ã–±–∏—Ä–∞–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        categories = [category] if category else list(HOOK_TEMPLATES.keys())
        
        for cat in categories:
            if cat in HOOK_TEMPLATES:
                templates = HOOK_TEMPLATES[cat]
                for _ in range(min(2, count)):
                    template = random.choice(templates)
                    
                    hook = template.format(
                        –ø—Ä–æ–±–ª–µ–º–∞=problem,
                        —Å—É–º–º–∞=f"{random.randint(3, 9)}00 000",
                        —Ü–∏—Ñ—Ä–∞=random.randint(3, 99),
                        –≤—Ä–µ–º—è=f"{random.randint(1, 14)} –¥–Ω–µ–π",
                        —Ñ–∞–∫—Ç='—ç—Ç–æ –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å'
                    )
                    
                    hooks.append({
                        'text': hook,
                        'topic': topic,
                        'source': 'template',
                        'category': cat
                    })
        
        return hooks
    
    def get_categories(self) -> List[str]:
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π"""
        return list(HOOK_TEMPLATES.keys())


# Singleton instance
viral_hooks_agent = ViralHooksAgent()


async def generate_hooks_for_topic(topic: str, count: int = 5) -> List[Dict]:
    """–£–¥–æ–±–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ö—É–∫–æ–≤"""
    return await viral_hooks_agent.generate_hooks(topic, count)


if __name__ == "__main__":
    # –¢–µ—Å—Ç –∞–≥–µ–Ω—Ç–∞
    import asyncio
    
    async def test():
        print("üß™ –¢–µ—Å—Ç Viral Hooks Agent (–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫)\n")
        
        topics = [
            "–ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –∫–≤–∞—Ä—Ç–∏—Ä—ã",
            "–æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –∫—É—Ö–Ω–∏ –∏ –≥–æ—Å—Ç–∏–Ω–æ–π",
            "—Å–Ω–æ—Å —Å—Ç–µ–Ω –≤ –∫–≤–∞—Ä—Ç–∏—Ä–µ",
            "–ø–µ—Ä–µ–Ω–æ—Å –º–æ–∫—Ä–æ–π –∑–æ–Ω—ã",
        ]
        
        for topic in topics:
            print(f"üìù –¢–µ–º–∞: {topic}\n")
            hooks = await generate_hooks_for_topic(topic, count=5)
            for i, hook in enumerate(hooks, 1):
                print(f"  {i}. {hook['text']}")
                print(f"     üìå –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {hook.get('category', 'ai')}\n")
            print("-" * 50)
    
    asyncio.run(test())
